import{H as q,r as v,s as S}from"./BSA_tgdP.js";const U=()=>{const o=q(),l=v([]),c=v(!1),n=v(null),w=async()=>{try{const{data:r}=await o.from("empresas").select("id").limit(1).single();return r?.id||null}catch{return null}},p=async()=>{c.value=!0,n.value=null;try{const{data:r,error:e}=await o.from("colaboradores").select(`
          *,
          cargo:cargo_id(id, nome, nivel),
          departamento:departamento_id(id, nome)
        `).order("nome",{ascending:!0});if(e)throw e;return l.value=r,{success:!0,data:r}}catch(r){return n.value=r.message,console.error("Erro ao buscar colaboradores:",r),{success:!1,error:r.message}}finally{c.value=!1}},_=async r=>{c.value=!0,n.value=null;try{const{data:e,error:a}=await o.from("colaboradores").select(`
          *,
          cargo:cargo_id(id, nome, nivel),
          departamento:departamento_id(id, nome)
        `).eq("id",r).single();if(a)throw a;return{success:!0,data:e}}catch(e){return n.value=e.message,{success:!1,error:e.message}}finally{c.value=!1}},y=async r=>{c.value=!0,n.value=null;try{let e=r.empresa_id;e||(e=await w()||void 0);const a=r.criar_usuario,s=r.usuario_email,u=r.usuario_senha,t=r.usuario_role||"funcionario",d=r.usuario_ativo!==!1,f={};for(const[i,g]of Object.entries(r))g!==void 0&&i!=="id"&&(i==="cargo"||i==="departamento"||i==="gestor"||i.startsWith("usuario_")||i==="criar_usuario"||(g===""?f[i]=null:f[i]=g));f.empresa_id=e;const m=await $fetch("/api/colaboradores",{method:"POST",body:{...f,criar_usuario:a,usuario_email:s,usuario_senha:u,usuario_role:t}});if(!m.success)throw new Error(m.error||"Erro ao criar colaborador");const h=m.data;return await p(),{success:!0,data:h}}catch(e){return n.value=e.message,{success:!1,error:e.message}}finally{c.value=!1}},b=async(r,e)=>{c.value=!0,n.value=null;try{const a={};for(const[t,d]of Object.entries(e))d!==void 0&&(t==="cargo"||t==="departamento"||t==="gestor"||(d===""?a[t]=null:a[t]=d));a.updated_at=new Date().toISOString();const{data:s,error:u}=await o.from("colaboradores").update(a).eq("id",r).select().single();if(u)throw u;return await p(),{success:!0,data:s}}catch(a){return n.value=a.message,{success:!1,error:a.message}}finally{c.value=!1}},E=async r=>{try{const e=r.replace(/\D/g,"");if(e.length!==8)return{success:!1,error:"CEP inválido"};const s=await(await fetch(`https://viacep.com.br/ws/${e}/json/`)).json();return s.erro?{success:!1,error:"CEP não encontrado"}:{success:!0,data:{logradouro:s.logradouro,bairro:s.bairro,cidade:s.localidade,estado:s.uf}}}catch(e){return{success:!1,error:e.message}}},C=r=>{let e=[...l.value];if(r.search){const a=r.search.toLowerCase();e=e.filter(s=>s.nome.toLowerCase().includes(a)||s.cpf.includes(r.search)||s.matricula?.includes(r.search)||s.email_corporativo?.toLowerCase().includes(a))}return r.status&&r.status!=="all"&&(e=e.filter(a=>a.status===r.status)),r.cargo_id&&r.cargo_id!=="all"&&(e=e.filter(a=>a.cargo_id===r.cargo_id)),r.departamento_id&&r.departamento_id!=="all"&&(e=e.filter(a=>a.departamento_id===r.departamento_id)),e},D=S(()=>({ativo:l.value.filter(r=>r.status==="Ativo").length,afastado:l.value.filter(r=>r.status==="Afastado").length,desligado:l.value.filter(r=>r.status==="Desligado").length,total:l.value.length}));return{colaboradores:l,loading:c,error:n,countByStatus:D,fetchColaboradores:p,fetchColaboradorById:_,createColaborador:y,updateColaborador:b,filterColaboradores:C,buscarCep:E,fetchDependentes:async r=>{try{const{data:e,error:a}=await o.from("dependentes").select("*").eq("colaborador_id",r).order("nome");if(a)throw a;return{success:!0,data:e}}catch(e){return{success:!1,error:e.message}}},addDependente:async r=>{try{const{data:e,error:a}=await o.from("dependentes").insert(r).select().single();if(a)throw a;return{success:!0,data:e}}catch(e){return{success:!1,error:e.message}}},removeDependente:async r=>{try{const{error:e}=await o.from("dependentes").delete().eq("id",r);if(e)throw e;return{success:!0}}catch(e){return{success:!1,error:e.message}}},fetchDocumentos:async r=>{try{const{data:e,error:a}=await o.from("documentos").select("*").eq("colaborador_id",r).order("created_at",{ascending:!1});if(a)throw a;return{success:!0,data:e}}catch(e){return{success:!1,error:e.message}}},uploadDocumento:async(r,e,a,s)=>{try{const u=`${Date.now()}_${e.name}`,t=`${r}/docs/${u}`,{error:d}=await o.storage.from("colaboradores-docs").upload(t,e);if(d)throw d;const{data:{publicUrl:f}}=o.storage.from("colaboradores-docs").getPublicUrl(t),{data:m,error:h}=await o.from("documentos").insert({colaborador_id:r,tipo:a,nome:e.name,descricao:s,arquivo_url:f,arquivo_tamanho:e.size,arquivo_tipo:e.type}).select().single();if(h)throw h;return{success:!0,data:m}}catch(u){return{success:!1,error:u.message}}},removeDocumento:async r=>{try{const{error:e}=await o.from("documentos").delete().eq("id",r);if(e)throw e;return{success:!0}}catch(e){return{success:!1,error:e.message}}}}};export{U as useColaboradores};
