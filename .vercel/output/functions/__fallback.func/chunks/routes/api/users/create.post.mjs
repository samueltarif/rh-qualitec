import{d as e,r as a,c as o,u as s}from"../../../_/nitro.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"node:crypto";const t=e(async e=>{var t,r,i,n,u,d;try{const d=await a(e),{email:l,password:c,nome:m,role:h,colaborador_id:E}=d,p=null==l?void 0:l.toLowerCase().trim();if(!p||!c||!m)throw o({statusCode:400,message:"Email, senha e nome são obrigatórios"});if(c.length<6)throw o({statusCode:400,message:"Senha deve ter no mínimo 6 caracteres"});if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(p))throw o({statusCode:400,message:"Email inválido"});const g="admin"===h&&"silvana@qualitec.ind.br"===p?"admin":"funcionario",C=s(),v=C.public.supabaseUrl,f=C.supabaseServiceKey;if(!f)throw o({statusCode:500,message:"Service key não configurada"});console.log("[CREATE USER] Iniciando criação para:",p);const R=await $fetch(`${v}/rest/v1/app_users?email=eq.${encodeURIComponent(p)}&select=id,email,auth_uid,ativo`,{headers:{Authorization:`Bearer ${f}`,apikey:f}});if(console.log("[CREATE USER] Usuários existentes em app_users:",R),R&&R.length>0){throw R[0].ativo?o({statusCode:400,message:`Este email (${p}) já está cadastrado no sistema. Verifique a lista de usuários.`}):o({statusCode:400,message:"Este email já existe mas está inativo. Use a opção de reativar usuário na lista."})}let A=null,w=!1;try{const e=await $fetch(`${v}/auth/v1/admin/users`,{headers:{Authorization:`Bearer ${f}`,apikey:f}});if(console.log("[CREATE USER] Total de usuários no Auth:",(null==(t=null==e?void 0:e.users)?void 0:t.length)||0),null==e?void 0:e.users){const a=e.users.find(e=>{var a;return(null==(a=e.email)?void 0:a.toLowerCase())===p});a&&(A=a.id,w=!0,console.log("[CREATE USER] Usuário já existe no Auth com ID:",A))}}catch(e){console.error("[CREATE USER] Erro ao buscar usuários no Auth:",e.message)}if(A){if(w){console.log("[CREATE USER] Atualizando senha do usuário existente no Auth...");try{await $fetch(`${v}/auth/v1/admin/users/${A}`,{method:"PUT",headers:{Authorization:`Bearer ${f}`,"Content-Type":"application/json",apikey:f},body:{password:c,email_confirm:!0,user_metadata:{nome:m}}}),console.log("[CREATE USER] Senha atualizada com sucesso")}catch(e){console.error("[CREATE USER] Erro ao atualizar senha:",e.message)}}}else try{console.log("[CREATE USER] Criando novo usuário no Auth...");A=(await $fetch(`${v}/auth/v1/admin/users`,{method:"POST",headers:{Authorization:`Bearer ${f}`,"Content-Type":"application/json",apikey:f},body:{email:p,password:c,email_confirm:!0,user_metadata:{nome:m}}})).id,console.log("[CREATE USER] Usuário criado no Auth com ID:",A)}catch(e){const a=(null==(r=e.data)?void 0:r.msg)||(null==(i=e.data)?void 0:i.message)||e.message||"";if(console.error("[CREATE USER] Erro ao criar no Auth:",a),!a.includes("already registered")&&!a.includes("already exists"))throw o({statusCode:400,message:a||"Erro ao criar usuário no sistema de autenticação"});try{const e=await $fetch(`${v}/auth/v1/admin/users`,{headers:{Authorization:`Bearer ${f}`,apikey:f}}),a=null==(n=null==e?void 0:e.users)?void 0:n.find(e=>{var a;return(null==(a=e.email)?void 0:a.toLowerCase())===p});a&&(A=a.id,w=!0,console.log("[CREATE USER] Encontrado após retry:",A))}catch{}if(!A)throw o({statusCode:400,message:"Email já existe no sistema de autenticação mas não foi possível vincular. Contate o administrador."})}if(!A)throw o({statusCode:500,message:"Falha ao obter ID do usuário"});const y=await $fetch(`${v}/rest/v1/app_users?auth_uid=eq.${A}&select=id,email`,{headers:{Authorization:`Bearer ${f}`,apikey:f}});if(y&&y.length>0)throw o({statusCode:400,message:`Este usuário de autenticação já está vinculado ao email ${y[0].email}. Contate o administrador.`});console.log("[CREATE USER] Criando registro em app_users...");try{const e=await $fetch(`${v}/rest/v1/app_users`,{method:"POST",headers:{Authorization:`Bearer ${f}`,"Content-Type":"application/json",apikey:f,Prefer:"return=representation"},body:{auth_uid:A,email:p,nome:m.trim(),role:g,colaborador_id:E||null,ativo:!0}});return console.log("[CREATE USER] Usuário criado com sucesso:",e),{success:!0,data:e}}catch(e){const a=(null==(u=e.data)?void 0:u.message)||e.message||"";if(console.error("[CREATE USER] Erro ao criar em app_users:",a),a.includes("duplicate")||a.includes("unique")||a.includes("already exists"))throw o({statusCode:400,message:"Este email ou usuário já existe no sistema. Verifique a lista de usuários."});if(a.includes("chk_admin_email"))throw o({statusCode:400,message:"Apenas silvana@qualitec.ind.br pode ter role de admin."});throw o({statusCode:500,message:a||"Erro ao salvar usuário no banco de dados"})}}catch(e){console.error("[CREATE USER] Erro geral:",e.message||e);const a=e.message||e.statusMessage||(null==(d=e.data)?void 0:d.message)||"Erro ao criar usuário";throw o({statusCode:e.statusCode||500,message:a})}});export{t as default};
