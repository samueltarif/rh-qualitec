import{d as e,r as o,c as a,u as t}from"../../../_/nitro.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"node:crypto";const s=e(async e=>{var s,r,i;try{const n=await o(e),{id:d,nome:u,email:l,password:c,role:m,colaborador_id:p,ativo:h}=n;if(!d)throw a({statusCode:400,message:"ID do usuário é obrigatório"});const f=t(),g=f.public.supabaseUrl,y=f.supabaseServiceKey;if(!y)throw a({statusCode:500,message:"Service key não configurada"});const v=await $fetch(`${g}/rest/v1/app_users?id=eq.${d}&select=*`,{headers:{Authorization:`Bearer ${y}`,apikey:y}});if(!v||0===v.length)throw a({statusCode:404,message:"Usuário não encontrado"});const $=v[0],w=null==l?void 0:l.toLowerCase().trim();let E=m||$.role;if("admin"===E&&"silvana@qualitec.ind.br"!==w&&(E="funcionario"),w&&w!==$.email){const e=await $fetch(`${g}/rest/v1/app_users?email=eq.${encodeURIComponent(w)}&id=neq.${d}&select=id`,{headers:{Authorization:`Bearer ${y}`,apikey:y}});if(e&&e.length>0)throw a({statusCode:400,message:"Este email já está em uso por outro usuário"})}if($.auth_uid){const e={};if(w&&w!==$.email&&(e.email=w),c&&c.length>=6&&(e.password=c),u&&(e.user_metadata={nome:u}),Object.keys(e).length>0)try{await $fetch(`${g}/auth/v1/admin/users/${$.auth_uid}`,{method:"PUT",headers:{Authorization:`Bearer ${y}`,"Content-Type":"application/json",apikey:y},body:e}),console.log("[UPDATE USER] Auth atualizado com sucesso")}catch(e){if(console.error("[UPDATE USER] Erro ao atualizar Auth:",e.message),(null==(s=e.message)?void 0:s.includes("already"))||(null==(i=null==(r=e.data)?void 0:r.message)?void 0:i.includes("already")))throw a({statusCode:400,message:"Este email já existe no sistema de autenticação"})}}const U={updated_at:(new Date).toISOString()};u&&(U.nome=u.trim()),w&&(U.email=w),E&&(U.role=E),"boolean"==typeof h&&(U.ativo=h),void 0!==p&&(U.colaborador_id=p||null);const b=await $fetch(`${g}/rest/v1/app_users?id=eq.${d}`,{method:"PATCH",headers:{Authorization:`Bearer ${y}`,"Content-Type":"application/json",apikey:y,Prefer:"return=representation"},body:U});return console.log("[UPDATE USER] Usuário atualizado:",b),{success:!0,data:(null==b?void 0:b[0])||b}}catch(e){throw console.error("[UPDATE USER] Erro:",e.message||e),a({statusCode:e.statusCode||500,message:e.message||"Erro ao atualizar usuário"})}});export{s as default};
