import{d as e,u as t,c as a}from"../../../_/nitro.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"node:crypto";const o=e(async e=>{try{const e=t(),o=e.public.supabaseUrl,s=e.supabaseServiceKey;if(!s)throw a({statusCode:500,message:"Service key n√£o configurada"});const i={Authorization:`Bearer ${s}`,apikey:s},[r,n,l,d]=await Promise.all([$fetch(`${o}/rest/v1/colaboradores?select=id,nome,status,data_nascimento,data_admissao,data_desligamento,salario,created_at`,{headers:i}),$fetch(`${o}/rest/v1/app_users?select=id,nome,email,role,ativo,ultimo_acesso,created_at`,{headers:i}),$fetch(`${o}/rest/v1/departamentos?select=id,nome,ativo`,{headers:i}),$fetch(`${o}/rest/v1/cargos?select=id,nome,nivel,ativo`,{headers:i})]),m=r||[],c=n||[],g=l||[],u=d||[],h=new Date,p=h.getMonth(),f=(p+1)%12,v=h.getFullYear(),_=m.filter(e=>"Ativo"===e.status),D=m.filter(e=>"Afastado"===e.status),w=m.filter(e=>"Inativo"===e.status||"Desligado"===e.status),b=_.reduce((e,t)=>e+(parseFloat(t.salario)||0),0),$=new Date(v-1,p,h.getDate()),A=m.filter(e=>{if(!e.data_desligamento)return!1;return new Date(e.data_desligamento)>=$}).length,M=(A/(m.length||1)*100).toFixed(1),T=_.filter(e=>{if(!e.data_nascimento)return!1;return new Date(e.data_nascimento+"T00:00:00").getMonth()===p}).map(e=>({id:e.id,nome:e.nome,dia:new Date(e.data_nascimento+"T00:00:00").getDate()})).sort((e,t)=>e.dia-t.dia),S=_.filter(e=>{if(!e.data_nascimento)return!1;return new Date(e.data_nascimento+"T00:00:00").getMonth()===f}).map(e=>({id:e.id,nome:e.nome,dia:new Date(e.data_nascimento+"T00:00:00").getDate()})).sort((e,t)=>e.dia-t.dia),y=c.filter(e=>e.ultimo_acesso).sort((e,t)=>new Date(t.ultimo_acesso).getTime()-new Date(e.ultimo_acesso).getTime()).slice(0,10).map(e=>({id:e.id,nome:e.nome,email:e.email,role:e.role,ultimo_acesso:e.ultimo_acesso})),F=[];_.length>0&&F.push({tipo:"info",mensagem:`${_.length} colaboradores ativos no sistema`}),D.length>0&&F.push({tipo:"warning",mensagem:`${D.length} colaborador(es) afastado(s)`});const x=T.filter(e=>e.dia===h.getDate());x.length>0&&F.push({tipo:"info",mensagem:`üéÇ Hoje √© anivers√°rio de: ${x.map(e=>e.nome).join(", ")}`});const C=m.filter(e=>{if(!e.data_admissao)return!1;const t=new Date(e.data_admissao);return t.getMonth()===p&&t.getFullYear()===v}).length;return C>0&&F.push({tipo:"info",mensagem:`${C} novo(s) colaborador(es) admitido(s) este m√™s`}),{success:!0,data:{totalUsuarios:c.length,usuariosAtivos:c.filter(e=>e.ativo).length,totalColaboradores:m.length,colaboradoresAtivos:_.length,colaboradoresAfastados:D.length,colaboradoresInativos:w.length,totalDepartamentos:g.filter(e=>e.ativo).length,totalCargos:u.filter(e=>e.ativo).length,custoFolhaMensal:b,taxaRotatividade:parseFloat(M),novosNoMes:C,aniversariantesMes:T,aniversariantesProximoMes:S,ultimasAtividades:y,alertas:F,mesAtualNome:new Date(v,p).toLocaleDateString("pt-BR",{month:"long"}),proximoMesNome:new Date(v,f).toLocaleDateString("pt-BR",{month:"long"})}}}catch(e){throw console.error("[DASHBOARD STATS] Erro:",e.message||e),a({statusCode:e.statusCode||500,message:e.message||"Erro ao buscar estat√≠sticas"})}});export{o as default};
