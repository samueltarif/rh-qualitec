import{d as a,r as o,c as e}from"../../../_/nitro.mjs";import{s as r}from"../../../_/serverSupabaseClient.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"node:crypto";import"@supabase/ssr";import"../../../_/fetch-retry.mjs";const t=a(async a=>{try{const t=await o(a),{colaboradores_ids:s,parcela:i,ano:l}=t;if(!s||!Array.isArray(s)||0===s.length)throw e({statusCode:400,message:"IDs dos colaboradores são obrigatórios"});const n=await r(a);let c=0,d=0,m=0;const u=[];for(const a of s)try{const{data:o,error:e}=await n.from("colaboradores").select("*").eq("id",a).single();if(e||!o)throw new Error(`Colaborador ${a} não encontrado`);const r=o.email_corporativo||o.email_pessoal||null;r||console.warn(`⚠️ Colaborador ${o.nome} não possui email cadastrado - gerando holerite sem envio`);const t=parseFloat(o.salario_base)||0,s=calcularMesesTrabalhados(o.data_admissao,l),m=t/12*s;let u=0,p=0,_=0;if("1"===i)u=m/2;else if("2"===i){const a=m;p=calcularINSS(a),_=calcularIRRF(a,p,o.dependentes||0);u=a-a/2-p-_}else u=m,p=calcularINSS(u),_=calcularIRRF(u,p,o.dependentes||0),u=u-p-_;const f=.08*m,{data:g}=await n.from("holerites").select("id").eq("colaborador_id",a).eq("tipo","decimo_terceiro").eq("ano",l).eq("parcela_13",i),h=g&&g.length>0?g[0]:null;let b;if(h){const{error:a}=await n.from("holerites").update({nome_colaborador:o.nome,cpf:o.cpf,cargo:o.cargo||"",departamento:o.departamento||"",salario_base:t,salario_bruto:m,total_proventos:m,inss:p,irrf:_,total_descontos:p+_,salario_liquido:u,fgts:f,meses_trabalhados:s,data_admissao:o.data_admissao||null,observacoes:`13º Salário - ${"1"===i?"1ª Parcela":"2"===i?"2ª Parcela":"Parcela Integral"} - ${l}`,updated_at:(new Date).toISOString()}).eq("id",h.id);if(a)throw a;b=h.id}else{const{data:e,error:r}=await n.from("holerites").insert({colaborador_id:a,mes:12,ano:l,tipo:"decimo_terceiro",parcela_13:i,nome_colaborador:o.nome,cpf:o.cpf,cargo:o.cargo||"",departamento:o.departamento||"",salario_base:t,salario_bruto:m,total_proventos:m,inss:p,irrf:_,total_descontos:p+_,salario_liquido:u,fgts:f,meses_trabalhados:s,data_admissao:o.data_admissao||null,observacoes:`13º Salário - ${"1"===i?"1ª Parcela":"2"===i?"2ª Parcela":"Parcela Integral"} - ${l}`,created_at:(new Date).toISOString()}).select().single();if(r||!e)throw r;b=e.id}if(c++,r)try{const a="1"===i?"1ª Parcela":"2"===i?"2ª Parcela":"Parcela Integral",{data:e}=await n.from("config_email_smtp").select("*").single();if(e&&e.email_remetente){const t=await import("../../../_/email-service.mjs"),s=new(0,t.EmailService);await s.initialize({servidor_smtp:e.servidor_smtp,porta:e.porta,usuario_smtp:e.usuario_smtp,senha_smtp:e.senha_smtp,email_remetente:e.email_remetente,nome_remetente:e.nome_remetente||"RH",usa_ssl:e.usa_ssl||!1,usa_tls:e.usa_tls||!0});const i=`\n                <h2>13º Salário - ${a}</h2>\n                <p>Olá ${o.nome},</p>\n                <p>Seu holerite de 13º salário está disponível.</p>\n                <h3>Detalhes:</h3>\n                <ul>\n                  <li><strong>Parcela:</strong> ${a}</li>\n                  <li><strong>Ano:</strong> ${l}</li>\n                  <li><strong>Valor Líquido:</strong> R$ ${u.toFixed(2)}</li>\n                </ul>\n                <p>Acesse o sistema para visualizar o holerite completo.</p>\n              `;await s.sendEmail({destinatario:r,assunto:`13º Salário - ${a} - ${l}`,corpo_html:i,corpo_texto:`13º Salário - ${a} - ${l}\nValor: R$ ${u.toFixed(2)}`}),console.log(`✅ Email enviado para ${r}`),d++}else console.log("⚠️ Configuração de email não encontrada")}catch(a){console.error(`❌ Erro ao enviar email para ${r}:`,a)}else console.log(`⚠️ Email não enviado - colaborador ${o.nome} sem email cadastrado`)}catch(o){console.error(`Erro ao processar colaborador ${a}:`,o),m++,u.push({colaborador_id:a,erro:o.message})}return{success:!0,data:{total_gerados:c,total_enviados:d,total_erros:m,erros:m>0?u:void 0}}}catch(a){throw console.error("Erro ao gerar e enviar 13º salário:",a),e({statusCode:a.statusCode||500,message:a.message||"Erro ao gerar e enviar 13º salário"})}});function calcularMesesTrabalhados(a,o){const e=new Date(a+"T00:00:00"),r=e.getFullYear(),t=e.getMonth()+1,s=e.getDate();return r>o?0:r<o?12:s<=15?12-t+1:12-t}function calcularINSS(a){const o=[{limite:1412,aliquota:.075},{limite:2666.68,aliquota:.09},{limite:4000.03,aliquota:.12},{limite:7786.02,aliquota:.14}];let e=0,r=a;for(let a=0;a<o.length;a++){const t=a>0?o[a-1].limite:0,s=o[a].limite,i=Math.min(r,s-t);if(i>0&&(e+=i*o[a].aliquota,r-=i),r<=0)break}return Math.min(e,908.85)}function calcularIRRF(a,o,e){const r=a-o-189.59*e;if(r<=2259.2)return 0;const t=[{limite:2259.2,aliquota:0,deducao:0},{limite:2826.65,aliquota:.075,deducao:169.44},{limite:3751.05,aliquota:.15,deducao:381.44},{limite:4664.68,aliquota:.225,deducao:662.77},{limite:1/0,aliquota:.275,deducao:896}];for(const a of t)if(r<=a.limite)return Math.max(0,r*a.aliquota-a.deducao);return 0}export{t as default};
