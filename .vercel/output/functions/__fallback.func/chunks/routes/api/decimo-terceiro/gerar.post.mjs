import{d as o,r as a,c as e}from"../../../_/nitro.mjs";import{c as r}from"../../../_/irrf-lei-15270-2025.mjs";import{s as l}from"../../../_/serverSupabaseClient.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"node:crypto";import"@supabase/ssr";import"../../../_/fetch-retry.mjs";const t=o(async o=>{var r,t,s,n,c,i,d,m,g,u;const p=Date.now();try{const b=await a(o).catch(()=>{throw e({statusCode:400,message:"Corpo da requisi√ß√£o inv√°lido"})}),{colaboradores_ids:_,parcela:f,ano:$}=b;if(!_||!Array.isArray(_)||0===_.length)throw e({statusCode:400,message:"IDs dos colaboradores s√£o obrigat√≥rios"});if(!f||!["1","2","integral","completo"].includes(f))throw e({statusCode:400,message:"Parcela inv√°lida. Valores aceitos: 1, 2, integral, completo"});const S=parseInt($);if(!S||S<2020||S>2100)throw e({statusCode:400,message:"Ano inv√°lido. Deve ser entre 2020 e 2100."});console.log(`üéÑ [13¬∫ SAL√ÅRIO] Iniciando gera√ß√£o - Parcela: ${f}, Ano: ${$}, Colaboradores: ${_.length}`);const h=await l(o),{data:{user:R},error:A}=await h.auth.getUser();if(A||!R)throw console.error("[13¬∫ SAL√ÅRIO] Erro de autentica√ß√£o:",A),e({statusCode:401,message:"N√£o autenticado"});let I=0,v=0;const w=[];for(const o of _)try{const{data:a,error:e}=await h.from("colaboradores").select("\n            *,\n            cargo:cargos(nome),\n            departamento:departamentos!colaboradores_departamento_id_fkey(nome)\n          ").eq("id",o).eq("status","Ativo").single();if(e||!a)throw console.error(`Erro ao buscar colaborador ${o}:`,e),new Error(`Colaborador ${o} n√£o encontrado ou inativo`);const l=parseFloat(a.salario||0),p=calcularMesesTrabalhados(a.data_admissao,$),b=l/12*p;console.log(`\n${"=".repeat(60)}`),console.log(`üéØ COLABORADOR: ${a.nome}`),console.log(`üéØ Parcela selecionada: "${f}"`),console.log(`${"=".repeat(60)}`);let _=[];"completo"===f?(console.log("‚úÖ Modo COMPLETO: Gerando 1¬™ + 2¬™ + mensal"),_=["1","2"]):"1"===f?(console.log("‚úÖ Modo 1¬™ PARCELA: Gerando APENAS 1¬™ parcela"),_=["1"]):"2"===f?(console.log("‚úÖ Modo 2¬™ PARCELA: Gerando APENAS 2¬™ parcela"),_=["2"]):"integral"===f&&(console.log("‚úÖ Modo INTEGRAL: Gerando APENAS integral"),_=["integral"]),console.log(`üìã Parcelas a gerar: ${_.join(", ")}`);for(const e of _){let i=0,d=0,m=0,g=0,u=12;if(console.log(`\nüìå Processando parcela: ${e}`),"1"===e)i=b/2,g=i,u=11,console.log(`   üìÖ M√™s: Novembro (${u})`),console.log(`   üí∞ Valor: R$ ${i.toFixed(2)} (50% sem descontos)`);else if("2"===e){const o=b,e=o/2,r=l+o;d=calcularINSS(o),m=calcularIRRF(o,d,a.dependentes||0,r);const t=o-e;g=t,i=t-d-m,u=12,console.log(`   üìÖ M√™s: Dezembro (${u})`),console.log(`   üí∞ 13¬∫ Total: R$ ${o.toFixed(2)}`),console.log(`   üí∞ 1¬™ Parcela (j√° paga): R$ ${e.toFixed(2)}`),console.log(`   üí∞ Valor restante (2¬™ parcela): R$ ${t.toFixed(2)}`),console.log(`   üí≥ INSS (sobre total): R$ ${d.toFixed(2)}`),console.log(`   üí≥ IRRF (sobre total): R$ ${m.toFixed(2)}`),console.log(`   üí∞ Valor l√≠quido: R$ ${i.toFixed(2)}`)}else{g=b;const o=l+b;d=calcularINSS(b),m=calcularIRRF(b,d,a.dependentes||0,o),i=b-d-m,u=12,console.log(`   üìÖ M√™s: Dezembro (${u})`),console.log(`   üí∞ Valor bruto: R$ ${g.toFixed(2)}`),console.log(`   üí≥ INSS: R$ ${d.toFixed(2)}`),console.log(`   üí≥ IRRF: R$ ${m.toFixed(2)}`),console.log(`   üí∞ Valor l√≠quido: R$ ${i.toFixed(2)}`)}const _=.08*b,f={colaborador_id:o,mes:u,ano:$,tipo:"decimo_terceiro",parcela_13:e,nome_colaborador:a.nome,cpf:a.cpf,cargo:(null==(r=a.cargo)?void 0:r.nome)||"N√£o informado",departamento:(null==(t=a.departamento)?void 0:t.nome)||"N√£o informado",salario_base:l,salario_bruto:b,total_proventos:g,inss:d,irrf:m,total_descontos:d+m,salario_liquido:i,fgts:_,banco:(null==(s=a.dados_bancarios)?void 0:s.banco)||null,agencia:(null==(n=a.dados_bancarios)?void 0:n.agencia)||null,conta:(null==(c=a.dados_bancarios)?void 0:c.conta)||null,meses_trabalhados:p,data_admissao:a.data_admissao||null,observacoes:`13¬∫ Sal√°rio - ${"1"===e?"1¬™ Parcela (Adiantamento)":"2"===e?"2¬™ Parcela (Com Descontos)":"Parcela Integral"} - ${$}\n${p} ${1===p?"M√™s Trabalhado":"Meses Trabalhados"}`,status:"gerado"},{data:S}=await h.from("holerites").select("id").eq("colaborador_id",o).eq("mes",u).eq("ano",$).eq("tipo","decimo_terceiro").eq("parcela_13",e).maybeSingle();if(S){const{error:o}=await h.from("holerites").update({nome_colaborador:f.nome_colaborador,cpf:f.cpf,cargo:f.cargo,departamento:f.departamento,salario_base:f.salario_base,salario_bruto:f.salario_bruto,total_proventos:f.total_proventos,inss:f.inss,irrf:f.irrf,total_descontos:f.total_descontos,salario_liquido:f.salario_liquido,fgts:f.fgts,banco:f.banco,agencia:f.agencia,conta:f.conta,meses_trabalhados:f.meses_trabalhados,observacoes:f.observacoes,updated_at:(new Date).toISOString()}).eq("id",S.id);if(o)throw console.error(`Erro ao atualizar holerite ${S.id}:`,o),o;console.log(`   ‚úÖ Holerite ATUALIZADO (${e})`)}else{const{error:a}=await h.from("holerites").insert({...f,created_at:(new Date).toISOString()});if(a)throw console.error(`Erro ao inserir holerite para colaborador ${o}:`,a),a;console.log(`   ‚úÖ Holerite CRIADO (${e})`)}I++}if("completo"===f){console.log("\nüìå Processando parcela: MENSAL (Sal√°rio Normal de Dezembro)");const e={colaborador_id:o,mes:12,ano:$,tipo:"mensal",parcela_13:null,nome_colaborador:a.nome,cpf:a.cpf,cargo:(null==(i=a.cargo)?void 0:i.nome)||"N√£o informado",departamento:(null==(d=a.departamento)?void 0:d.nome)||"N√£o informado",salario_base:l,salario_bruto:l,total_proventos:l,inss:calcularINSS(l),irrf:calcularIRRF(l,calcularINSS(l),a.dependentes||0),total_descontos:calcularINSS(l)+calcularIRRF(l,calcularINSS(l),a.dependentes||0),salario_liquido:l-calcularINSS(l)-calcularIRRF(l,calcularINSS(l),a.dependentes||0),fgts:.08*l,banco:(null==(m=a.dados_bancarios)?void 0:m.banco)||null,agencia:(null==(g=a.dados_bancarios)?void 0:g.agencia)||null,conta:(null==(u=a.dados_bancarios)?void 0:u.conta)||null,data_admissao:a.data_admissao||null,observacoes:`Sal√°rio Mensal - Dezembro/${$}`,status:"gerado"},{data:r}=await h.from("holerites").select("id").eq("colaborador_id",o).eq("mes",12).eq("ano",$).eq("tipo","mensal").maybeSingle();if(r){const{error:a}=await h.from("holerites").update({nome_colaborador:e.nome_colaborador,cpf:e.cpf,cargo:e.cargo,departamento:e.departamento,salario_base:e.salario_base,salario_bruto:e.salario_bruto,total_proventos:e.total_proventos,inss:e.inss,irrf:e.irrf,total_descontos:e.total_descontos,salario_liquido:e.salario_liquido,fgts:e.fgts,banco:e.banco,agencia:e.agencia,conta:e.conta,observacoes:e.observacoes,updated_at:(new Date).toISOString()}).eq("id",r.id);a?console.error(`Erro ao atualizar holerite mensal para colaborador ${o}:`,a):(console.log("   ‚úÖ Holerite ATUALIZADO (MENSAL)"),I++)}else{const{error:a}=await h.from("holerites").insert({...e,created_at:(new Date).toISOString()});a?console.error(`Erro ao inserir holerite mensal para colaborador ${o}:`,a):(console.log("   ‚úÖ Holerite CRIADO (MENSAL)"),I++)}}}catch(a){console.error(`Erro ao gerar 13¬∫ para colaborador ${o}:`,a),v++,w.push({colaborador_id:o,erro:a.message})}console.log(`\n${"=".repeat(60)}`),console.log("üìä RESUMO FINAL DA GERA√á√ÉO"),console.log(`${"=".repeat(60)}`),console.log(`‚úÖ Total de holerites gerados: ${I}`),console.log(`‚ùå Total de erros: ${v}`),v>0&&(console.log("\n‚ö†Ô∏è Erros encontrados:"),w.forEach(o=>console.log(`   - Colaborador ${o.colaborador_id}: ${o.erro}`))),console.log(`${"=".repeat(60)}\n`);const q=Date.now()-p;return console.log(`‚úÖ [13¬∫ SAL√ÅRIO] Conclu√≠do em ${q}ms - ${I} gerados, ${v} erros`),{success:!0,data:{total_gerados:I,total_erros:v,erros:v>0?w:void 0}}}catch(o){const a=Date.now()-p;if(console.error(`‚ùå [13¬∫ SAL√ÅRIO] Erro ap√≥s ${a}ms:`,o.message||o),o.statusCode)throw o;throw e({statusCode:500,message:o.message||"Erro ao gerar 13¬∫ sal√°rio"})}});function calcularMesesTrabalhados(o,a){const e=new Date(o+"T00:00:00"),r=e.getFullYear(),l=e.getMonth()+1,t=e.getDate();return r>a?0:r<a?12:t<=15?12-l+1:12-l}function calcularINSS(o){const a=[{limite:1412,aliquota:.075},{limite:2666.68,aliquota:.09},{limite:4000.03,aliquota:.12},{limite:7786.02,aliquota:.14}];let e=0,r=o;for(let o=0;o<a.length;o++){const l=o>0?a[o-1].limite:0,t=a[o].limite,s=Math.min(r,t-l);if(s>0&&(e+=s*a[o].aliquota,r-=s),r<=0)break}return Math.round(100*Math.min(e,908.85))/100}function calcularIRRF(o,a,e,l){return r(o,a,e,null!=l?l:o).valor}export{t as default};
