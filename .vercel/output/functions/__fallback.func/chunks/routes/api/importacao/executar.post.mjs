import{d as o,c as t,h as s}from"../../../_/nitro.mjs";import{s as a}from"../../../_/serverSupabaseUser.mjs";import{s as e}from"../../../_/serverSupabaseClient.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"node:crypto";import"@supabase/ssr";import"../../../_/fetch-retry.mjs";const r=o(async o=>{var r,i;try{const n=await a(o);if(!n)throw t({statusCode:401,message:"Não autenticado"});const m=await e(o),d=await s(o);if(!d)throw t({statusCode:400,message:"Nenhum arquivo enviado"});const p=d.find(o=>"arquivo"===o.name),c=null==(r=d.find(o=>"tipoEntidade"===o.name))?void 0:r.data.toString();if(!p||!c)throw t({statusCode:400,message:"Dados incompletos"});const{data:u,error:f}=await m.from("historico_importacoes").insert({tipo_entidade:c,arquivo_nome:p.filename||"arquivo",arquivo_tamanho:p.data.length,formato:(null==(i=p.filename)?void 0:i.split(".").pop())||"csv",status:"processando",usuario_id:n.id,total_registros:0,registros_sucesso:0,registros_erro:0}).select().single();if(f)throw f;return await m.from("historico_importacoes").update({status:"concluido",completed_at:(new Date).toISOString()}).eq("id",u.id),{success:!0,message:"Importação iniciada com sucesso",data:u}}catch(o){throw console.error("Erro na importação:",o),t({statusCode:o.statusCode||500,message:o.message||"Erro ao processar importação"})}});export{r as default};
