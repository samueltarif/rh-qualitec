import{d as a,c as o,r as t,b as e}from"../../../../_/nitro.mjs";import{s as r}from"../../../../_/serverSupabaseClient.mjs";import{s}from"../../../../_/serverSupabaseUser.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"node:crypto";import"@supabase/ssr";import"../../../../_/fetch-retry.mjs";const i=a(async a=>{try{const i=await r(a),n=await s(a);if(!n)throw o({statusCode:401,message:"N√£o autenticado"});const d=await t(a),{mes:l,ano:c,assinaturaDigital:u,observacoes:m}=d;if(!l||!c||!u)throw o({statusCode:400,message:"M√™s, ano e assinatura s√£o obrigat√≥rios"});const p=n.sub||n.id;let _=null;console.log(`üîç Buscando colaborador para user: ${n.email} (ID: ${p})`);try{const{data:a}=await i.from("colaboradores").select("id, nome, email_corporativo, auth_uid").eq("auth_uid",p).single();a&&(_=a,console.log(`‚úÖ Colaborador encontrado por auth_uid: ${_.nome}`))}catch(a){console.log(`‚ö†Ô∏è N√£o encontrado por auth_uid: ${p}`)}if(!_&&n.email)try{const{data:a}=await i.from("colaboradores").select("id, nome, email_corporativo, auth_uid").eq("email_corporativo",n.email).single();a&&(_=a,console.log(`‚úÖ Colaborador encontrado por email: ${_.nome}`),_.auth_uid||(await i.from("colaboradores").update({auth_uid:p}).eq("id",_.id),console.log(`üîÑ Auth_uid atualizado para colaborador: ${_.nome}`)))}catch(a){console.log(`‚ö†Ô∏è N√£o encontrado por email: ${n.email}`)}if(!_)try{const{data:a}=await i.from("app_users").select("id, nome, email").eq("auth_uid",p).single();if(a){console.log(`‚úÖ Colaborador encontrado por app_users: ${a.nome}`);const{data:o}=await i.from("colaboradores").select("id, nome, email_corporativo, auth_uid").or(`nome.ilike.%${a.nome}%,email_corporativo.eq.${a.email}`).single();o&&(_=o,_.auth_uid||(await i.from("colaboradores").update({auth_uid:p}).eq("id",_.id),console.log(`üîÑ Auth_uid vinculado para colaborador: ${_.nome}`)))}}catch(a){console.log("‚ö†Ô∏è Erro ao buscar via app_users:",a)}if(!_)throw console.error(`‚ùå COLABORADOR N√ÉO ENCONTRADO - User: ${n.email}, ID: ${p}`),o({statusCode:404,message:"Colaborador n√£o encontrado. Entre em contato com o administrador."});const g=new Date(c,l-1,1).toISOString().split("T")[0],h=new Date(c,l,0).toISOString().split("T")[0],{data:f}=await i.from("registros_ponto").select("*").eq("colaborador_id",_.id).gte("data",g).lte("data",h).order("data",{ascending:!0});let $=0,S=0;f&&f.length>0&&f.forEach(a=>{const o=a.entrada_1,t=a.saida_2||a.saida_1;if(o&&t){const e=new Date(`${a.data}T${o}`);let r=new Date(`${a.data}T${t}`).getTime()-e.getTime();if(a.saida_1&&a.entrada_2&&a.saida_2){const o=new Date(`${a.data}T${a.saida_1}`);r-=new Date(`${a.data}T${a.entrada_2}`).getTime()-o.getTime()}if(r>0){const a=Math.floor(r/6e4);a>=60&&($++,S+=a)}}});const w=Math.floor(S/60),b=`${w}h${Math.floor(S%60).toString().padStart(2,"0")}`,D=(new Date).toLocaleString("pt-BR",{timeZone:"America/Sao_Paulo"});console.log("üîç [CSV] Gerando CSV para",(null==f?void 0:f.length)||0,"registros");const T=[];T.push("REGISTRO DE PONTO ELETR√îNICO"),T.push(`Colaborador: ${_.nome}`),T.push(`Per√≠odo: ${l.toString().padStart(2,"0")}/${c}`),T.push(`Data de Assinatura: ${D}`),T.push(""),T.push("Data;Entrada 1;Sa√≠da 1;Entrada 2;Sa√≠da 2;Total Horas"),f&&f.length>0?(console.log("üìä [CSV] Processando registros:"),f.forEach(a=>{console.log(`  - ${a.data}: ${a.entrada_1} - ${a.saida_2||a.saida_1}`);let o="0h00";if(a.entrada_1){const t=a.saida_2||a.saida_1;if(t){const e=new Date(`${a.data}T${a.entrada_1}`);let r=new Date(`${a.data}T${t}`).getTime()-e.getTime();if(a.saida_1&&a.entrada_2&&a.saida_2){const o=new Date(`${a.data}T${a.saida_1}`);r-=new Date(`${a.data}T${a.entrada_2}`).getTime()-o.getTime()}if(r>0){const a=Math.floor(r/6e4);o=`${Math.floor(a/60)}h${(a%60).toString().padStart(2,"0")}`}}else o="Em andamento"}const t=new Date(a.data),e=`${["Dom","Seg","Ter","Qua","Qui","Sex","S√°b"][t.getDay()]}, ${t.getDate().toString().padStart(2,"0")}/${(t.getMonth()+1).toString().padStart(2,"0")}`;T.push([e,a.entrada_1||"-",a.saida_1||"-",a.entrada_2||"-",a.saida_2||"-",o].join(";"))})):console.log("‚ö†Ô∏è [CSV] Nenhum registro encontrado para o per√≠odo"),T.push(""),T.push("RESUMO"),T.push(`Dias Trabalhados: ${$}`),T.push(`Total de Horas: ${b}`),T.push(""),T.push("DECLARA√á√ÉO"),T.push("Declaro que os registros acima est√£o corretos e conferidos."),T.push(`Assinado digitalmente em ${D}`);const v=T.join("\n"),C=Buffer.from(v,"utf-8").toString("base64"),E=e(a,"x-forwarded-for")||e(a,"x-real-ip")||"N√£o identificado",O=`${_.id}-${l}-${c}-${Date.now()}`,A=Buffer.from(O).toString("base64").substring(0,64),{data:N,error:q}=await i.from("assinaturas_ponto").upsert({colaborador_id:_.id,mes:parseInt(l),ano:parseInt(c),assinatura_digital:u,hash_assinatura:A,arquivo_csv:C,total_dias:$,total_horas:b,observacoes:m||null,ip_assinatura:E,data_assinatura:(new Date).toISOString()},{onConflict:"colaborador_id,mes,ano"}).select().single();if(q)throw console.error("Erro ao salvar assinatura:",q),o({statusCode:500,message:"Erro ao salvar assinatura: "+q.message});return{success:!0,message:"Assinatura salva com sucesso!",assinatura:{id:null==N?void 0:N.id,data_assinatura:null==N?void 0:N.data_assinatura,total_dias:null==N?void 0:N.total_dias,total_horas:null==N?void 0:N.total_horas}}}catch(a){if(console.error("Erro ao processar assinatura:",a),a.statusCode)throw a;throw o({statusCode:500,message:"Erro interno do servidor"})}});export{i as default};
