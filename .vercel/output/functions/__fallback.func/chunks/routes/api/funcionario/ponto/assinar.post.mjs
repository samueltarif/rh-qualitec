import{d as a,c as o,r as s,e as t}from"../../../../_/nitro.mjs";import{s as r}from"../../../../_/serverSupabaseClient.mjs";import{s as e}from"../../../../_/serverSupabaseUser.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"node:crypto";import"@supabase/ssr";import"../../../../_/fetch-retry.mjs";const n=a(async a=>{const n=await r(a),i=await e(a);if(!i)throw o({statusCode:401,message:"Não autenticado"});const d=await s(a),{mes:p,ano:u,registros:l,resumo:m}=d;if(!(p&&u&&l&&m))throw o({statusCode:400,message:"Dados incompletos"});const{data:c}=await n.from("colaboradores").select("id, nome").eq("auth_uid",i.id).single();if(!c)throw o({statusCode:404,message:"Colaborador não encontrado"});const{data:h}=await n.from("assinaturas_ponto").select("id").eq("colaborador_id",c.id).eq("mes",p).eq("ano",u).single();if(h)throw o({statusCode:400,message:"Ponto já foi assinado para este período"});const f=function(a,o,s,t,r){const e=[],n=(new Date).toLocaleString("pt-BR",{timeZone:"America/Sao_Paulo"});return e.push("REGISTRO DE PONTO ELETRÔNICO"),e.push(`Colaborador: ${o}`),e.push(`Período: ${s.toString().padStart(2,"0")}/${t}`),e.push(`Data de Assinatura: ${n}`),e.push(""),e.push("RESUMO DO PERÍODO"),e.push(`Dias Trabalhados: ${r.diasTrabalhados}`),e.push(`Horas Trabalhadas: ${r.horasTrabalhadas}`),e.push(`Horas de Intervalo: ${r.horasIntervalo}`),e.push(`Horas Extras: ${r.horasExtras}`),e.push(`Faltas: ${r.faltas}`),e.push(""),e.push("Data;Dia da Semana;Entrada;Saída Intervalo;Entrada Intervalo;Saída;Total Horas;Status"),a.forEach(a=>{const o=new Date(a.data+"T00:00:00"),s=o.toLocaleDateString("pt-BR",{weekday:"long"}),t=o.toLocaleDateString("pt-BR");e.push([t,s,a.entrada_1||"-",a.saida_1||"-",a.entrada_2||"-",a.saida_2||"-",calcularTotalHoras(a),a.status||"Normal"].join(";"))}),e.push(""),e.push("DECLARAÇÃO"),e.push("Declaro que os registros acima estão corretos e conferidos."),e.push(`Assinado digitalmente em ${n}`),e.join("\n")}(l,c.nome,p,u,m),_=t(a,{xForwardedFor:!0}),g=(new Date).toLocaleString("pt-BR",{timeZone:"America/Sao_Paulo"}),{data:S,error:b}=await n.from("assinaturas_ponto").insert({colaborador_id:c.id,mes:p,ano:u,ip_assinatura:_,arquivo_csv:Buffer.from(f).toString("base64"),total_dias:m.diasTrabalhados,total_horas:m.horasTrabalhadas,observacoes:`Assinado em ${g}`}).select().single();if(b)throw console.error("Erro ao criar assinatura:",b),o({statusCode:500,message:"Erro ao assinar ponto"});return S});function calcularTotalHoras(a){if(!a.entrada_1)return"0h00";let o=0;if(a.entrada_1&&a.saida_1){const s=parseHora(a.entrada_1);o+=parseHora(a.saida_1)-s}if(a.entrada_2&&a.saida_2){const s=parseHora(a.entrada_2);o+=parseHora(a.saida_2)-s}return`${Math.floor(o/60)}h${(o%60).toString().padStart(2,"0")}`}function parseHora(a){const[o,s]=a.split(":").map(Number);return 60*o+s}export{n as default};
