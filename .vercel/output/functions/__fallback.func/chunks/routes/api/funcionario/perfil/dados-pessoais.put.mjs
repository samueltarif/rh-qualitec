import{d as a,c as o,r as e}from"../../../../_/nitro.mjs";import{s}from"../../../../_/serverSupabaseClient.mjs";import{s as t}from"../../../../_/serverSupabaseUser.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"node:crypto";import"@supabase/ssr";import"../../../../_/fetch-retry.mjs";const r=a(async a=>{const r=await s(a),i=await t(a);if(!i)throw o({statusCode:401,message:"Não autenticado"});const d=await e(a);let{data:p}=await r.from("app_users").select("id, colaborador_id").eq("auth_uid",i.id).single();if(!p&&i.email){const{data:a}=await r.from("app_users").select("id, colaborador_id").eq("email",i.email).single();a&&(await r.from("app_users").update({auth_uid:i.id}).eq("id",a.id),p=a)}if(!(null==p?void 0:p.colaborador_id))throw o({statusCode:400,message:"Usuário não vinculado a colaborador"});const{error:l}=await r.from("colaboradores").update({telefone:d.telefone||null,sexo:d.sexo||null,estado_civil:d.estado_civil||null}).eq("id",p.colaborador_id);if(l)throw o({statusCode:500,message:l.message});try{await r.rpc("fn_registrar_atividade",{p_tipo_acao:"update",p_modulo:"solicitacoes",p_descricao:"Atualizou dados pessoais (telefone, sexo, estado civil)",p_detalhes:JSON.stringify({campos:Object.keys(d)})})}catch(a){console.error("Erro ao registrar atividade:",a)}return{success:!0,message:"Dados pessoais atualizados!"}});export{r as default};
