import{d as a,c as t,a as e}from"../../../../_/nitro.mjs";import{s as r}from"../../../../_/serverSupabaseClient.mjs";import{s as o}from"../../../../_/serverSupabaseUser.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"node:crypto";import"@supabase/ssr";import"../../../../_/fetch-retry.mjs";const s=a(async a=>{try{const s=await r(a),d=await o(a);if(!d)throw t({statusCode:401,message:"Não autenticado"});const i=e(a),n=i.mes?parseInt(i.mes):12,c=i.ano?parseInt(i.ano):2025,l=d.sub||d.id;let m=null;const{data:_}=await s.from("colaboradores").select("id, nome").eq("auth_uid",l).single();if(_)m=_.id;else{const{data:a}=await s.from("app_users").select("colaborador_id, nome").eq("auth_uid",l).single();(null==a?void 0:a.colaborador_id)&&(m=a.colaborador_id)}if(!m)return{success:!1,error:"Colaborador não encontrado",userId:l};const u=`${c}-${String(n).padStart(2,"0")}-01`,p=new Date(c,n,0).toISOString().split("T")[0],{data:f,error:g}=await s.from("registros_ponto").select("*").eq("colaborador_id",m).gte("data",u).lte("data",p).order("data",{ascending:!0});if(g)return{success:!1,error:g.message};const $=(null==f?void 0:f.map(a=>({data:new Date(a.data).toLocaleDateString("pt-BR"),entrada_1:a.entrada_1||"-",saida_1:a.saida_1||"-",entrada_2:a.entrada_2||"-",saida_2:a.saida_2||"-",horas_trabalhadas:calcularHorasRegistro(a)})))||[];return{success:!0,colaborador:(null==_?void 0:_.nome)||"Não identificado",periodo:`${n}/${c}`,total_registros:(null==f?void 0:f.length)||0,registros:$,registros_raw:f}}catch(a){return{success:!1,error:a.message}}});function calcularHorasRegistro(a){if(!a.entrada_1)return"0h00";let t=0;if(a.entrada_1&&a.saida_2){const e=new Date(`${a.data}T${a.entrada_1}`);let r=new Date(`${a.data}T${a.saida_2}`).getTime()-e.getTime();if(a.saida_1&&a.entrada_2){const t=new Date(`${a.data}T${a.saida_1}`),e=new Date(`${a.data}T${a.entrada_2}`).getTime()-t.getTime();e>0&&(r-=e)}r>0&&(t=Math.floor(r/6e4))}else if(a.entrada_1&&a.saida_1&&!a.entrada_2){const e=new Date(`${a.data}T${a.entrada_1}`),r=new Date(`${a.data}T${a.saida_1}`).getTime()-e.getTime();r>0&&(t=Math.floor(r/6e4))}return`${Math.floor(t/60)}h${(t%60).toString().padStart(2,"0")}`}export{s as default};
