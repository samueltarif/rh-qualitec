import{d as t,a,c as n,s as o}from"../../../../_/nitro.mjs";import{s as e}from"../../../../_/serverSupabaseServiceRole.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"node:crypto";import"@supabase/functions-js";import"../../../../virtual/_commonjsHelpers.mjs";import"@supabase/postgrest-js";import"@supabase/realtime-js";import"@supabase/storage-js";import"@supabase/auth-js";import"../../../../_/fetch-retry.mjs";const r=t(async t=>{var r,s;try{const i=e(t),d=a(t),p=d.colaborador_id;console.log("üîç Gerando relat√≥rio HTML para colaborador:",p||"CARLOS (padr√£o)");const l=p||"c79f679a-147a-47c1-9344-83833507adb0",{data:g}=await i.from("colaboradores").select("id, nome, matricula, cargo:cargos(nome), departamento:departamentos(nome)").eq("id",l).single();if(!g)throw n({statusCode:404,message:"Colaborador n√£o encontrado"});const m=d.mes?parseInt(d.mes):(new Date).getMonth()+1,c=d.ano?parseInt(d.ano):(new Date).getFullYear(),{data:h}=await i.from("assinaturas_ponto").select("*").eq("colaborador_id",g.id).eq("mes",m).eq("ano",c).single();console.log(`üìã Gerando relat√≥rio para: ${g.nome} - ${m}/${c}`);const f=new Date(c,m-1,1).toISOString().split("T")[0],u=new Date(c,m,0).toISOString().split("T")[0],{data:b}=await i.from("registros_ponto").select("*").eq("colaborador_id",g.id).gte("data",f.toISOString().split("T")[0]).lte("data",u.toISOString().split("T")[0]).order("data",{ascending:!0});let $=0,x=0;console.log(`üìã Registros encontrados na tabela: ${(null==b?void 0:b.length)||0}`);const S=(null==b?void 0:b.map(t=>{const a=t.entrada_1||"-",n=t.saida_2||t.saida_1||"-";let o="-";if(t.saida_1&&t.entrada_2){const a=new Date(`2000-01-01T${t.saida_1}`),n=new Date(`2000-01-01T${t.entrada_2}`).getTime()-a.getTime();if(n>0){const t=Math.floor(n/6e4),a=t%60;o=`${Math.floor(t/60).toString().padStart(2,"0")}:${a.toString().padStart(2,"0")}`}}let e="-",r=0;if("-"!==a&&"-"!==n){const o=new Date(`2000-01-01T${a}`);let s=new Date(`2000-01-01T${n}`).getTime()-o.getTime();if(t.saida_1&&t.entrada_2){const a=new Date(`2000-01-01T${t.saida_1}`),n=new Date(`2000-01-01T${t.entrada_2}`).getTime()-a.getTime();n>0&&(s-=n)}if(s>0){r=Math.floor(s/6e4),x+=r,r>=60&&$++;e=`${Math.floor(r/60)}h${(r%60).toString().padStart(2,"0")}`}}return{data:new Date(t.data).toLocaleDateString("pt-BR"),entrada:a,intervalo:o,saida:n,horas:e,valido:r>0}}).filter(t=>t.valido))||[],v=Math.floor(x/60),T=x%60,y=`${v.toString().padStart(2,"0")}:${T.toString().padStart(2,"0")}`,w=`\n<!DOCTYPE html>\n<html>\n<head>\n    <meta charset="UTF-8">\n    <title>Relat√≥rio de Ponto - ${g.nome}</title>\n    <style>\n        body { font-family: Arial, sans-serif; margin: 20px; }\n        .header { text-align: center; margin-bottom: 30px; }\n        .info { margin-bottom: 20px; }\n        .info p { margin: 5px 0; }\n        table { width: 100%; border-collapse: collapse; margin: 20px 0; }\n        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }\n        th { background-color: #f2f2f2; }\n        .summary { margin-top: 20px; font-weight: bold; }\n        .footer { margin-top: 30px; font-size: 12px; color: #666; }\n        @media print {\n            body { margin: 0; }\n            .no-print { display: none; }\n        }\n    </style>\n</head>\n<body>\n    <div class="header">\n        <h1>RELAT√ìRIO DE PONTO ELETR√îNICO</h1>\n    </div>\n    \n    <div class="info">\n        <p><strong>Funcion√°rio:</strong> ${g.nome}</p>\n        <p><strong>Matr√≠cula:</strong> ${g.matricula}</p>\n        <p><strong>Cargo:</strong> ${(null==(r=g.cargo)?void 0:r.nome)||"N/A"}</p>\n        <p><strong>Departamento:</strong> ${(null==(s=g.departamento)?void 0:s.nome)||"N/A"}</p>\n        <p><strong>Per√≠odo:</strong> ${f.toLocaleDateString("pt-BR")} a ${u.toLocaleDateString("pt-BR")}</p>\n    </div>\n    \n    <table>\n        <thead>\n            <tr>\n                <th>Data</th>\n                <th>Entrada</th>\n                <th>Intervalo</th>\n                <th>Sa√≠da</th>\n                <th>Horas Trabalhadas</th>\n            </tr>\n        </thead>\n        <tbody>\n            ${S.map(t=>`\n                <tr>\n                    <td>${t.data}</td>\n                    <td>${t.entrada}</td>\n                    <td>${t.intervalo}</td>\n                    <td>${t.saida}</td>\n                    <td>${t.horas}</td>\n                </tr>\n            `).join("")}\n        </tbody>\n    </table>\n    \n    <div class="summary">\n        <p>Total de dias trabalhados: ${$}</p>\n        <p>Total de horas trabalhadas: ${y}</p>\n    </div>\n    \n    <div style="margin-top: 30px; border-top: 2px solid #333; padding-top: 20px;">\n        <h3>ASSINATURA DIGITAL</h3>\n        ${h?`\n            <div style="background: #e8f5e8; padding: 15px; border-radius: 5px; margin: 10px 0;">\n                <p><strong>‚úÖ Documento assinado digitalmente</strong></p>\n                <p><strong>Data da Assinatura:</strong> ${new Date(h.data_assinatura).toLocaleString("pt-BR")}</p>\n                <p><strong>Per√≠odo:</strong> ${String(h.mes).padStart(2,"0")}/${h.ano}</p>\n                <p><strong>IP:</strong> ${h.ip_assinatura||"N/A"}</p>\n                ${h.hash_assinatura?`\n                    <p><strong>Hash de Verifica√ß√£o:</strong></p>\n                    <p style="font-family: monospace; font-size: 10px; word-break: break-all; background: #f5f5f5; padding: 5px; border-radius: 3px;">\n                        ${h.hash_assinatura}\n                    </p>\n                `:""}\n                <p style="font-style: italic; margin-top: 10px;">\n                    Este documento possui validade jur√≠dica conforme MP 2.200-2/2001.\n                </p>\n            </div>\n        `:'\n            <div style="background: #fff3cd; padding: 15px; border-radius: 5px; margin: 10px 0;">\n                <p><strong>‚ö†Ô∏è Este documento ainda n√£o foi assinado digitalmente.</strong></p>\n                <p>Para assinar, acesse o sistema e confirme seus registros de ponto.</p>\n            </div>\n        '}\n    </div>\n    \n    <div class="footer">\n        <p>Relat√≥rio gerado em: ${(new Date).toLocaleString("pt-BR")}</p>\n        <p>Sistema de Ponto Eletr√¥nico - Qualitec</p>\n    </div>\n    \n    <div class="no-print" style="margin-top: 30px; text-align: center;">\n        <button onclick="window.print()" style="padding: 10px 20px; font-size: 16px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">\n            Imprimir / Salvar como PDF\n        </button>\n    </div>\n</body>\n</html>\n    `;return o(t,{"Content-Type":"text/html; charset=utf-8"}),w}catch(t){throw console.error("Erro ao gerar relat√≥rio:",t),n({statusCode:500,message:"Erro ao gerar relat√≥rio"})}});export{r as default};
