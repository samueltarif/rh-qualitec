import{d as a,r as o,c as t}from"../../../../_/nitro.mjs";import{s as e}from"../../../../_/serverSupabaseClient.mjs";import{s as r}from"../../../../_/serverSupabaseUser.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"node:crypto";import"@supabase/ssr";import"../../../../_/fetch-retry.mjs";const i=a(async a=>{const i=await e(a),s=await r(a),d=await o(a),n=(null==s?void 0:s.sub)||(null==s?void 0:s.id);if(!s||!n)throw t({statusCode:401,message:"Não autenticado ou sessão inválida"});if(!/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(n))throw t({statusCode:401,message:"ID de usuário inválido. Faça login novamente."});try{if(!d.latitude||!d.longitude)throw t({statusCode:400,message:"GPS obrigatório. Ative a localização e tente novamente."});const{data:a,error:o}=await i.rpc("verificar_local_permitido",{p_latitude:d.latitude,p_longitude:d.longitude});if(o)throw console.error("Erro ao verificar localização:",o),t({statusCode:500,message:"Erro ao verificar localização. Tente novamente."});const e=null==a?void 0:a[0];if(!e||!e.dentro_raio){const a=(null==e?void 0:e.distancia)||"desconhecida",o=(null==e?void 0:e.local_nome)||"local cadastrado";throw t({statusCode:403,message:`Você está fora do local permitido. Distância: ${a}m do ${o}. Aproxime-se para bater ponto.`})}const{data:r,error:s}=await i.from("app_users").select("id, colaborador_id").eq("auth_uid",n).single();if(s||!r)throw t({statusCode:400,message:"Usuário não encontrado no sistema"});const l=r;if(!l.colaborador_id)throw t({statusCode:400,message:"Usuário não vinculado a um colaborador."});const c=new Date((new Date).toLocaleString("en-US",{timeZone:"America/Sao_Paulo"})),m=c.toISOString().split("T")[0],u=c.toTimeString().split(" ")[0].substring(0,5),{data:g,error:p}=await i.from("registros_ponto").select("*").eq("colaborador_id",l.colaborador_id).eq("data",m).maybeSingle();if(p)throw t({statusCode:500,message:"Erro ao verificar registros do dia"});const _=g;if(_){const a={};let o="";if(_.entrada_1)if(_.saida_1)if(_.entrada_2)if(_.saida_2)if(_.entrada_3){if(_.saida_3)throw t({statusCode:400,message:"Todos os registros do dia já foram preenchidos (máximo 6 batidas)"});a.saida_3=u,o="Saída Extra"}else a.entrada_3=u,o="Entrada Extra";else a.saida_2=u,o="Saída";else a.entrada_2=u,o="Retorno Intervalo";else a.saida_1=u,o="Saída Intervalo";else a.entrada_1=u,o="Entrada";d.ip&&(a.ip_registro=d.ip),d.localizacao&&(a.localizacao=d.localizacao),a.latitude=d.latitude,a.longitude=d.longitude,a.local_id=e.local_id,a.distancia_metros=e.distancia,a.fora_do_raio=!1;const{data:r,error:s}=await i.from("registros_ponto").update(a).eq("id",_.id).select().single();if(s)throw t({statusCode:500,message:s.message});return{registro:r,tipo:o,horario:u,message:`${o} registrada às ${u}`}}{const{data:a,error:o}=await i.from("registros_ponto").insert({colaborador_id:l.colaborador_id,data:m,entrada_1:u,ip_registro:d.ip||null,localizacao:d.localizacao||null,latitude:d.latitude,longitude:d.longitude,local_id:e.local_id,distancia_metros:e.distancia,fora_do_raio:!1,status:"Normal"}).select().single();if(o)throw console.error("Erro ao criar registro de ponto:",o),t({statusCode:500,message:o.message});return{registro:a,tipo:"Entrada",horario:u,message:`Entrada registrada às ${u}`}}}catch(a){throw console.error("Erro ao registrar ponto:",a),t({statusCode:a.statusCode||500,message:a.message||"Erro ao registrar ponto",data:a.data})}});export{i as default};
