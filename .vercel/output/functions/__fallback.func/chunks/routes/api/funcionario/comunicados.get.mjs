import{d as o,c as a}from"../../../_/nitro.mjs";import{s as e}from"../../../_/serverSupabaseClient.mjs";import{s as r}from"../../../_/serverSupabaseUser.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"node:crypto";import"@supabase/ssr";import"../../../_/fetch-retry.mjs";const i=o(async o=>{const i=await e(o),s=await r(o);if(!s)throw a({statusCode:401,message:"NÃ£o autenticado"});try{const{data:o}=await i.from("app_users").select("colaborador_id").eq("auth_uid",s.id).single(),e=o;if(!(null==e?void 0:e.colaborador_id))return[];const{data:r}=await i.from("colaboradores").select("empresa_id, departamento_id, cargo_id").eq("id",e.colaborador_id).single(),t=r;if(!(null==t?void 0:t.empresa_id))return[];const d=(new Date).toISOString(),{data:n,error:c}=await i.from("comunicados").select("\n        *,\n        publicado:app_users!comunicados_publicado_por_fkey(nome)\n      ").eq("empresa_id",t.empresa_id).eq("ativo",!0).or(`data_expiracao.is.null,data_expiracao.gt.${d}`).order("data_publicacao",{ascending:!1});if(c)throw a({statusCode:500,message:c.message});const m=(n||[]).filter(o=>{var a,r,i;return"todos"===o.destino||(!("departamento"!==o.destino||!(null==(a=o.destino_ids)?void 0:a.includes(t.departamento_id)))||(!("cargo"!==o.destino||!(null==(r=o.destino_ids)?void 0:r.includes(t.cargo_id)))||!("individual"!==o.destino||!(null==(i=o.destino_ids)?void 0:i.includes(e.colaborador_id)))))}),{data:p}=await i.from("comunicados_lidos").select("comunicado_id").eq("colaborador_id",e.colaborador_id),u=new Set((p||[]).map(o=>o.comunicado_id));return m.map(o=>({...o,lido:u.has(o.id)}))}catch(o){throw console.error("Erro ao buscar comunicados:",o),a({statusCode:500,message:o.message||"Erro ao buscar comunicados"})}});export{i as default};
