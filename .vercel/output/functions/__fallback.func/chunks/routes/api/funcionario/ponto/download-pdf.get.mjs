import{d as o,c as a}from"../../../../_/nitro.mjs";import{s as t}from"../../../../_/serverSupabaseClient.mjs";import{s as e}from"../../../../_/serverSupabaseUser.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"node:crypto";import"@supabase/ssr";import"../../../../_/fetch-retry.mjs";const r=o(async o=>{var r,s;try{const n=await t(o),i=await e(o);if(!i)throw a({statusCode:401,message:"N√£o autenticado"});console.log("üîç Gerando relat√≥rio para usu√°rio:",i.id,i.email);let l=null;try{const{data:o}=await n.from("colaboradores").select("id, nome, matricula, cargo:cargos(nome), departamento:departamentos(nome)").eq("auth_uid",i.id).single();o&&(l=o,console.log("‚úÖ Colaborador encontrado por auth_uid:",l.nome))}catch(o){console.log("‚ö†Ô∏è N√£o encontrado por auth_uid:",o)}if(!l&&i.email)try{const{data:o}=await n.from("colaboradores").select("id, nome, matricula, cargo:cargos(nome), departamento:departamentos(nome)").eq("email_corporativo",i.email).single();o&&(l=o,console.log("‚úÖ Colaborador encontrado por email:",l.nome))}catch(o){console.log("‚ö†Ô∏è N√£o encontrado por email:",o)}if(!l)throw console.error("‚ùå Colaborador n√£o encontrado"),a({statusCode:404,message:"Colaborador n√£o encontrado"});console.log("üìã Gerando relat√≥rio para colaborador:",l.nome);const d=new Date,c=new Date;c.setDate(d.getDate()-30),console.log("üìÖ Per√≠odo:",c.toISOString().split("T")[0],"at√©",d.toISOString().split("T")[0]);const{data:m,error:g}=await n.from("registros_ponto").select("*").eq("colaborador_id",l.id).gte("data",c.toISOString().split("T")[0]).lte("data",d.toISOString().split("T")[0]).order("data",{ascending:!0});if(g)throw console.error("‚ùå Erro ao buscar registros:",g),a({statusCode:500,message:"Erro ao buscar registros de ponto"});console.log("üìä Registros encontrados:",(null==m?void 0:m.length)||0);const p=(new Date).getMonth()+1,u=(new Date).getFullYear(),{data:h}=await n.from("assinaturas_ponto").select("*").eq("colaborador_id",l.id).eq("mes",p).eq("ano",u).maybeSingle();console.log("üìù Assinatura encontrada:",!!h);let S=0,_=0;const f=[];m&&m.length>0&&m.forEach(o=>{const a=o.entrada_1||"-",t=o.saida_2||o.saida_1||"-";let e="-";if(o.saida_1&&o.entrada_2){const a=new Date(`2000-01-01T${o.saida_1}`),t=new Date(`2000-01-01T${o.entrada_2}`).getTime()-a.getTime(),r=Math.floor(t/6e4),s=r%60;e=`${Math.floor(r/60).toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`}let r="-";if("-"!==a&&"-"!==t){const e=new Date(`2000-01-01T${a}`);let s=new Date(`2000-01-01T${t}`).getTime()-e.getTime();if(o.saida_1&&o.entrada_2&&o.saida_2){const a=new Date(`2000-01-01T${o.saida_1}`);s-=new Date(`2000-01-01T${o.entrada_2}`).getTime()-a.getTime()}const n=Math.floor(s/6e4);n>=60&&(_+=n,S++);const i=n%60;r=`${Math.floor(n/60).toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}`}f.push({data:new Date(o.data).toLocaleDateString("pt-BR"),entrada:a,intervalo:e,saida:t,horas:r})});const w=Math.floor(_/60),D=_%60,b=`${w.toString().padStart(2,"0")}:${D.toString().padStart(2,"0")}`;return console.log("‚úÖ Dados processados:",{totalDias:S,totalHorasFormatado:b,registros:f.length}),{success:!0,colaborador:{nome:l.nome,matricula:l.matricula,cargo:(null==(r=l.cargo)?void 0:r.nome)||"N/A",departamento:(null==(s=l.departamento)?void 0:s.nome)||"N/A"},periodo:{inicio:c.toLocaleDateString("pt-BR"),fim:d.toLocaleDateString("pt-BR")},resumo:{totalDias:S,totalHoras:b},registros:f,assinatura:h?{dataAssinatura:new Date(h.data_assinatura).toLocaleString("pt-BR"),mes:h.mes,ano:h.ano,ip:h.ip_assinatura,hash:h.hash_assinatura}:null}}catch(o){throw console.error("‚ùå Erro ao processar relat√≥rio:",o),a({statusCode:500,message:"Erro ao gerar relat√≥rio: "+o.message})}});export{r as default};
