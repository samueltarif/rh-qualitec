import{d as a,c as o,r as e}from"../../../../_/nitro.mjs";import{s as r}from"../../../../_/serverSupabaseClient.mjs";import{s as t}from"../../../../_/serverSupabaseUser.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"node:crypto";import"@supabase/ssr";import"../../../../_/fetch-retry.mjs";const i=a(async a=>{const i=await r(a),s=await t(a);if(!s)throw o({statusCode:401,message:"Não autenticado"});const d=await e(a);let{data:c}=await i.from("app_users").select("id, colaborador_id").eq("auth_uid",s.id).single();if(!c&&s.email){const{data:a}=await i.from("app_users").select("id, colaborador_id").eq("email",s.email).single();a&&(await i.from("app_users").update({auth_uid:s.id}).eq("id",a.id),c=a)}if(!(null==c?void 0:c.colaborador_id))throw o({statusCode:400,message:"Usuário não vinculado a colaborador"});const{data:n}=await i.from("colaboradores").select("empresa_id").eq("id",c.colaborador_id).single();if(!(null==n?void 0:n.empresa_id))throw o({statusCode:400,message:"Empresa não encontrada"});const p=n.empresa_id,{data:m}=await i.from("colaboradores").select("banco_nome, banco_codigo, agencia, conta, tipo_conta, pix").eq("id",c.colaborador_id).single(),{error:_}=await i.from("solicitacoes_alteracao_dados").insert({empresa_id:p,colaborador_id:c.colaborador_id,tipo:"dados_bancarios",dados_anteriores:m||{},dados_novos:{banco_nome:d.banco_nome,banco_codigo:d.banco_codigo,agencia:d.agencia,conta:d.conta,tipo_conta:d.tipo_conta,pix:d.pix},requer_aprovacao:!0,status:"pendente"});if(_)throw o({statusCode:500,message:_.message});try{await i.rpc("fn_registrar_atividade",{p_tipo_acao:"create",p_modulo:"solicitacoes",p_descricao:"Solicitou alteração de dados bancários",p_detalhes:JSON.stringify({banco:d.banco_nome})})}catch(a){console.error("Erro ao registrar atividade:",a)}return{success:!0,message:"Solicitação enviada para aprovação!"}});export{i as default};
