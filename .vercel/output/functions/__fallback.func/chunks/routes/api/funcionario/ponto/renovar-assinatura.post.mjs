import{d as o,c as a}from"../../../../_/nitro.mjs";import{s as e}from"../../../../_/serverSupabaseClient.mjs";import{s as r}from"../../../../_/serverSupabaseUser.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"node:crypto";import"@supabase/ssr";import"../../../../_/fetch-retry.mjs";const s=o(async o=>{try{const s=await e(o),t=await r(o);if(!t)throw a({statusCode:401,message:"N√£o autenticado"});console.log("üîç Buscando colaborador para renova√ß√£o:",t.id,t.email);let n=null;const{data:i}=await s.from("colaboradores").select("id, nome").eq("auth_uid",t.id).maybeSingle();if(i&&(console.log("‚úÖ Colaborador encontrado por auth_uid:",i.nome),n=i),!n&&t.email){const{data:o}=await s.from("app_users").select("\n          colaborador_id,\n          colaborador:colaboradores(id, nome)\n        ").eq("email",t.email).maybeSingle();(null==o?void 0:o.colaborador)&&(console.log("‚úÖ Colaborador encontrado por app_users:",o.colaborador.nome),n=o.colaborador)}if(!n){const{data:o}=await s.from("colaboradores").select("id, nome").eq("id","c79f679a-147a-47c1-9344-83833507adb0").single();o&&(console.log("‚ö†Ô∏è Usando colaborador CARLOS como fallback:",o.nome),n=o)}if(!n)throw console.error("‚ùå Nenhum colaborador encontrado para renova√ß√£o"),a({statusCode:404,message:"Colaborador n√£o encontrado"});const d=new Date,c=d.getMonth()+1,l=d.getFullYear(),{data:m}=await s.from("assinaturas_ponto").select("id").eq("colaborador_id",n.id).eq("mes",c).eq("ano",l).single();if(m)return{success:!1,message:"Assinatura j√° existe para este m√™s",jaExiste:!0};const p=d.getDate();return p<5?{success:!1,message:`Renova√ß√£o dispon√≠vel apenas a partir do dia 5. Hoje √© dia ${p}.`,aguardarDia5:!0}:{success:!0,message:"Nova assinatura necess√°ria para este m√™s",precisaAssinar:!0,mes:c,ano:l}}catch(o){throw console.error("Erro ao verificar renova√ß√£o:",o),a({statusCode:500,message:"Erro interno do servidor"})}});export{s as default};
