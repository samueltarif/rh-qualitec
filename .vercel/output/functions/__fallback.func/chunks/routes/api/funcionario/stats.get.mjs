import{d as o,c as a}from"../../../_/nitro.mjs";import{s as t}from"../../../_/serverSupabaseClient.mjs";import{s as e}from"../../../_/serverSupabaseUser.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"node:crypto";import"@supabase/ssr";import"../../../_/fetch-retry.mjs";const s=o(async o=>{var s;const i=await t(o),r=await e(o);if(!r)throw a({statusCode:401,message:"Não autenticado"});try{const{data:o}=await i.from("app_users").select("colaborador_id").eq("auth_uid",r.id).single(),a=o;if(!(null==a?void 0:a.colaborador_id))return{banco_horas:"00:00",dias_ferias:0,solicitacoes_pendentes:0,documentos_novos:0,comunicados_nao_lidos:0};const t=a.colaborador_id,{data:e}=await i.from("colaboradores").select("empresa_id, data_admissao").eq("id",t).single(),d=e;let n=0;if(null==d?void 0:d.data_admissao){const o=new Date(d.data_admissao),a=new Date,t=Math.floor((a.getTime()-o.getTime())/2592e6);n=Math.min(30,Math.floor(2.5*t))}const{data:c}=await i.from("ferias").select("dias_gozo").eq("colaborador_id",t).in("status",["Aprovada","Em_Andamento","Concluida"]),m=(c||[]).reduce((o,a)=>o+(a.dias_gozo||0),0);n=Math.max(0,n-m);const{count:l}=await i.from("solicitacoes_funcionario").select("id",{count:"exact",head:!0}).eq("colaborador_id",t).in("status",["Pendente","Em_Analise"]),_=new Date;_.setDate(_.getDate()-30);const{count:p}=await i.from("documentos_funcionario").select("id",{count:"exact",head:!0}).eq("colaborador_id",t).eq("disponivel_para_funcionario",!0).gte("created_at",_.toISOString());let u=0;if(null==d?void 0:d.empresa_id){const{data:o}=await i.from("comunicados").select("id").eq("empresa_id",d.empresa_id).eq("ativo",!0),{data:a}=await i.from("comunicados_lidos").select("comunicado_id").eq("colaborador_id",t),e=new Set((a||[]).map(o=>o.comunicado_id));u=(o||[]).filter(o=>!e.has(o.id)).length}const{data:f}=await i.from("banco_horas").select("tipo, horas").eq("colaborador_id",t);let h=0;for(const o of f||[]){const a=null==(s=o.horas)?void 0:s.match(/(\d+):(\d+)/);if(a){const t=60*parseInt(a[1])+parseInt(a[2]);"credito"===o.tipo?h+=t:"debito"!==o.tipo&&"compensacao"!==o.tipo||(h-=t)}}const b=Math.floor(Math.abs(h)/60),w=Math.abs(h)%60;return{banco_horas:`${h<0?"-":""}${String(b).padStart(2,"0")}:${String(w).padStart(2,"0")}`,dias_ferias:n,solicitacoes_pendentes:l||0,documentos_novos:p||0,comunicados_nao_lidos:u}}catch(o){throw console.error("Erro ao buscar estatísticas:",o),a({statusCode:500,message:o.message||"Erro ao buscar estatísticas"})}});export{s as default};
