import{d as o,a as e,c as a,s as t}from"../../../../_/nitro.mjs";import{s as r}from"../../../../_/serverSupabaseClient.mjs";import{s}from"../../../../_/serverSupabaseUser.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"node:crypto";import"@supabase/ssr";import"../../../../_/fetch-retry.mjs";const n=o(async o=>{try{const n=await r(o),i=await s(o),d=e(o),c=parseInt(d.mes),l=parseInt(d.ano),m=(null==i?void 0:i.id)||(null==i?void 0:i.sub);if(!i||!m)throw a({statusCode:401,message:"N√£o autenticado"});if(!c||!l)throw a({statusCode:400,message:"M√™s e ano s√£o obrigat√≥rios"});console.log("üîç [CSV] User ID:",m),console.log("üîç [CSV] Query:",d);let p=null;const{data:u}=await n.from("colaboradores").select("id, nome").eq("auth_uid",m).single();if(u)p=u.id,console.log("‚úÖ [CSV] Colaborador encontrado por auth_uid:",u.nome);else{const{data:o}=await n.from("app_users").select("colaborador_id, nome").eq("auth_uid",m).single();(null==o?void 0:o.colaborador_id)&&(p=o.colaborador_id,console.log("‚úÖ [CSV] Colaborador encontrado via app_users:",o.nome))}if(!p)throw console.error("‚ùå [CSV] Colaborador n√£o encontrado para user:",m),a({statusCode:404,message:"Colaborador n√£o encontrado"});const{data:f,error:C}=await n.from("assinaturas_ponto").select("arquivo_csv").eq("colaborador_id",p).eq("mes",c).eq("ano",l).single();if(C||!f)throw a({statusCode:404,message:"Assinatura n√£o encontrada para este per√≠odo"});const h=f.arquivo_csv;if(!h)throw a({statusCode:404,message:"Arquivo CSV n√£o dispon√≠vel"});const _=Buffer.from(h,"base64").toString("utf-8");return t(o,{"Content-Type":"text/csv; charset=utf-8","Content-Disposition":`attachment; filename="ponto_${c.toString().padStart(2,"0")}_${l}.csv"`,"Cache-Control":"no-cache"}),_}catch(o){if(console.error("Erro ao processar download CSV:",o),o.statusCode)throw o;throw a({statusCode:500,message:"Erro interno do servidor"})}});export{n as default};
