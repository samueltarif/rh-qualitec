import{d as a,c as o,r as e}from"../../../../_/nitro.mjs";import{s as t}from"../../../../_/serverSupabaseClient.mjs";import{s as r}from"../../../../_/serverSupabaseUser.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"node:crypto";import"@supabase/ssr";import"../../../../_/fetch-retry.mjs";const s=a(async a=>{const s=await t(a),i=await r(a);if(!i)throw o({statusCode:401,message:"Não autenticado"});const d=await e(a);let{data:c}=await s.from("app_users").select("id, colaborador_id").eq("auth_uid",i.id).single();if(!c&&i.email){const{data:a}=await s.from("app_users").select("id, colaborador_id").eq("email",i.email).single();a&&(await s.from("app_users").update({auth_uid:i.id}).eq("id",a.id),c=a)}if(!(null==c?void 0:c.colaborador_id))throw o({statusCode:400,message:"Usuário não vinculado a colaborador"});const{error:n}=await s.from("colaboradores").update({cnh:d.cnh||null,cnh_categoria:d.cnh_categoria||null,cnh_validade:d.cnh_validade||null}).eq("id",c.colaborador_id);if(n)throw o({statusCode:500,message:n.message});try{await s.rpc("fn_registrar_atividade",{p_tipo_acao:"update",p_modulo:"documentos",p_descricao:"Atualizou documentos (CNH)",p_detalhes:JSON.stringify({cnh_categoria:d.cnh_categoria})})}catch(a){console.error("Erro ao registrar atividade:",a)}return{success:!0,message:"Documentos atualizados!"}});export{s as default};
