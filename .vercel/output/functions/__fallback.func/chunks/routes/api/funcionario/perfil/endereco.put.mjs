import{d as a,c as o,r as e}from"../../../../_/nitro.mjs";import{s as r}from"../../../../_/serverSupabaseClient.mjs";import{s as t}from"../../../../_/serverSupabaseUser.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"node:crypto";import"@supabase/ssr";import"../../../../_/fetch-retry.mjs";const s=a(async a=>{const s=await r(a),i=await t(a);if(!i)throw o({statusCode:401,message:"Não autenticado"});const d=await e(a);let{data:l}=await s.from("app_users").select("id, colaborador_id").eq("auth_uid",i.id).single();if(!l&&i.email){const{data:a}=await s.from("app_users").select("id, colaborador_id").eq("email",i.email).single();a&&(await s.from("app_users").update({auth_uid:i.id}).eq("id",a.id),l=a)}if(!(null==l?void 0:l.colaborador_id))throw o({statusCode:400,message:"Usuário não vinculado a colaborador"});const{error:n}=await s.from("colaboradores").update({cep:d.cep||null,logradouro:d.logradouro||null,numero:d.numero||null,complemento:d.complemento||null,bairro:d.bairro||null,cidade:d.cidade||null,estado:d.estado||null}).eq("id",l.colaborador_id);if(n)throw o({statusCode:500,message:n.message});try{await s.rpc("fn_registrar_atividade",{p_tipo_acao:"update",p_modulo:"solicitacoes",p_descricao:"Atualizou endereço",p_detalhes:JSON.stringify({cidade:d.cidade,estado:d.estado})})}catch(a){console.error("Erro ao registrar atividade:",a)}return{success:!0,message:"Endereço atualizado!"}});export{s as default};
