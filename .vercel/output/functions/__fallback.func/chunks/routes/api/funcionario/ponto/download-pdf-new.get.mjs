import{d as o,a,c as t}from"../../../../_/nitro.mjs";import{s as e}from"../../../../_/serverSupabaseClient.mjs";import{s as r}from"../../../../_/serverSupabaseUser.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"node:crypto";import"@supabase/ssr";import"../../../../_/fetch-retry.mjs";const s=o(async o=>{try{console.log("üîç [PDF] Iniciando gera√ß√£o de relat√≥rio");const s=await e(o),n=await r(o),i=a(o),d=(null==n?void 0:n.id)||(null==n?void 0:n.sub);if(!n||!d)throw console.error("‚ùå [PDF] Usu√°rio n√£o autenticado"),t({statusCode:401,message:"N√£o autenticado"});console.log("‚úÖ [PDF] Usu√°rio autenticado:",n.email),console.log("üîç [PDF] User ID:",d);let l=null;const{data:c}=await s.from("colaboradores").select("id, nome, matricula").eq("auth_uid",d).single();if(c)l=c.id,console.log("‚úÖ [PDF] Colaborador encontrado por auth_uid:",c.nome);else{const{data:o}=await s.from("app_users").select("colaborador_id, nome").eq("auth_uid",d).single();(null==o?void 0:o.colaborador_id)&&(l=o.colaborador_id,console.log("‚úÖ [PDF] Colaborador encontrado via app_users:",o.nome))}if(!l)throw console.error("‚ùå [PDF] Colaborador n√£o encontrado para user:",d),t({statusCode:404,message:"Colaborador n√£o encontrado"});const{data:m}=await s.from("colaboradores").select("id, nome, matricula").eq("id",l).single();if(!m)throw console.error("‚ùå [PDF] Dados do colaborador n√£o encontrados"),t({statusCode:404,message:"Dados do colaborador n√£o encontrados"});console.log("‚úÖ [PDF] Colaborador encontrado:",m.nome),console.log("üìÖ [PDF] Jornada:",m.jornada);const u=new Date,g=i.mes?parseInt(i.mes):u.getMonth()+1,p=i.ano?parseInt(i.ano):u.getFullYear(),D=new Date(p,g-1,1),h=new Date(p,g,0),_=`${p}-${String(g).padStart(2,"0")}-01`,f=`${p}-${String(g).padStart(2,"0")}-${h.getDate()}`;console.log("üìÖ [PDF] Per√≠odo selecionado:",{mes:g,ano:p}),console.log("üìÖ [PDF] Buscando registros de",_,"at√©",f);const{data:b}=await s.from("registros_ponto").select("*").eq("colaborador_id",m.id).gte("data",_).lte("data",f).order("data",{ascending:!0});console.log("üìä [PDF] Registros encontrados:",(null==b?void 0:b.length)||0),console.log("üîç [PDF] Buscando assinatura para:",{mes:g,ano:p});const{data:S}=await s.from("assinaturas_ponto").select("*").eq("colaborador_id",m.id).eq("mes",g).eq("ano",p).maybeSingle();console.log("üìù [PDF] Assinatura encontrada:",!!S);const w=[];let F=0,P=0;null==b||b.forEach(o=>{const a=new Date(o.data),t=`${["Dom","Seg","Ter","Qua","Qui","Sex","S√°b"][a.getDay()]}, ${a.getDate().toString().padStart(2,"0")}/${(a.getMonth()+1).toString().padStart(2,"0")}`,e=o.entrada_1||"-",r=o.saida_2||o.saida_1||"-";let s="-",n="normal";if("-"!==e)if("-"!==r){const a=new Date(`2000-01-01T${e}`);let t=new Date(`2000-01-01T${r}`).getTime()-a.getTime();if(o.saida_1&&o.entrada_2&&o.saida_2){const a=new Date(`2000-01-01T${o.saida_1}`);t-=new Date(`2000-01-01T${o.entrada_2}`).getTime()-a.getTime()}const n=Math.floor(t/6e4);n>0&&(P+=n,F++);s=`${Math.floor(n/60)}h${(n%60).toString().padStart(2,"0")}`}else s="Em andamento",n="incompleto",F++;w.push({data:t,entrada:e,saida:r,horas:s,status:n})});const $=Math.floor(P/60),C=`${$}h${(P%60).toString().padStart(2,"0")}`;return console.log("‚úÖ [PDF] Dados processados:",{totalDias:F,totalHorasFormatado:C,diasGerados:w.length}),{success:!0,colaborador:{nome:m.nome,matricula:m.matricula},periodo:{inicio:D.toLocaleDateString("pt-BR"),fim:h.toLocaleDateString("pt-BR")},resumo:{totalDias:F,totalHoras:C},registros:w,assinatura:S?{dataAssinatura:new Date(S.data_assinatura).toLocaleString("pt-BR"),mes:S.mes,ano:S.ano,ip:S.ip_assinatura,hash:S.hash_assinatura,observacoes:S.observacoes}:null}}catch(o){if(console.error("‚ùå [PDF] Erro completo:",o),console.error("‚ùå [PDF] Stack:",o.stack),o.statusCode)throw o;throw t({statusCode:500,message:"Erro interno: "+o.message})}});export{s as default};
