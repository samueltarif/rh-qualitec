import{d as o,f as a,a as e,c as r}from"../../../_/nitro.mjs";import{s as t}from"../../../_/serverSupabaseClient.mjs";import{s}from"../../../_/serverSupabaseUser.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"node:crypto";import"@supabase/ssr";import"../../../_/fetch-retry.mjs";const n=o(async o=>{a(o,"Cache-Control","no-cache, no-store, must-revalidate, max-age=0"),a(o,"Pragma","no-cache"),a(o,"Expires","0");const n=await t(o),d=await s(o),l=e(o),i=(null==d?void 0:d.id)||(null==d?void 0:d.sub);if(!d||!i)throw r({statusCode:401,message:"N√£o autenticado"});try{console.log("üîç [FUNCIONARIO PONTO] User ID:",i),console.log("üîç [FUNCIONARIO PONTO] Query:",l);let o=null;const{data:a}=await n.from("colaboradores").select("id, nome").eq("auth_uid",i).single();if(a)o=a.id,console.log("‚úÖ [FUNCIONARIO PONTO] Colaborador encontrado por auth_uid:",a.nome);else{const{data:a}=await n.from("app_users").select("colaborador_id, nome").eq("auth_uid",i).single();(null==a?void 0:a.colaborador_id)&&(o=a.colaborador_id,console.log("‚úÖ [FUNCIONARIO PONTO] Colaborador encontrado via app_users:",a.nome))}if(!o)return console.error("‚ùå [FUNCIONARIO PONTO] Colaborador n√£o encontrado para user:",i),[];const e=new Date,t=l.mes?parseInt(l.mes):e.getMonth()+1,s=l.ano?parseInt(l.ano):e.getFullYear(),d=`${s}-${String(t).padStart(2,"0")}-01`,c=new Date(s,t,0).getDate(),O=`${s}-${String(t).padStart(2,"0")}-${c}`;console.log("üîç [FUNCIONARIO PONTO] Per√≠odo:",d,"at√©",O),console.log("üîç [FUNCIONARIO PONTO] Colaborador ID:",o);const{data:N,error:m}=await n.from("registros_ponto").select("\n        *,\n        colaborador:colaboradores(\n          id, nome, matricula, foto_url,\n          cargo:cargos(id, nome),\n          departamento:departamentos!colaboradores_departamento_id_fkey(id, nome)\n        )\n      ").eq("colaborador_id",o).gte("data",d).lte("data",O).order("data",{ascending:!1});if(console.log("üîç [FUNCIONARIO PONTO] Registros encontrados:",(null==N?void 0:N.length)||0),N&&N.length>0){console.log("üìä [FUNCIONARIO PONTO] Primeiros 3 registros:"),N.slice(0,3).forEach((o,a)=>{console.log(`  ${a+1}. Data: ${o.data} | Entrada: ${o.entrada_1} | Sa√≠da: ${o.saida_2||o.saida_1} | Status: ${o.status}`)}),console.log("üìÖ [FUNCIONARIO PONTO] Datas √∫nicas encontradas:");const o=[...new Set(N.map(o=>o.data))].sort();console.log("  Datas:",o);const a=N.filter(o=>o.data.startsWith("2024-11"));a.length>0&&(console.log("‚ö†Ô∏è [FUNCIONARIO PONTO] ENCONTRADOS REGISTROS DE NOVEMBRO:"),a.forEach(o=>{console.log(`    ${o.data} - ${o.entrada_1} - ${o.saida_2||o.saida_1}`)}))}else console.log("‚ùå [FUNCIONARIO PONTO] Nenhum registro encontrado para o per√≠odo");if(m)throw console.error("‚ùå [FUNCIONARIO PONTO] Erro ao buscar:",m),r({statusCode:500,message:m.message});return N||[]}catch(o){throw console.error("‚ùå [FUNCIONARIO PONTO] Erro geral:",o),r({statusCode:500,message:o.message||"Erro ao buscar registros"})}});export{n as default};
