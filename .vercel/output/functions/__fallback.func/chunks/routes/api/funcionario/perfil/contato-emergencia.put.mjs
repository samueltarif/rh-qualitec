import{d as e,c as o,r as a}from"../../../../_/nitro.mjs";import{s as t}from"../../../../_/serverSupabaseClient.mjs";import{s as n}from"../../../../_/serverSupabaseUser.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"node:crypto";import"@supabase/ssr";import"../../../../_/fetch-retry.mjs";const r=e(async e=>{const r=await t(e),i=await n(e);if(!i)throw o({statusCode:401,message:"Não autenticado"});const c=await a(e);let{data:s}=await r.from("app_users").select("id, colaborador_id").eq("auth_uid",i.id).single();if(!s&&i.email){const{data:e}=await r.from("app_users").select("id, colaborador_id").eq("email",i.email).single();e&&(await r.from("app_users").update({auth_uid:i.id}).eq("id",e.id),s=e)}if(!(null==s?void 0:s.colaborador_id))throw o({statusCode:400,message:"Usuário não vinculado a colaborador"});const{error:_}=await r.from("colaboradores").update({contato_emergencia_nome:c.contato_emergencia_nome||null,contato_emergencia_parentesco:c.contato_emergencia_parentesco||null,contato_emergencia_telefone:c.contato_emergencia_telefone||null,contato_emergencia_2_nome:c.contato_emergencia_2_nome||null,contato_emergencia_2_parentesco:c.contato_emergencia_2_parentesco||null,contato_emergencia_2_telefone:c.contato_emergencia_2_telefone||null,contato_emergencia_3_nome:c.contato_emergencia_3_nome||null,contato_emergencia_3_parentesco:c.contato_emergencia_3_parentesco||null,contato_emergencia_3_telefone:c.contato_emergencia_3_telefone||null}).eq("id",s.colaborador_id);if(_)throw o({statusCode:500,message:_.message});try{const e=[c.contato_emergencia_nome,c.contato_emergencia_2_nome,c.contato_emergencia_3_nome].filter(Boolean).length;await r.rpc("fn_registrar_atividade",{p_tipo_acao:"update",p_modulo:"solicitacoes",p_descricao:"Atualizou contatos de emergência",p_detalhes:JSON.stringify({contatos:e})})}catch(e){console.error("Erro ao registrar atividade:",e)}return{success:!0,message:"Contatos de emergência atualizados!"}});export{r as default};
