import{d as o,c as a}from"../../../_/nitro.mjs";import{s as r}from"../../../_/serverSupabaseClient.mjs";import{s as e}from"../../../_/serverSupabaseUser.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"node:crypto";import"@supabase/ssr";import"../../../_/fetch-retry.mjs";const s=o(async o=>{const s=await r(o),t=await e(o);if(!t)throw a({statusCode:401,message:"Não autenticado"});console.log("=== PERFIL DEBUG ==="),console.log("Auth user.id:",t.id),console.log("Auth user.email:",t.email);try{let{data:o,error:r}=await s.from("app_users").select("id, colaborador_id, nome, email, role, auth_uid").eq("auth_uid",t.id).single();if(console.log("Busca por auth_uid:",{appUser:o,appUserError:r}),!o){const{data:a,error:r}=await s.from("app_users").select("id, colaborador_id, nome, email, role, auth_uid").eq("email",t.email).single();console.log("Busca por email:",{appUserByEmail:a,emailError:r}),a&&(await s.from("app_users").update({auth_uid:t.id}).eq("id",a.id),o={...a,auth_uid:t.id},console.log("Auth_uid atualizado!"))}if(!o)throw a({statusCode:404,message:"Usuário não encontrado no app_users"});const e=o;if(console.log("AppUser encontrado:",e),!e.colaborador_id)return console.log("Colaborador_id está NULL ou vazio"),{appUser:e,colaborador:null,message:"Usuário não vinculado a um colaborador"};console.log("Buscando colaborador com ID:",e.colaborador_id);const{data:i,error:d}=await s.from("colaboradores").select("\n        *,\n        cargo:cargos(id, nome),\n        departamento:departamentos!colaboradores_departamento_id_fkey(id, nome),\n        jornada:jornadas_trabalho(id, nome, carga_horaria_semanal)\n      ").eq("id",e.colaborador_id).single();return console.log("Colaborador encontrado:",i),d&&console.error("Erro ao buscar colaborador:",d),{appUser:e,colaborador:i||null}}catch(o){throw console.error("Erro ao buscar perfil:",o),a({statusCode:500,message:o.message||"Erro ao buscar perfil"})}});export{s as default};
