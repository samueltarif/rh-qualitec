import{d as o,f as r,c as t}from"../../../../_/nitro.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"node:crypto";const e=o(async o=>{const e=await serverSupabaseClient(o),a=await serverSupabaseUser(o);r(o,"Cache-Control","no-cache, no-store, must-revalidate"),r(o,"Pragma","no-cache"),r(o,"Expires","0");const s=(null==a?void 0:a.id)||(null==a?void 0:a.sub);if(!a||!s)throw t({statusCode:401,message:"N√£o autenticado"});try{console.log("üîÑ [FORCE REFRESH] User ID:",s);const{data:o,error:r}=await e.from("app_users").select("colaborador_id, id, auth_uid").eq("auth_uid",s).single();if(console.log("üîÑ [FORCE REFRESH] App User:",o),!(null==o?void 0:o.colaborador_id))return{erro:"Colaborador n√£o encontrado",user_id:s,app_user:o};const{data:t,error:a}=await e.from("registros_ponto").select("*").eq("colaborador_id",o.colaborador_id).order("data",{ascending:!1});console.log("üîÑ [FORCE REFRESH] Total registros:",(null==t?void 0:t.length)||0);const i=new Date,n=i.getMonth()+1,d=i.getFullYear(),l=`${d}-${String(n).padStart(2,"0")}-01`,c=new Date(d,n,0).getDate(),p=`${d}-${String(n).padStart(2,"0")}-${c}`,{data:g,error:u}=await e.from("registros_ponto").select("*").eq("colaborador_id",o.colaborador_id).gte("data",l).lte("data",p).order("data",{ascending:!1});return console.log("üîÑ [FORCE REFRESH] Registros do m√™s:",(null==g?void 0:g.length)||0),{timestamp:(new Date).toISOString(),usuario:o,periodo:{dataInicio:l,dataFim:p},total_registros:(null==t?void 0:t.length)||0,registros_mes:(null==g?void 0:g.length)||0,todos_registros:t||[],registros_periodo:g||[],erros:{app_user:r,todos:a,mes:u}}}catch(o){return console.error("‚ùå [FORCE REFRESH] Erro:",o),{erro:o.message,timestamp:(new Date).toISOString()}}});export{e as default};
