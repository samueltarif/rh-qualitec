import{d as o,c as e,g as a,r as s}from"../../../../_/nitro.mjs";import{s as t}from"../../../../_/serverSupabaseClient.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"node:crypto";import"@supabase/ssr";import"../../../../_/fetch-retry.mjs";const r=o(async o=>{const r=await t(o),{data:{session:d}}=await r.auth.getSession();if(console.log("üîç [AUTH] Session:",d),!(null==d?void 0:d.user))throw console.error("‚ùå [AUTH] Sess√£o n√£o encontrada"),e({statusCode:401,message:"N√£o autenticado"});const i=d.user.id;console.log("‚úÖ [AUTH] Auth UID:",i);const n=a(o,"id"),c=await s(o),{data:_,error:m}=await r.from("app_users").select("id, role, nome, email").eq("auth_uid",i).single();if(console.log("üîç [AUTH] App User:",_),console.log("üîç [AUTH] App User Error:",m),!_)throw console.error("‚ùå [AUTH] App user n√£o encontrado para auth_uid:",i),e({statusCode:403,message:"Usu√°rio n√£o encontrado no sistema"});if(!["admin","gestor"].includes(_.role))throw console.error("‚ùå [AUTH] Usu√°rio sem permiss√£o. Role:",_.role),e({statusCode:403,message:"Sem permiss√£o"});console.log("‚úÖ [AUTH] Usu√°rio autorizado:",_.nome,"- Role:",_.role);const{data:p}=await r.from("solicitacoes_alteracao_dados").select("*").eq("id",n).single();if(!p)throw e({statusCode:404,message:"Solicita√ß√£o n√£o encontrada"});if("pendente"!==p.status)throw e({statusCode:400,message:"Solicita√ß√£o j√° foi processada"});if("aprovar"===c.acao){let o=null;if("dados_bancarios"===p.tipo){const{error:e}=await r.from("colaboradores").update({banco_nome:p.dados_novos.banco_nome,banco_codigo:p.dados_novos.banco_codigo,agencia:p.dados_novos.agencia,conta:p.dados_novos.conta,tipo_conta:p.dados_novos.tipo_conta,pix:p.dados_novos.pix}).eq("id",p.colaborador_id);o=e}else if("endereco"===p.tipo){const{error:e}=await r.from("colaboradores").update({endereco:p.dados_novos.endereco,numero:p.dados_novos.numero,complemento:p.dados_novos.complemento,bairro:p.dados_novos.bairro,cidade:p.dados_novos.cidade,estado:p.dados_novos.estado,cep:p.dados_novos.cep}).eq("id",p.colaborador_id);o=e}else if("contato_emergencia"===p.tipo){const{error:e}=await r.from("colaboradores").update({contato_emergencia_nome:p.dados_novos.contato_emergencia_nome,contato_emergencia_telefone:p.dados_novos.contato_emergencia_telefone,contato_emergencia_parentesco:p.dados_novos.contato_emergencia_parentesco}).eq("id",p.colaborador_id);o=e}else if("dados_pessoais"===p.tipo){const{error:e}=await r.from("colaboradores").update({telefone:p.dados_novos.telefone,email:p.dados_novos.email,estado_civil:p.dados_novos.estado_civil}).eq("id",p.colaborador_id);o=e}else if("documentos"===p.tipo){const{error:e}=await r.from("colaboradores").update({rg:p.dados_novos.rg,orgao_emissor:p.dados_novos.orgao_emissor,data_emissao:p.dados_novos.data_emissao,ctps:p.dados_novos.ctps,serie_ctps:p.dados_novos.serie_ctps,pis_pasep:p.dados_novos.pis_pasep}).eq("id",p.colaborador_id);o=e}if(o)throw e({statusCode:500,message:o.message});const{error:a}=await r.from("solicitacoes_alteracao_dados").update({status:"aprovada",aprovado_por:_.id,aprovado_em:(new Date).toISOString()}).eq("id",n);if(a)throw e({statusCode:500,message:a.message});return{success:!0,message:"Altera√ß√£o aprovada e aplicada!"}}if("rejeitar"===c.acao){const{error:o}=await r.from("solicitacoes_alteracao_dados").update({status:"rejeitada",motivo_rejeicao:c.motivo||"N√£o informado",aprovado_por:_.id,aprovado_em:(new Date).toISOString()}).eq("id",n);if(o)throw e({statusCode:500,message:o.message});return{success:!0,message:"Altera√ß√£o rejeitada!"}}throw e({statusCode:400,message:"A√ß√£o inv√°lida"})});export{r as default};
