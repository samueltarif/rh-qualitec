import{d as a}from"../../../_/nitro.mjs";import{s as o}from"../../../_/serverSupabaseClient.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"node:crypto";import"@supabase/ssr";import"../../../_/fetch-retry.mjs";const s=a(async a=>{const s=await o(a);try{console.log("üîß Iniciando fix de assinaturas fantasma...");const{data:a}=await s.from("information_schema.tables").select("table_name").eq("table_schema","public").eq("table_name","assinaturas_ponto").maybeSingle();if(a)console.log("‚úÖ Tabela assinaturas_ponto j√° existe");else{console.log("‚ùå Tabela assinaturas_ponto n√£o existe - criando...");const a="\n        CREATE TABLE IF NOT EXISTS assinaturas_ponto (\n          id UUID DEFAULT gen_random_uuid() PRIMARY KEY,\n          colaborador_id UUID NOT NULL REFERENCES colaboradores(id) ON DELETE CASCADE,\n          mes INTEGER NOT NULL CHECK (mes >= 1 AND mes <= 12),\n          ano INTEGER NOT NULL CHECK (ano >= 2020 AND ano <= 2030),\n          data_assinatura TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\n          total_dias INTEGER DEFAULT 0,\n          total_horas TEXT DEFAULT '0h00',\n          hash_assinatura TEXT,\n          ip_origem INET,\n          observacoes TEXT,\n          created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\n          updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\n          UNIQUE(colaborador_id, mes, ano)\n        );\n      ";await s.rpc("exec_sql",{sql:a}),console.log("‚úÖ Tabela assinaturas_ponto criada")}const{data:o}=await s.from("assinaturas_ponto").select("*");if(console.log(`üìä Total de assinaturas encontradas: ${(null==o?void 0:o.length)||0}`),o&&o.length>0){const{error:a}=await s.from("assinaturas_ponto").delete().or("hash_assinatura.is.null,hash_assinatura.eq.");a?console.error("Erro ao deletar assinaturas fantasma:",a):console.log("üßπ Assinaturas fantasma removidas")}const{data:t}=await s.from("app_users").select("id, email, auth_uid").or("auth_uid.is.null,auth_uid.eq.undefined,auth_uid.eq.");console.log(`üë• Usu√°rios sem auth_uid: ${(null==t?void 0:t.length)||0}`);const{data:e}=await s.from("registros_ponto").select("id, colaborador_id").is("colaborador_id",null);e&&e.length>0&&(await s.from("registros_ponto").delete().is("colaborador_id",null),console.log(`üßπ ${e.length} registros de ponto √≥rf√£os removidos`));const{data:n}=await s.from("assinaturas_ponto").select("*"),{data:r}=await s.from("colaboradores").select("id, nome").eq("status","Ativo");return console.log("=== VERIFICA√á√ÉO FINAL ==="),console.log(`Colaboradores ativos: ${(null==r?void 0:r.length)||0}`),console.log(`Assinaturas reais: ${(null==n?void 0:n.length)||0}`),{success:!0,message:"Fix de assinaturas fantasma executado com sucesso",dados:{colaboradores_ativos:(null==r?void 0:r.length)||0,assinaturas_reais:(null==n?void 0:n.length)||0,usuarios_sem_auth:(null==t?void 0:t.length)||0,pontos_orfaos_removidos:(null==e?void 0:e.length)||0}}}catch(a){return console.error("‚ùå Erro no fix:",a),{success:!1,error:a.message,details:a}}});export{s as default};
