import{d as a,a as o,c as t,s as r}from"../../../../_/nitro.mjs";import{s}from"../../../../_/serverSupabaseServiceRole.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"node:crypto";import"@supabase/functions-js";import"../../../../virtual/_commonjsHelpers.mjs";import"@supabase/postgrest-js";import"@supabase/realtime-js";import"@supabase/storage-js";import"@supabase/auth-js";import"../../../../_/fetch-retry.mjs";const e=a(async a=>{try{const e=s(a),n=o(a),i=n.mes?parseInt(n.mes):null,l=n.ano?parseInt(n.ano):null,d=n.colaborador_id;let p=e.from("assinaturas_ponto").select("\n        id,\n        colaborador_id,\n        mes,\n        ano,\n        data_assinatura,\n        ip_assinatura,\n        user_agent,\n        hash_assinatura,\n        total_dias,\n        total_horas,\n        observacoes,\n        created_at,\n        colaborador:colaboradores(\n          id,\n          nome,\n          cpf,\n          email,\n          matricula\n        )\n      ").order("data_assinatura",{ascending:!1});i&&(p=p.eq("mes",i)),l&&(p=p.eq("ano",l)),d&&(p=p.eq("colaborador_id",d));const{data:u,error:c}=await p;if(c)throw t({statusCode:500,statusMessage:"Erro ao buscar assinaturas"});const m=[["ID","Colaborador","CPF","Email","Matrícula","Período","Data Assinatura","IP","Total Dias","Total Horas","Hash Verificação","Observações","Criado em"].join(",")];null==u||u.forEach(a=>{var o,t,r,s;const e=[`"${a.id}"`,`"${(null==(o=a.colaborador)?void 0:o.nome)||"N/A"}"`,`"${(null==(t=a.colaborador)?void 0:t.cpf)||"N/A"}"`,`"${(null==(r=a.colaborador)?void 0:r.email)||"N/A"}"`,`"${(null==(s=a.colaborador)?void 0:s.matricula)||"N/A"}"`,`"${String(a.mes).padStart(2,"0")}/${a.ano}"`,`"${new Date(a.data_assinatura).toLocaleString("pt-BR")}"`,`"${a.ip_assinatura||"N/A"}"`,`"${a.total_dias||0}"`,`"${a.total_horas||"0:00"}"`,`"${a.hash_assinatura||"N/A"}"`,`"${a.observacoes||"N/A"}"`,`"${new Date(a.created_at).toLocaleString("pt-BR")}"`];m.push(e.join(","))}),m.push(""),m.push(`"Relatório gerado em:","${(new Date).toLocaleString("pt-BR")}"`),m.push(`"Total de registros:","${(null==u?void 0:u.length)||0}"`),i&&l&&m.push(`"Período filtrado:","${String(i).padStart(2,"0")}/${l}"`);const h=m.join("\n"),f=Buffer.from("\ufeff"+h,"utf8");return r(a,{"Content-Type":"text/csv; charset=utf-8","Content-Disposition":`attachment; filename="relatorio_assinaturas_${(new Date).toISOString().split("T")[0]}.csv"`,"Content-Length":f.byteLength.toString()}),f}catch(a){throw console.error("Erro ao gerar relatório:",a),t({statusCode:500,statusMessage:"Erro ao gerar relatório"})}});export{e as default};
