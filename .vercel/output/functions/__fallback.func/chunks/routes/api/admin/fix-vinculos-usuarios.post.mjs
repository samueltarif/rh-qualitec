import{d as o}from"../../../_/nitro.mjs";import{s as a}from"../../../_/serverSupabaseClient.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"node:crypto";import"@supabase/ssr";import"../../../_/fetch-retry.mjs";const e=o(async o=>{const e=await a(o);try{console.log("üîß Iniciando corre√ß√£o de v√≠nculos usu√°rios-colaboradores...");const{data:o}=await e.from("app_users").select("\n        id,\n        email,\n        nome,\n        auth_uid,\n        colaborador_id,\n        colaborador:colaboradores(nome, email_corporativo, email_pessoal)\n      ");console.log(`üìä Total de usu√°rios encontrados: ${(null==o?void 0:o.length)||0}`);const{data:a}=await e.from("colaboradores").select("id, nome, email_corporativo, email_pessoal").ilike("nome","%CLAUDIA%").single(),{data:r}=await e.from("colaboradores").select("id, nome, email_corporativo, email_pessoal").ilike("nome","%ENOA%").single();console.log("üë• Colaboradores encontrados:"),console.log("Claudia:",a),console.log("Enoa:",r);const{data:l}=await e.from("auth.users").select("id, email").eq("email","conta3secunndaria@gmail.com").single();if(console.log("üîë Usu√°rio auth:",l),a&&l){const{error:o}=await e.from("app_users").update({colaborador_id:a.id,nome:a.nome,email:"conta3secunndaria@gmail.com"}).eq("auth_uid",l.id);o?console.error("Erro ao atualizar v√≠nculo:",o):console.log("‚úÖ V√≠nculo corrigido: conta3secunndaria@gmail.com -> CLAUDIA")}const{data:s}=await e.from("app_users").select("colaborador_id").not("colaborador_id","is",null),n={};null==s||s.forEach(o=>{o.colaborador_id&&(n[o.colaborador_id]=(n[o.colaborador_id]||0)+1)});const i=Object.entries(n).filter(([o,a])=>a>1);console.log(`üîç Colaboradores com v√≠nculos duplicados: ${i.length}`);const{error:c}=await e.from("app_users").delete().is("colaborador_id",null);c||console.log("üßπ V√≠nculos √≥rf√£os removidos");const{data:t}=await e.from("app_users").select("\n        email,\n        nome,\n        auth_uid,\n        colaborador:colaboradores(nome, email_corporativo)\n      ").not("colaborador_id","is",null);return console.log("=== VERIFICA√á√ÉO FINAL ==="),null==t||t.forEach(o=>{var a,e,r;const l="conta3secunndaria@gmail.com"===o.email&&(null==(e=null==(a=o.colaborador)?void 0:a.nome)?void 0:e.includes("CLAUDIA"))?"‚úÖ CORRETO":"‚ö†Ô∏è VERIFICAR";console.log(`${o.email} -> ${null==(r=o.colaborador)?void 0:r.nome} ${l}`)}),{success:!0,message:"V√≠nculos corrigidos com sucesso",dados:{total_usuarios:(null==o?void 0:o.length)||0,claudia_encontrada:!!a,enoa_encontrada:!!r,auth_user_encontrado:!!l,vinculos_duplicados:i.length,vinculos_finais:(null==t?void 0:t.length)||0}}}catch(o){return console.error("‚ùå Erro na corre√ß√£o de v√≠nculos:",o),{success:!1,error:o.message,details:o}}});export{e as default};
