import{d as o}from"../../../_/nitro.mjs";import{s as r}from"../../../_/serverSupabaseServiceRole.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"node:crypto";import"@supabase/functions-js";import"../../../virtual/_commonjsHelpers.mjs";import"@supabase/postgrest-js";import"@supabase/realtime-js";import"@supabase/storage-js";import"@supabase/auth-js";import"../../../_/fetch-retry.mjs";const s=o(async o=>{const s=await r(o);try{const o=['DROP POLICY IF EXISTS "funcionarios_view_own_ponto" ON registros_ponto','DROP POLICY IF EXISTS "funcionarios_insert_own_ponto" ON registros_ponto','DROP POLICY IF EXISTS "funcionarios_update_own_ponto" ON registros_ponto','DROP POLICY IF EXISTS "admins_all_ponto" ON registros_ponto','DROP POLICY IF EXISTS "service_role_ponto" ON registros_ponto','DROP POLICY IF EXISTS "users_select_ponto" ON registros_ponto','DROP POLICY IF EXISTS "users_insert_ponto" ON registros_ponto','DROP POLICY IF EXISTS "users_update_ponto" ON registros_ponto','DROP POLICY IF EXISTS "users_delete_ponto" ON registros_ponto','DROP POLICY IF EXISTS "admins_rh_all_ponto" ON registros_ponto',"CREATE POLICY \"admins_rh_all_ponto\" ON registros_ponto\n        FOR ALL TO authenticated\n        USING (\n          EXISTS (\n            SELECT 1 FROM app_users\n            WHERE auth_uid = auth.uid()\n            AND role IN ('admin', 'rh', 'gestor')\n          )\n        )\n        WITH CHECK (\n          EXISTS (\n            SELECT 1 FROM app_users\n            WHERE auth_uid = auth.uid()\n            AND role IN ('admin', 'rh', 'gestor')\n          )\n        )",'CREATE POLICY "funcionarios_view_own_ponto" ON registros_ponto\n        FOR SELECT TO authenticated\n        USING (\n          EXISTS (\n            SELECT 1 FROM app_users\n            WHERE auth_uid = auth.uid()\n            AND colaborador_id = registros_ponto.colaborador_id\n          )\n        )','CREATE POLICY "funcionarios_insert_own_ponto" ON registros_ponto\n        FOR INSERT TO authenticated\n        WITH CHECK (\n          EXISTS (\n            SELECT 1 FROM app_users\n            WHERE auth_uid = auth.uid()\n            AND colaborador_id = registros_ponto.colaborador_id\n          )\n        )','CREATE POLICY "service_role_ponto" ON registros_ponto\n        FOR ALL TO service_role\n        USING (true)\n        WITH CHECK (true)',"ALTER TABLE registros_ponto ENABLE ROW LEVEL SECURITY"],r=[];for(const t of o)try{const{error:o}=await s.rpc("exec_sql",{sql:t});o?r.push({query:t.substring(0,50),error:o.message}):r.push({query:t.substring(0,50),success:!0})}catch(o){r.push({query:t.substring(0,50),error:o.message})}return{success:!0,results:r}}catch(o){return console.error("Erro ao executar fix:",o),{success:!1,error:o.message}}});export{s as default};
