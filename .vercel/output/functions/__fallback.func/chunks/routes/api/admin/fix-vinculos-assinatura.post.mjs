import{d as o}from"../../../_/nitro.mjs";import{s as a}from"../../../_/serverSupabaseClient.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"node:crypto";import"@supabase/ssr";import"../../../_/fetch-retry.mjs";const e=o(async o=>{try{const e=await a(o);console.log("üîß Iniciando corre√ß√£o de v√≠nculos para assinatura digital...");let r=0;const{data:t}=await e.from("colaboradores").select("id, nome, email_corporativo").is("auth_uid",null).eq("status","Ativo").not("email_corporativo","is",null);if(t)for(const o of t){const{data:a}=await e.from("app_users").select("auth_uid").eq("email",o.email_corporativo).single();if(a){const{error:t}=await e.from("colaboradores").update({auth_uid:a.auth_uid}).eq("id",o.id);t||(console.log(`‚úÖ Vinculado por email: ${o.nome}`),r++)}}const{data:s}=await e.from("colaboradores").select("id, nome").is("auth_uid",null).eq("status","Ativo");if(s)for(const o of s){const{data:a}=await e.from("app_users").select("auth_uid").ilike("nome",o.nome).single();if(a){const{error:t}=await e.from("colaboradores").update({auth_uid:a.auth_uid}).eq("id",o.id);t||(console.log(`‚úÖ Vinculado por nome: ${o.nome}`),r++)}}const{data:i}=await e.from("colaboradores").select("id, nome, email_corporativo").is("auth_uid",null).eq("status","Ativo");return console.log(`üéØ Corre√ß√£o conclu√≠da: ${r} v√≠nculos corrigidos`),{success:!0,message:`${r} v√≠nculos corrigidos com sucesso!`,resultado:{corrigidos:r,ainda_sem_vinculo:(null==i?void 0:i.length)||0,detalhes_sem_vinculo:i||[]}}}catch(o){return console.error("‚ùå Erro ao corrigir v√≠nculos:",o),{success:!1,error:o.message}}});export{e as default};
