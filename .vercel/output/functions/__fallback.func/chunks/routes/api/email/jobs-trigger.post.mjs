import{u as e,d as o,b as t,c as a}from"../../../_/nitro.mjs";import{getEmailService as r,EmailService as s}from"../../../_/email-service.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"node:crypto";async function executarTodosOsJobs(){console.log("üöÄ Executando todos os jobs de e-mail..."),await async function(){try{console.log("üéÇ Iniciando job de anivers√°rios...");const o=e(),t=o.public.supabaseUrl,a=o.supabaseServiceKey;if(!a)return void console.warn("‚ö†Ô∏è Service key n√£o configurada");const n={Authorization:`Bearer ${a}`,apikey:a},i=await $fetch(`${t}/rest/v1/empresa?select=id&limit=1`,{headers:n});if(!i||0===i.length)return;const c=await $fetch(`${t}/rest/v1/configuracoes_comunicacao?empresa_id=eq.${i[0].id}&select=*`,{headers:n});if(!c||0===c.length||!c[0].notificar_aniversario)return void console.log("‚ÑπÔ∏è Notifica√ß√£o de anivers√°rio desativada");const d=c[0].dias_alerta_aniversario||3,l=new Date,m=(new Date(l),new Date(l));m.setDate(m.getDate()+d);const u=await $fetch(`${t}/rest/v1/colaboradores?empresa_id=eq.${i[0].id}&select=*`,{headers:n});if(!u)return;const p=u.filter(e=>{if(!e.data_nascimento)return!1;const o=new Date(e.data_nascimento),t=`${String(o.getMonth()+1).padStart(2,"0")}-${String(o.getDate()).padStart(2,"0")}`,a=`${String(l.getMonth()+1).padStart(2,"0")}-${String(l.getDate()).padStart(2,"0")}`,r=`${String(m.getMonth()+1).padStart(2,"0")}-${String(m.getDate()).padStart(2,"0")}`;return t>=a&&t<=r});console.log(`üìß Encontrados ${p.length} aniversariantes`);const f=await $fetch(`${t}/rest/v1/templates_email?empresa_id=eq.${i[0].id}&codigo=eq.aniversario&select=*`,{headers:n});if(!f||0===f.length)return void console.warn("‚ö†Ô∏è Template de anivers√°rio n√£o encontrado");const h=await r();let g=0;for(const e of p){if(!e.email)continue;const o={nome_colaborador:e.nome,nome_empresa:i[0].razao_social||"Empresa"},a=s.processarTemplate(f[0].assunto,o),r=s.processarTemplate(f[0].corpo_html,o);await h.enviar({destinatario:e.email,assunto:a,corpo_html:r})&&(g++,await $fetch(`${t}/rest/v1/historico_emails`,{method:"POST",headers:{...n,"Content-Type":"application/json"},body:{empresa_id:i[0].id,template_id:f[0].id,destinatario_email:e.email,destinatario_nome:e.nome,destinatario_tipo:"colaborador",destinatario_id:e.id,assunto:a,corpo_html:r,status:"enviado",enviado_em:(new Date).toISOString(),contexto:"aniversario",contexto_id:e.id}}).catch(e=>console.error("Erro ao registrar hist√≥rico:",e)))}console.log(`‚úÖ ${g} e-mails de anivers√°rio enviados`)}catch(e){console.error("‚ùå Erro no job de anivers√°rios:",e)}}(),await async function(){try{console.log("üèñÔ∏è Iniciando job de f√©rias vencendo...");const o=e(),t=o.public.supabaseUrl,a=o.supabaseServiceKey;if(!a)return;const r={Authorization:`Bearer ${a}`,apikey:a},s=await $fetch(`${t}/rest/v1/empresa?select=id&limit=1`,{headers:r});if(!s||0===s.length)return;const n=await $fetch(`${t}/rest/v1/configuracoes_comunicacao?empresa_id=eq.${s[0].id}&select=*`,{headers:r});if(!n||0===n.length||!n[0].notificar_ferias_vencendo)return;n[0].dias_alerta_ferias,console.log("‚úÖ Job de f√©rias vencendo conclu√≠do")}catch(e){console.error("‚ùå Erro no job de f√©rias vencendo:",e)}}(),await async function(){try{console.log("üìÑ Iniciando job de documentos vencendo...");const o=e(),t=o.public.supabaseUrl,a=o.supabaseServiceKey;if(!a)return;const r={Authorization:`Bearer ${a}`,apikey:a},s=await $fetch(`${t}/rest/v1/empresa?select=id&limit=1`,{headers:r});if(!s||0===s.length)return;const n=await $fetch(`${t}/rest/v1/configuracoes_comunicacao?empresa_id=eq.${s[0].id}&select=*`,{headers:r});if(!n||0===n.length||!n[0].notificar_documentos_vencendo)return;n[0].dias_alerta_documentos,console.log("‚úÖ Job de documentos vencendo conclu√≠do")}catch(e){console.error("‚ùå Erro no job de documentos vencendo:",e)}}(),console.log("‚úÖ Todos os jobs conclu√≠dos")}const n=o(async o=>{try{const r=t(o,"authorization"),s=e().emailJobsToken||"seu-token-secreto-aqui";if(!r||!r.includes(s))throw a({statusCode:401,message:"Token inv√°lido"});return console.log("üöÄ Disparando jobs de e-mail..."),await executarTodosOsJobs(),{success:!0,message:"Jobs executados com sucesso"}}catch(e){throw console.error("‚ùå Erro ao executar jobs:",e),a({statusCode:500,message:e.message||"Erro ao executar jobs"})}});export{n as default};
