import{d as e,u as t,c as a}from"../../../_/nitro.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"node:crypto";const s=e(async()=>{try{const e=t(),s=e.public.supabaseUrl,r=e.supabaseServiceKey;if(!r)throw a({statusCode:500,message:"Service key nÃ£o configurada"});const o={Authorization:`Bearer ${r}`,apikey:r,Prefer:"count=exact"},i=await $fetch(`${s}/rest/v1/empresa?select=id&limit=1`,{headers:o});if(!i||0===i.length)return{totalEnviados:0,totalPendentes:0,totalFalhas:0,taxaAbertura:"0.0",enviadosHoje:0,totalTemplates:0};const n=i[0].id,l=await $fetch(`${s}/rest/v1/historico_emails?empresa_id=eq.${n}&status=eq.enviado&select=count`,{headers:o}),c=await $fetch(`${s}/rest/v1/fila_emails?empresa_id=eq.${n}&status=eq.pendente&select=count`,{headers:o}),d=await $fetch(`${s}/rest/v1/historico_emails?empresa_id=eq.${n}&status=eq.falha&select=count`,{headers:o}),h=await $fetch(`${s}/rest/v1/historico_emails?empresa_id=eq.${n}&status=eq.enviado&aberto_em=not.is.null&select=count`,{headers:o}),m=new Date;m.setHours(0,0,0,0);const u=await $fetch(`${s}/rest/v1/historico_emails?empresa_id=eq.${n}&status=eq.enviado&enviado_em=gte.${m.toISOString()}&select=count`,{headers:o}),p=await $fetch(`${s}/rest/v1/templates_email?empresa_id=eq.${n}&ativo=eq.true&select=count`,{headers:o}),$=Array.isArray(l)?l.length:0,v=Array.isArray(h)?h.length:0,f=$>0?(v/$*100).toFixed(1):"0.0";return{totalEnviados:$,totalPendentes:Array.isArray(c)?c.length:0,totalFalhas:Array.isArray(d)?d.length:0,taxaAbertura:f,enviadosHoje:Array.isArray(u)?u.length:0,totalTemplates:Array.isArray(p)?p.length:0}}catch(e){return console.error("[GET STATS] Erro:",e.message||e),{totalEnviados:0,totalPendentes:0,totalFalhas:0,taxaAbertura:"0.0",enviadosHoje:0,totalTemplates:0}}});export{s as default};
