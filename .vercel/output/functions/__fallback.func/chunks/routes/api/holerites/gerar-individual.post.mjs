import{d as o,r as a,c as e}from"../../../_/nitro.mjs";import{s as r}from"../../../_/serverSupabaseClient.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"node:crypto";import"@supabase/ssr";import"../../../_/fetch-retry.mjs";const t=o(async o=>{var t,i,s,l;const n=await r(o),d=await a(o),{colaborador_id:c,mes:m,ano:u}=d;if(!c||!m||!u)throw e({statusCode:400,message:"Colaborador, mÃªs e ano sÃ£o obrigatÃ³rios"});try{const{data:o,error:a}=await n.from("colaboradores").select("\n        *,\n        cargo:cargos(nome),\n        departamento:departamentos!colaboradores_departamento_id_fkey(nome)\n      ").eq("id",c).single();if(a||!o)throw console.error("âŒ Erro ao buscar colaborador:",a),e({statusCode:404,message:"Colaborador nÃ£o encontrado"});console.log("âœ… Colaborador encontrado:",o.nome);const r=o,d=r.salario||0,calcularIRRF=(o,a,e)=>{const r=o-a-189.59*e;if(r<=2259.2)return 0;const t=[{limite:2259.2,aliquota:0,deducao:0},{limite:2826.65,aliquota:.075,deducao:169.44},{limite:3751.05,aliquota:.15,deducao:381.44},{limite:4664.68,aliquota:.225,deducao:662.77},{limite:1/0,aliquota:.275,deducao:896}];for(const o of t)if(r<=o.limite)return Math.max(0,r*o.aliquota-o.deducao);return 0},g=(o=>{const a=[{limite:1412,aliquota:.075},{limite:2666.68,aliquota:.09},{limite:4000.03,aliquota:.12},{limite:7786.02,aliquota:.14}];let e=0,r=o;for(let o=0;o<a.length;o++){const t=o>0?a[o-1].limite:0,i=a[o].limite,s=Math.min(r,i-t);if(s>0&&(e+=s*a[o].aliquota,r-=s),r<=0)break}return Math.min(e,908.85)})(d),f=calcularIRRF(d,g,r.dependentes||0),p=.08*d,b=g+f,_=d-b,{data:h,error:q}=await n.from("holerites").select("id").eq("colaborador_id",c).eq("mes",m).eq("ano",u).eq("tipo","mensal").maybeSingle();if(q&&console.error("âš ï¸ Erro ao buscar holerite existente:",q),h){const a=h,r=o,s={nome_colaborador:r.nome||"NÃ£o informado",cpf:r.cpf||"",cargo:(null==(t=r.cargo)?void 0:t.nome)||"NÃ£o informado",departamento:(null==(i=r.departamento)?void 0:i.nome)||"NÃ£o informado",salario_base:d,total_proventos:d,salario_bruto:d,inss:g,irrf:f,fgts:p,total_descontos:b,salario_liquido:_,banco:r.banco||null,agencia:r.agencia||null,conta:r.conta||null,data_admissao:r.data_admissao||null,observacoes:`SalÃ¡rio Mensal - ${m}/${u}`,gerado_em:(new Date).toISOString()};console.log("ðŸ“ Atualizando holerite existente:",a.id);const{error:l}=await n.from("holerites").update(s).eq("id",a.id);if(l)throw console.error("âŒ Erro ao atualizar holerite:",l),e({statusCode:500,message:`Erro ao atualizar holerite: ${l.message}`});return console.log("âœ… Holerite atualizado com sucesso"),{success:!0,message:"Holerite atualizado com sucesso",holerite_id:a.id,email:r.email}}{const a=o,r={colaborador_id:c,mes:m,ano:u,tipo:"mensal",nome_colaborador:a.nome||"NÃ£o informado",cpf:a.cpf||"",cargo:(null==(s=a.cargo)?void 0:s.nome)||"NÃ£o informado",departamento:(null==(l=a.departamento)?void 0:l.nome)||"NÃ£o informado",salario_base:d,total_proventos:d,salario_bruto:d,inss:g,irrf:f,fgts:p,total_descontos:b,salario_liquido:_,banco:a.banco||null,agencia:a.agencia||null,conta:a.conta||null,data_admissao:a.data_admissao||null,observacoes:`SalÃ¡rio Mensal - ${m}/${u}`,status:"gerado",gerado_em:(new Date).toISOString()};console.log("ðŸ“ Criando novo holerite com dados:",{nome:r.nome_colaborador,cpf:r.cpf,cargo:r.cargo,salario_bruto:r.salario_bruto});const{data:t,error:i}=await n.from("holerites").insert(r).select().single();if(i)throw console.error("âŒ Erro ao inserir holerite:",i),e({statusCode:500,message:`Erro ao criar holerite: ${i.message}`});const h=t;return console.log("âœ… Holerite criado com sucesso:",h.id),{success:!0,message:"Holerite gerado com sucesso",holerite_id:h.id,email:a.email}}}catch(o){throw console.error("âŒ Erro ao gerar holerite individual:",o),e({statusCode:o.statusCode||500,message:o.message||"Erro ao gerar holerite"})}});export{t as default};
