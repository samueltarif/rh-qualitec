import{d as o,r as e,c as a}from"../../../_/nitro.mjs";import s from"nodemailer";import{s as n}from"../../../_/serverSupabaseClient.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"node:crypto";import"@supabase/ssr";import"../../../_/fetch-retry.mjs";const r=o(async o=>{const r=await n(o),t=await e(o),{colaborador_id:i,mes:l,ano:d,dados_temporarios:p}=t;if(!i||!l||!d)throw a({statusCode:400,message:"Colaborador, m칡s e ano s칚o obrigat칩rios"});try{const{data:o,error:e}=await r.from("colaboradores").select("nome, email_corporativo, email_pessoal").eq("id",i).single();if(e||!o)throw a({statusCode:404,message:"Colaborador n칚o encontrado"});const n=o,t=n.email_corporativo||n.email_pessoal;if(!t)throw a({statusCode:400,message:"Colaborador n칚o possui email cadastrado"});let c;if(p)console.log("游닎 Usando dados tempor치rios para envio de email"),c=p;else{console.log("游닎 Buscando holerite salvo no banco");const{data:o,error:e}=await r.from("holerites").select("*").eq("colaborador_id",i).eq("mes",l).eq("ano",d).single();if(e||!o)throw a({statusCode:404,message:"Holerite n칚o encontrado. Gere o holerite primeiro ou forne칞a os dados tempor치rios."});c=o}const{data:m}=await r.from("config_email_smtp").select("*").single(),u=m;let h,v="Sistema RH Qualitec",g=process.env.GMAIL_EMAIL||"qualitecinstrumentosdemedicao@gmail.com";if(u&&u.smtp_host)h={host:u.smtp_host,port:u.smtp_port,secure:u.smtp_secure,auth:{user:u.smtp_user,pass:u.smtp_password}},v=u.remetente_nome||v,g=u.remetente_email||g;else{const o=process.env.GMAIL_EMAIL,e=process.env.GMAIL_APP_PASSWORD;if(!o||!e)throw a({statusCode:400,message:"Configura칞칚o de email n칚o encontrada. Configure o SMTP ou as vari치veis de ambiente GMAIL_EMAIL e GMAIL_APP_PASSWORD."});h={host:"smtp.gmail.com",port:587,secure:!1,auth:{user:o,pass:e}}}const b=s.createTransport(h),formatCurrency=o=>new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(o||0),nomeMes=o=>["Janeiro","Fevereiro","Mar칞o","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"][o-1],calcularTotalProventos=o=>{let e=o.salario_base||0;e+=o.valor_horas_extras_50||0,e+=o.valor_horas_extras_100||0,e+=o.bonus||0,e+=o.comissoes||0,e+=o.adicional_insalubridade||0,e+=o.adicional_periculosidade||0,e+=o.adicional_noturno||0,e+=o.outros_proventos||0;return(o.itens_personalizados||[]).filter(o=>"provento"===o.tipo).forEach(o=>{e+=o.valor||0}),e},calcularTotalDescontos=o=>{let e=0;e+=o.inss||0,e+=o.irrf||0,e+=o.adiantamento||0,e+=o.emprestimos||0,e+=o.faltas||0,e+=o.atrasos||0,e+=o.outros_descontos||0,e+=o.plano_saude||0,e+=o.plano_odontologico||0,e+=o.seguro_vida||0,e+=o.auxilio_creche||0,e+=o.auxilio_educacao||0,e+=o.auxilio_combustivel||0,e+=o.outros_beneficios||0;return(o.itens_personalizados||[]).filter(o=>"desconto"===o.tipo).forEach(o=>{e+=o.valor||0}),e},calcularSalarioLiquido=o=>calcularTotalProventos(o)-calcularTotalDescontos(o),_=calcularTotalProventos(c),f=calcularTotalDescontos(c),x=calcularSalarioLiquido(c),y=`\n      <!DOCTYPE html>\n      <html>\n      <head>\n        <meta charset="UTF-8">\n        <style>\n          body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }\n          .container { max-width: 600px; margin: 0 auto; padding: 20px; }\n          .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; border-radius: 10px 10px 0 0; }\n          .content { background: #f9f9f9; padding: 30px; border-radius: 0 0 10px 10px; }\n          .holerite-box { background: white; padding: 20px; border-radius: 8px; margin: 20px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }\n          .valor-destaque { font-size: 32px; font-weight: bold; color: #667eea; margin: 20px 0; }\n          .linha { display: flex; justify-between; padding: 10px 0; border-bottom: 1px solid #eee; }\n          .linha:last-child { border-bottom: none; }\n          .label { color: #666; }\n          .valor { font-weight: bold; }\n          .footer { text-align: center; color: #999; font-size: 12px; margin-top: 30px; }\n        </style>\n      </head>\n      <body>\n        <div class="container">\n          <div class="header">\n            <h1>游눯 Holerite Dispon칤vel</h1>\n            <p>${nomeMes(l)}/${d}</p>\n          </div>\n          <div class="content">\n            <p>Ol치, <strong>${n.nome}</strong>!</p>\n            <p>Seu holerite referente a <strong>${nomeMes(l)}/${d}</strong> est치 dispon칤vel.</p>\n            \n            <div class="holerite-box">\n              <h3 style="margin-top: 0; color: #667eea;">Resumo do Pagamento</h3>\n              \n              <div class="linha">\n                <span class="label">Sal치rio Base:</span>\n                <span class="valor">${formatCurrency(c.salario_base)}</span>\n              </div>\n              \n              <div class="linha">\n                <span class="label">Total Proventos:</span>\n                <span class="valor" style="color: green;">${formatCurrency(_)}</span>\n              </div>\n              \n              <div class="linha">\n                <span class="label">INSS:</span>\n                <span class="valor" style="color: #e74c3c;">-${formatCurrency(c.inss)}</span>\n              </div>\n              \n              <div class="linha">\n                <span class="label">IRRF:</span>\n                <span class="valor" style="color: #e74c3c;">-${formatCurrency(c.irrf)}</span>\n              </div>\n              \n              <div class="linha">\n                <span class="label">Total Descontos:</span>\n                <span class="valor" style="color: #e74c3c;">-${formatCurrency(f)}</span>\n              </div>\n              \n              <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 2px solid #667eea;">\n                <p style="margin: 0; color: #666;">Valor L칤quido a Receber</p>\n                <div class="valor-destaque">${formatCurrency(x)}</div>\n              </div>\n            </div>\n            \n            <p style="margin-top: 30px;">Para visualizar o holerite completo, acesse o portal do funcion치rio.</p>\n            \n            <div style="text-align: center; margin-top: 30px;">\n              <a href="${process.env.NUXT_PUBLIC_SITE_URL||"http://localhost:3000"}/employee" \n                 style="background: #667eea; color: white; padding: 15px 30px; text-decoration: none; border-radius: 5px; display: inline-block;">\n                Acessar Portal\n              </a>\n            </div>\n          </div>\n          \n          <div class="footer">\n            <p>Este 칠 um email autom치tico, por favor n칚o responda.</p>\n            <p>춸 ${(new Date).getFullYear()} - Sistema de RH</p>\n          </div>\n        </div>\n      </body>\n      </html>\n    `;return await b.sendMail({from:`"${v}" <${g}>`,to:t,subject:`Holerite ${nomeMes(l)}/${d} - ${n.nome}`,html:y}),{success:!0,message:`Holerite enviado para ${t}`,email:t}}catch(o){throw console.error("Erro ao enviar holerite por email:",o),a({statusCode:o.statusCode||500,message:o.message||"Erro ao enviar email"})}});export{r as default};
