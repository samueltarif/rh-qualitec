import{d as o,c as a,r as e}from"../../../_/nitro.mjs";import{s}from"../../../_/serverSupabaseClient.mjs";import{s as r}from"../../../_/serverSupabaseUser.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"node:crypto";import"@supabase/ssr";import"../../../_/fetch-retry.mjs";const t=o(async o=>{var t,i;try{const n=await s(o),l=await r(o),d=(null==l?void 0:l.sub)||(null==l?void 0:l.id);if(!l||!d)throw a({statusCode:401,message:"N√£o autenticado"});const c=await e(o),{colaborador_id:_,mes:m,ano:u,edicao:p,resumo:h,itens_personalizados:f}=c;if(!_||!m||!u)throw a({statusCode:400,message:"Colaborador, m√™s e ano s√£o obrigat√≥rios"});console.log("üíæ Salvando edi√ß√£o da folha:",{colaborador_id:_,mes:m,ano:u,itens_personalizados:(null==f?void 0:f.length)||0});const{data:g,error:b}=await n.from("colaboradores").select("\n        *,\n        cargo:cargos(nome),\n        departamento:departamentos!colaboradores_departamento_id_fkey(nome)\n      ").eq("id",_).single();if(b||!g)throw a({statusCode:404,message:"Colaborador n√£o encontrado"});const v=g,{data:x}=await n.from("holerites").select("id").eq("colaborador_id",_).eq("mes",m).eq("ano",u).eq("tipo","mensal").maybeSingle(),w={colaborador_id:_,mes:m,ano:u,tipo:"mensal",nome_colaborador:v.nome||"N√£o informado",cpf:v.cpf||"",cargo:(null==(t=v.cargo)?void 0:t.nome)||"N√£o informado",departamento:(null==(i=v.departamento)?void 0:i.nome)||"N√£o informado",salario_base:h.salario_base||0,horas_extras_50:p.horas_extras_50||0,horas_extras_100:p.horas_extras_100||0,valor_horas_extras_50:p.horas_extras_50?h.salario_base/220*p.horas_extras_50*1.5:0,valor_horas_extras_100:p.horas_extras_100?h.salario_base/220*p.horas_extras_100*2:0,bonus:p.bonus||0,comissoes:p.comissoes||0,adicional_noturno:p.adicional_noturno||0,adicional_insalubridade:p.adicional_insalubridade||0,adicional_periculosidade:p.adicional_periculosidade||0,outros_proventos:p.outros_proventos||0,descricao_outros_proventos:p.descricao_outros_proventos||null,total_proventos:h.total_proventos||0,salario_bruto:h.salario_bruto||0,inss:h.inss||0,irrf:h.irrf||0,adiantamento:p.adiantamento||0,emprestimos:p.emprestimos||0,faltas:p.faltas_horas||0,atrasos:p.atrasos_horas||0,outros_descontos:p.outros_descontos||0,descricao_outros_descontos:p.descricao_outros_descontos||null,vale_transporte:p.vale_transporte||0,vale_refeicao:p.vale_refeicao||0,vale_alimentacao:p.vale_alimentacao||0,plano_saude:p.plano_saude||0,plano_odontologico:p.plano_odontologico||0,seguro_vida:p.seguro_vida||0,auxilio_creche:p.auxilio_creche||0,auxilio_educacao:p.auxilio_educacao||0,auxilio_combustivel:p.auxilio_combustivel||0,outros_beneficios:p.outros_beneficios||0,total_descontos:h.total_descontos||0,salario_liquido:h.salario_liquido||0,fgts:h.fgts||0,banco:v.banco||null,agencia:v.agencia||null,conta:v.conta||null,data_admissao:v.data_admissao||null,itens_personalizados:f||[],observacoes:`Sal√°rio Mensal - ${m}/${u}`,status:"gerado",gerado_em:(new Date).toISOString()};if(console.log("üìù Dados do holerite:",{...w,itens_personalizados:w.itens_personalizados.length}),x){const{error:o}=await n.from("holerites").update(w).eq("id",x.id);if(o)throw console.error("‚ùå Erro ao atualizar holerite:",o),a({statusCode:500,message:`Erro ao atualizar holerite: ${o.message}`});return console.log("‚úÖ Holerite atualizado com sucesso"),{success:!0,message:"Holerite atualizado com sucesso",holerite_id:x.id}}{const{data:o,error:e}=await n.from("holerites").insert(w).select().single();if(e)throw console.error("‚ùå Erro ao criar holerite:",e),a({statusCode:500,message:`Erro ao criar holerite: ${e.message}`});return console.log("‚úÖ Holerite criado com sucesso"),{success:!0,message:"Holerite criado com sucesso",holerite_id:o.id}}}catch(o){if(console.error("‚ùå Erro ao salvar edi√ß√£o:",o),o.statusCode)throw o;throw a({statusCode:500,message:o.message||"Erro ao salvar edi√ß√£o"})}});export{t as default};
