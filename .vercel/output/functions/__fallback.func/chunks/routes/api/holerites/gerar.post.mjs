import{d as o,c as e,r as a}from"../../../_/nitro.mjs";import{c as r}from"../../../_/irrf-lei-15270-2025.mjs";import{s as t}from"../../../_/serverSupabaseClient.mjs";import{s}from"../../../_/serverSupabaseUser.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"node:crypto";import"@supabase/ssr";import"../../../_/fetch-retry.mjs";const n=o(async o=>{var n,l;const i=Date.now(),{safeVercelOperation:d,logVercelInfo:c}=await import("../../../_/vercel-diagnostics.mjs");c("Iniciando geraÃ§Ã£o de holerites");try{const d=await t(o),m=await s(o),g=(null==m?void 0:m.sub)||(null==m?void 0:m.id);if(console.log("ğŸ” [GERAR HOLERITES] User ID:",g),!m||!g)throw e({statusCode:401,message:"NÃ£o autenticado. FaÃ§a logout e login novamente."});const{data:u,error:p}=await d.from("app_users").select("id, role, email").eq("auth_uid",g).single();if(p||!u)throw console.error("[GERAR HOLERITES] Erro ao buscar usuÃ¡rio:",p),e({statusCode:403,message:"UsuÃ¡rio nÃ£o encontrado no sistema"});if("admin"!==u.role)throw e({statusCode:403,message:`Acesso negado. Seu perfil Ã©: ${u.role}. NecessÃ¡rio: admin`});console.log("âœ… [GERAR HOLERITES] UsuÃ¡rio autorizado:",u.email);const h=await a(o).catch(()=>{throw e({statusCode:400,message:"Corpo da requisiÃ§Ã£o invÃ¡lido"})}),{mes:f,ano:$,colaborador_ids:b}=h;if(!f||!$)throw e({statusCode:400,message:"MÃªs e ano sÃ£o obrigatÃ³rios"});const w=parseInt(f),_=parseInt($);if(isNaN(w)||w<1||w>12)throw e({statusCode:400,message:"MÃªs invÃ¡lido. Deve ser entre 1 e 12."});if(isNaN(_)||_<2020||_>2100)throw e({statusCode:400,message:"Ano invÃ¡lido. Deve ser entre 2020 e 2100."});const{data:E}=await d.from("parametros_folha").select("*").single();if(!E)throw new Error("ParÃ¢metros da folha nÃ£o configurados");console.log("ğŸ” Buscando colaboradores..."),console.log("   IDs especÃ­ficos:",b);let S=d.from("colaboradores").select("\n        *,\n        cargo:cargos(nome),\n        departamento:departamentos!colaboradores_departamento_id_fkey(nome)\n      ");b&&b.length>0&&(S=S.in("id",b));const{data:R,error:v}=await S;if(console.log("ğŸ“‹ Colaboradores encontrados:",(null==R?void 0:R.length)||0),R&&R.length>0&&R.forEach(o=>{console.log(`   - ${o.nome}: salÃ¡rio = ${o.salario}`)}),v)throw console.error("âŒ Erro ao buscar colaboradores:",v),v;if(!R||0===R.length)throw new Error("Nenhum colaborador encontrado");const D=[],I=[],q=5,A=[];for(let o=0;o<R.length;o+=q)A.push(R.slice(o,o+q));c(`Processando ${R.length} colaboradores em ${A.length} lotes`);for(let o=0;o<A.length;o++){const e=A[o];c(`Processando lote ${o+1}/${A.length} (${e.length} colaboradores)`);const a=Date.now()-i;if(a>45e3){console.warn("âš ï¸ Timeout preventivo - interrompendo processamento"),I.push({colaborador:"Sistema",erro:`Timeout preventivo apÃ³s ${Math.round(a/1e3)}s. Processados ${D.length} de ${R.length} colaboradores.`});break}for(const o of e)try{console.log(`\n${"=".repeat(60)}`),console.log("ğŸ“‹ Processando colaborador:",o.nome),console.log("ğŸ’° SalÃ¡rio do colaborador:",o.salario),console.log(`${"=".repeat(60)}`);const e=parseFloat(o.salario||0);if(!e||e<=0){console.warn(`âš ï¸ Colaborador ${o.nome} sem salÃ¡rio definido`),I.push({colaborador:o.nome,erro:"Colaborador sem salÃ¡rio definido. Configure o salÃ¡rio antes de gerar o holerite."});continue}console.log("âœ… SalÃ¡rio base vÃ¡lido:",e);const a=[{limite:1412,aliquota:.075},{limite:2666.68,aliquota:.09},{limite:4000.03,aliquota:.12},{limite:7786.02,aliquota:.14}],t=908.85;let s=0,i=e;for(let o=0;o<a.length;o++){const e=o>0?a[o-1].limite:0,r=a[o].limite,t=Math.min(i,r-e);if(t>0&&(s+=t*a[o].aliquota,i-=t),i<=0)break}s=Math.min(s,t);const c=o.dependentes||0,m=r(e,s,c,e).valor,g=.08*e;let p=parseInt(f)-1,h=parseInt($);0===p&&(p=12,h-=1);const b=p.toString().padStart(2,"0"),{data:w}=await d.from("holerites").select("salario_liquido, valor_adiantamento").eq("colaborador_id",o.id).eq("mes",b).eq("ano",h).eq("tipo","adiantamento").maybeSingle(),_=w?parseFloat(w.salario_liquido||w.valor_adiantamento||0):0;_>0&&console.log(`   ğŸ’³ Adiantamento do mÃªs anterior (${b}/${h}): R$ ${_.toFixed(2)}`);const S=calcularDiasTrabalhados(o.data_admissao,f,$),R=e,v=s+m+_,q=R-v,{data:A}=await d.from("holerites").select("id").eq("colaborador_id",o.id).eq("mes",f).eq("ano",$).eq("tipo","mensal").maybeSingle();let C=`SalÃ¡rio Mensal - ${f}/${$}`;_>0&&(C+=`\n\nğŸ’³ ADIANTAMENTO DESCONTADO:\nValor pago em ${E.adiantamento_dia_pagamento||20}/${b}/${h}: R$ ${_.toFixed(2)}`);const N={colaborador_id:o.id,mes:f,ano:$,tipo:"mensal",nome_colaborador:o.nome||"NÃ£o informado",cpf:o.cpf||"",cargo:(null==(n=o.cargo)?void 0:n.nome)||"NÃ£o informado",departamento:(null==(l=o.departamento)?void 0:l.nome)||"NÃ£o informado",salario_base:e,total_proventos:R,inss:s,irrf:m,total_descontos:v,salario_bruto:R,salario_liquido:q,fgts:g,valor_adiantamento:_,dias_trabalhados:S,banco:o.banco||null,agencia:o.agencia||null,conta:o.conta||null,data_admissao:o.data_admissao||null,observacoes:C,status:"gerado",gerado_por:u.id,gerado_em:(new Date).toISOString()};let T;if(A){const{data:o,error:e}=await d.from("holerites").update(N).eq("id",A.id).select().single();if(e)throw e;T=o}else{const{data:o,error:e}=await d.from("holerites").insert(N).select().single();if(e)throw e;T=o}D.push(T),console.log(`âœ… Holerite MENSAL gerado para ${o.nome}`),console.log(`   ğŸ’° SalÃ¡rio Bruto: R$ ${R.toFixed(2)}`),console.log(`   ğŸ’³ INSS: R$ ${s.toFixed(2)}`),console.log(`   ğŸ’³ IRRF: R$ ${m.toFixed(2)}`),_>0&&console.log(`   ğŸ’³ Adiantamento: R$ ${_.toFixed(2)}`),console.log(`   ğŸ’° SalÃ¡rio LÃ­quido: R$ ${q.toFixed(2)}`)}catch(e){console.error(`âŒ Erro ao gerar holerite para ${o.nome}:`,e.message),I.push({colaborador:o.nome,erro:e.message})}o<A.length-1&&await new Promise(o=>setTimeout(o,100))}console.log(`\n${"=".repeat(60)}`),console.log("ğŸ“Š RESUMO DA GERAÃ‡ÃƒO DE HOLERITES MENSAIS"),console.log(`${"=".repeat(60)}`),console.log(`âœ… Holerites gerados: ${D.length}`),console.log(`âŒ Erros: ${I.length}`),console.log(`ğŸ“… PerÃ­odo: ${f}/${$}`),console.log("ğŸ“‹ Tipo: SALÃRIO MENSAL"),I.length>0&&(console.log("\nâš ï¸ Detalhes dos erros:"),I.forEach(o=>console.log(`   - ${o.colaborador}: ${o.erro}`))),console.log(`${"=".repeat(60)}\n`);const C=Date.now()-i;return console.log(`âœ… [GERAR HOLERITES] ConcluÃ­do em ${C}ms - ${D.length} gerados, ${I.length} erros`),{success:!0,data:{total_gerados:D.length,total_erros:I.length,holerites:D,erros:I}}}catch(o){const a=Date.now()-i;if(console.error(`âŒ [GERAR HOLERITES] Erro apÃ³s ${a}ms:`,o.message||o),o.statusCode)throw o;throw e({statusCode:500,message:o.message||"Erro ao gerar holerites"})}});function calcularDiasTrabalhados(o,e,a){if(!o)return 30;const r=new Date(o+"T00:00:00"),t=parseInt(e),s=parseInt(a),n=new Date(s,t-1,1),l=new Date(s,t,0);if(r>l)return 0;if(r<n)return l.getDate();const i=l.getDate()-r.getDate()+1;return Math.max(0,i)}export{n as default};
