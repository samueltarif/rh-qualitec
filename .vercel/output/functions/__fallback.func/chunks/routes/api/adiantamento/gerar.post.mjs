import{d as o,c as a,r as e}from"../../../_/nitro.mjs";import{s as t}from"../../../_/serverSupabaseClient.mjs";import{s as r}from"../../../_/serverSupabaseUser.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"node:crypto";import"@supabase/ssr";import"../../../_/fetch-retry.mjs";const n=o(async o=>{var n,s;const i=await t(o),l=await r(o),d=(null==l?void 0:l.sub)||(null==l?void 0:l.id);if(!l||!d)throw a({statusCode:401,message:"N√£o autenticado"});const{data:c}=await i.from("app_users").select("id, role, email").eq("auth_uid",d).single();if(!c||"admin"!==c.role)throw a({statusCode:403,message:"Acesso negado. Apenas administradores podem gerar adiantamentos."});const m=await e(o),{mes:g,ano:p,colaborador_ids:f}=m;if(!g||!p)throw a({statusCode:400,message:"M√™s e ano s√£o obrigat√≥rios"});try{const{data:o}=await i.from("parametros_folha").select("*").single();if(!o)throw new Error("Par√¢metros da folha n√£o configurados");if(!o.adiantamento_habilitado)throw new Error("Adiantamento salarial n√£o est√° habilitado. Ative em Configura√ß√µes > Folha de Pagamento.");const a=parseFloat(o.adiantamento_percentual||40),e=o.adiantamento_dia_pagamento||20;console.log(`\n${"=".repeat(60)}`),console.log("üí∞ GERA√á√ÉO DE ADIANTAMENTOS SALARIAIS"),console.log(`${"=".repeat(60)}`),console.log(`üìÖ Per√≠odo: ${g}/${p}`),console.log(`üíµ Percentual: ${a}%`),console.log(`üìÜ Dia de pagamento: ${e}`),console.log(`${"=".repeat(60)}\n`);let t=i.from("colaboradores").select("\n        *,\n        cargo:cargos(nome),\n        departamento:departamentos!colaboradores_departamento_id_fkey(nome)\n      ").eq("status","Ativo");f&&f.length>0&&(t=t.in("id",f));const{data:r,error:l}=await t;if(l)throw console.error("‚ùå Erro ao buscar colaboradores:",l),l;if(!r||0===r.length)throw new Error("Nenhum colaborador ativo encontrado");const d=[],m=[];for(const o of r)try{console.log(`\nüìã Processando: ${o.nome}`);const t=parseFloat(o.salario||0);if(!t||t<=0){console.warn(`‚ö†Ô∏è ${o.nome} sem sal√°rio definido`),m.push({colaborador:o.nome,erro:"Colaborador sem sal√°rio definido"});continue}const r=t*a/100,l=Math.round(100*r)/100;console.log(`   üí∞ Sal√°rio base: R$ ${t.toFixed(2)}`),console.log(`   üíµ Adiantamento (${a}%): R$ ${l.toFixed(2)}`);const{data:f}=await i.from("holerites").select("id").eq("colaborador_id",o.id).eq("mes",g).eq("ano",p).eq("tipo","adiantamento").maybeSingle(),u={colaborador_id:o.id,mes:g,ano:p,tipo:"adiantamento",nome_colaborador:o.nome||"N√£o informado",cpf:o.cpf||"",cargo:(null==(n=o.cargo)?void 0:n.nome)||"N√£o informado",departamento:(null==(s=o.departamento)?void 0:s.nome)||"N√£o informado",salario_base:t,total_proventos:l,inss:0,irrf:0,total_descontos:0,salario_bruto:l,salario_liquido:l,fgts:0,valor_adiantamento:l,banco:o.banco||null,agencia:o.agencia||null,conta:o.conta||null,data_admissao:o.data_admissao||null,observacoes:`Adiantamento Salarial - ${a}% do sal√°rio\nPagamento previsto: dia ${e}/${g}/${p}\nSem descontos (INSS, IRRF)\nValor ser√° descontado no holerite final do m√™s\n\nC√°lculo: R$ ${t.toFixed(2)} √ó ${a}% = R$ ${l.toFixed(2)}`,status:"gerado",gerado_por:c.id,gerado_em:(new Date).toISOString()};let h;if(f){const{data:o,error:a}=await i.from("holerites").update(u).eq("id",f.id).select().single();if(a)throw a;h=o,console.log("   ‚úÖ Adiantamento ATUALIZADO")}else{const{data:o,error:a}=await i.from("holerites").insert(u).select().single();if(a)throw a;h=o,console.log("   ‚úÖ Adiantamento CRIADO")}d.push(h)}catch(a){console.error(`‚ùå Erro ao gerar adiantamento para ${o.nome}:`,a.message),m.push({colaborador:o.nome,erro:a.message})}return console.log(`\n${"=".repeat(60)}`),console.log("üìä RESUMO DA GERA√á√ÉO"),console.log(`${"=".repeat(60)}`),console.log(`‚úÖ Adiantamentos gerados: ${d.length}`),console.log(`‚ùå Erros: ${m.length}`),m.length>0&&(console.log("\n‚ö†Ô∏è Detalhes dos erros:"),m.forEach(o=>console.log(`   - ${o.colaborador}: ${o.erro}`))),console.log(`${"=".repeat(60)}\n`),{success:!0,data:{total_gerados:d.length,total_erros:m.length,adiantamentos:d,erros:m}}}catch(o){throw console.error("Erro ao gerar adiantamentos:",o),a({statusCode:500,message:o.message||"Erro ao gerar adiantamentos"})}});export{n as default};
