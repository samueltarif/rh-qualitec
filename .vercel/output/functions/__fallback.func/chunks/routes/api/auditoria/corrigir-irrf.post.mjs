import{d as o,c as e,r as a}from"../../../_/nitro.mjs";import{c as r,I as l}from"../../../_/irrf-lei-15270-2025.mjs";import{s as t}from"../../../_/serverSupabaseClient.mjs";import{s as i}from"../../../_/serverSupabaseUser.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"node:crypto";import"@supabase/ssr";import"../../../_/fetch-retry.mjs";const s=o(async o=>{var s,c;const d=await t(o),n=await i(o),u=(null==n?void 0:n.sub)||(null==n?void 0:n.id);if(!n||!u)throw e({statusCode:401,message:"N√£o autenticado"});const{data:_}=await d.from("app_users").select("id, role, email").eq("auth_uid",u).single();if(!_||"admin"!==_.role)throw e({statusCode:403,message:"Acesso negado. Apenas administradores podem executar auditoria."});const p=await a(o),{salario_bruto:g,inss:$,dependentes:m=0,colaborador_id:h,mes:f,ano:R}=p;if(!g||void 0===$||!h)throw e({statusCode:400,message:"Sal√°rio bruto, INSS e ID do colaborador s√£o obrigat√≥rios"});try{console.log(`\n${"=".repeat(80)}`),console.log("üîç AUDITORIA DE IRRF - CORRE√á√ÉO DE DIVERG√äNCIAS"),console.log(`${"=".repeat(80)}`),console.log(`üë§ Colaborador ID: ${h}`),console.log(`üí∞ Sal√°rio Bruto: R$ ${g.toFixed(2)}`),console.log(`üí≥ INSS: R$ ${$.toFixed(2)}`),console.log(`üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Dependentes: ${m}`),console.log(`üìÖ Per√≠odo: ${f}/${R}`),console.log(`üïê Data/Hora: ${(new Date).toLocaleString("pt-BR")}`),console.log(`${"=".repeat(80)}\n`);const o=parseFloat(g),e=r(parseFloat(g),parseFloat($),parseInt(m),o),a=e.valor,t=e.detalhes,i={valor:a,detalhes:[{tipo:"base_calculo",descricao:"C√°lculo da Base de IRRF",salario_bruto:t.salarioBruto,inss_descontado:t.inss,dependentes:t.dependentes,deducao_dependentes:t.deducaoDependentes,base_calculo:t.baseCalculo},{tipo:"calculo_tabela",descricao:"IRRF pela Tabela Progressiva",faixa_aplicada:t.faixaAplicada,aliquota:t.aliquota,parcela_a_deduzir:t.parcelaADeduzir,irrf_tabela:t.irrfTabela},{tipo:"redutor_lei_15270",descricao:"Redutor Lei 15.270/2025",lei_aplicada:t.lei15270Aplicada,rendimentos_tributaveis:t.rendimentosTributaveis,redutor_calculado:t.redutorCalculado,redutor_aplicado:t.redutorAplicado,limite_isencao_total:l.lei15270.limiteIsencaoTotal,limite_faixa_transicao:l.lei15270.limiteFaixaTransicao},{tipo:"resultado_final",descricao:"IRRF Final",irrf_antes_redutor:t.irrfTabela,redutor_aplicado:t.redutorAplicado,irrf_final:t.irrfFinal,observacoes:t.observacoes}]};console.log("üìä C√ÅLCULO OFICIAL DO IRRF:"),console.log(`   üí∞ Valor Correto: R$ ${a.toFixed(2)}`),console.log("   üìã Detalhes do C√°lculo:"),i.detalhes.forEach((o,e)=>{"base_calculo"===o.tipo?(console.log(`      ${e+1}. Base de C√°lculo:`),console.log(`         Sal√°rio Bruto: R$ ${o.salario_bruto.toFixed(2)}`),console.log(`         (-) INSS: R$ ${o.inss_descontado.toFixed(2)}`),console.log(`         (-) Dependentes (${o.dependentes} √ó R$ 189,59): R$ ${o.deducao_dependentes.toFixed(2)}`),console.log(`         = Base IRRF: R$ ${o.base_calculo.toFixed(2)}`)):"isencao"===o.tipo?(console.log(`      ${e+1}. ${o.descricao}`),console.log(`         Base (R$ ${o.base_calculo.toFixed(2)}) ‚â§ Limite (R$ ${o.limite_isencao.toFixed(2)})`)):"calculo"===o.tipo&&(console.log(`      ${e+1}. ${o.faixa_aplicada}`),console.log(`         Base: R$ ${o.base_calculo.toFixed(2)}`),console.log(`         IRRF: R$ ${o.irrf_final.toFixed(2)}`))});const n={},u=[];try{const o=null==(c=null==(s=(await $fetch("/api/folha/calcular",{method:"POST",body:{mes:f||"01",ano:R||"2024"}})).data)?void 0:s.folha)?void 0:c.find(o=>o.colaborador_id===h);o&&(n.folha_detalhamento=o.irrf,Math.abs(o.irrf-a)>.01&&u.push({modulo:"FolhaDetalhamentoColaboradores",valor_atual:o.irrf,valor_correto:a,diferenca:o.irrf-a}))}catch(o){console.log("   ‚ö†Ô∏è  N√£o foi poss√≠vel verificar FolhaDetalhamentoColaboradores")}try{const{calcularIRRF:o}=await import("../../../_/useFolhaCalculos.mjs").then(function(o){return o.u}),e=o(parseFloat(g),parseFloat($),parseInt(m));n.modal_edicao=e,Math.abs(e-a)>.01&&u.push({modulo:"FolhaModalEdicao",valor_atual:e,valor_correto:a,diferenca:e-a})}catch(o){console.log("   ‚ö†Ô∏è  Erro ao verificar FolhaModalEdicao:",o)}const{data:p}=await d.from("holerites").select("id, irrf, mes, ano, tipo").eq("colaborador_id",h).order("created_at",{ascending:!1}).limit(5);if(p&&p.length>0&&p.forEach(o=>{Math.abs(o.irrf-a)>.01&&u.push({modulo:"Holerite",holerite_id:o.id,periodo:`${o.mes}/${o.ano}`,tipo:o.tipo,valor_atual:o.irrf,valor_correto:a,diferenca:o.irrf-a})}),console.log("\nüîç AN√ÅLISE DE DIVERG√äNCIAS:"),console.log("   üìä Valores Encontrados:"),Object.entries(n).forEach(([o,e])=>{const r=Math.abs(e-a)<=.01?"‚úÖ":"‚ùå";console.log(`      ${r} ${o}: R$ ${e.toFixed(2)}`)}),0===u.length)return console.log("\n‚úÖ RESULTADO: Nenhuma diverg√™ncia encontrada!"),console.log("   Todos os m√≥dulos est√£o calculando o IRRF corretamente."),{success:!0,divergencias_encontradas:!1,valor_correto:a,detalhes_calculo:i.detalhes,valores_atuais:n,message:"Nenhuma diverg√™ncia de IRRF encontrada. Todos os c√°lculos est√£o corretos."};console.log(`\n‚ùå DIVERG√äNCIAS ENCONTRADAS: ${u.length}`),u.forEach((o,e)=>{console.log(`   ${e+1}. ${o.modulo}:`),console.log(`      Atual: R$ ${o.valor_atual.toFixed(2)}`),console.log(`      Correto: R$ ${o.valor_correto.toFixed(2)}`),console.log(`      Diferen√ßa: R$ ${o.diferenca.toFixed(2)}`),o.periodo&&console.log(`      Per√≠odo: ${o.periodo}`),o.tipo&&console.log(`      Tipo: ${o.tipo}`)});const F=[];for(const o of u)if("Holerite"===o.modulo&&o.holerite_id)try{const{data:e}=await d.from("holerites").select("*").eq("id",o.holerite_id).single();if(e){const r=e.total_descontos-e.irrf+a,l=e.salario_bruto-r,{error:t}=await d.from("holerites").update({irrf:a,total_descontos:parseFloat(r.toFixed(2)),salario_liquido:parseFloat(l.toFixed(2)),observacoes:(e.observacoes||"")+`\n\nüîß CORRE√á√ÉO AUTOM√ÅTICA DE IRRF:\nValor anterior: R$ ${o.valor_atual.toFixed(2)}\nValor corrigido: R$ ${a.toFixed(2)}\nData da corre√ß√£o: ${(new Date).toLocaleString("pt-BR")}`}).eq("id",o.holerite_id);t||F.push({modulo:"Holerite",holerite_id:o.holerite_id,periodo:o.periodo,valor_anterior:o.valor_atual,valor_corrigido:a,total_descontos_anterior:e.total_descontos,total_descontos_corrigido:r,salario_liquido_anterior:e.salario_liquido,salario_liquido_corrigido:l})}}catch(e){console.error(`Erro ao corrigir holerite ${o.holerite_id}:`,e)}const v={tipo:"correcao_irrf",colaborador_id:h,salario_bruto:parseFloat(g),inss:parseFloat($),dependentes:parseInt(m),valor_irrf_correto:a,detalhes_calculo:i.detalhes,divergencias_encontradas:u,correcoes_aplicadas:F,valores_antes:n,executado_por:_.id,executado_em:(new Date).toISOString()};return console.log("\nüîß CORRE√á√ïES APLICADAS:"),F.length>0?F.forEach((o,e)=>{console.log(`   ${e+1}. ${o.modulo} (${o.periodo}):`),console.log(`      IRRF: R$ ${o.valor_anterior.toFixed(2)} ‚Üí R$ ${o.valor_corrigido.toFixed(2)}`),console.log(`      Total Descontos: R$ ${o.total_descontos_anterior.toFixed(2)} ‚Üí R$ ${o.total_descontos_corrigido.toFixed(2)}`),console.log(`      Sal√°rio L√≠quido: R$ ${o.salario_liquido_anterior.toFixed(2)} ‚Üí R$ ${o.salario_liquido_corrigido.toFixed(2)}`)}):(console.log("   ‚ÑπÔ∏è  Nenhuma corre√ß√£o autom√°tica foi aplicada."),console.log("   üìù Nota: Diverg√™ncias em composables precisam ser corrigidas no c√≥digo.")),console.log(`\n${"=".repeat(80)}`),console.log("‚úÖ AUDITORIA CONCLU√çDA"),console.log(`${"=".repeat(80)}\n`),{success:!0,divergencias_encontradas:u.length>0,total_divergencias:u.length,total_correcoes:F.length,valor_correto:a,detalhes_calculo:i.detalhes,divergencias:u,correcoes_aplicadas:F,valores_antes:n,auditoria:v,message:`Auditoria conclu√≠da. ${u.length} diverg√™ncia(s) encontrada(s), ${F.length} corre√ß√£o(√µes) aplicada(s).`}}catch(o){throw console.error("Erro na auditoria de IRRF:",o),e({statusCode:500,message:o.message||"Erro ao executar auditoria de IRRF"})}});export{s as default};
