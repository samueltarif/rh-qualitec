import{d as o,c as a,r as e}from"../../../_/nitro.mjs";import{s as t}from"../../../_/serverSupabaseClient.mjs";import{s as r}from"../../../_/serverSupabaseUser.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"node:crypto";import"@supabase/ssr";import"../../../_/fetch-retry.mjs";const l=o(async o=>{var l,s;const i=await t(o),c=await r(o),n=(null==c?void 0:c.sub)||(null==c?void 0:c.id);if(!c||!n)throw a({statusCode:401,message:"N√£o autenticado"});const{data:d}=await i.from("app_users").select("id, role, email").eq("auth_uid",n).single();if(!d||"admin"!==d.role)throw a({statusCode:403,message:"Acesso negado. Apenas administradores podem executar auditoria."});const u=await e(o),{salario_bruto:_,colaborador_id:g,mes:h,ano:m}=u;if(!_||!g)throw a({statusCode:400,message:"Sal√°rio bruto e ID do colaborador s√£o obrigat√≥rios"});try{console.log(`\n${"=".repeat(80)}`),console.log("üîç AUDITORIA DE INSS - CORRE√á√ÉO DE DIVERG√äNCIAS"),console.log(`${"=".repeat(80)}`),console.log(`üë§ Colaborador ID: ${g}`),console.log(`üí∞ Sal√°rio Bruto: R$ ${_.toFixed(2)}`),console.log(`üìÖ Per√≠odo: ${h}/${m}`),console.log(`üïê Data/Hora: ${(new Date).toLocaleString("pt-BR")}`),console.log(`${"=".repeat(80)}\n`);const o=(o=>{const a=[{limite:1412,aliquota:.075,descricao:"At√© R$ 1.412,00 - 7,5%"},{limite:2666.68,aliquota:.09,descricao:"De R$ 1.412,01 at√© R$ 2.666,68 - 9%"},{limite:4000.03,aliquota:.12,descricao:"De R$ 2.666,69 at√© R$ 4.000,03 - 12%"},{limite:7786.02,aliquota:.14,descricao:"De R$ 4.000,04 at√© R$ 7.786,02 - 14%"}],e=908.85;let t=0,r=o;const l=[];for(let o=0;o<a.length;o++){const e=o>0?a[o-1].limite:0,s=a[o].limite,i=Math.min(r,s-e);if(i>0){const e=i*a[o].aliquota;t+=e,l.push({faixa:o+1,descricao:a[o].descricao,base_calculo:i,aliquota:a[o].aliquota,valor_contribuicao:e}),r-=i}if(r<=0)break}const s=Math.min(t,e);return t>e&&l.push({observacao:`Teto INSS aplicado: R$ ${e.toFixed(2)} (calculado: R$ ${t.toFixed(2)})`}),{valor:parseFloat(s.toFixed(2)),detalhes:l}})(parseFloat(_)),a=o.valor;console.log("üìä C√ÅLCULO OFICIAL DO INSS:"),console.log(`   üí∞ Valor Correto: R$ ${a.toFixed(2)}`),console.log("   üìã Detalhes do C√°lculo:"),o.detalhes.forEach((o,a)=>{o.observacao?console.log(`      ‚ö†Ô∏è  ${o.observacao}`):(console.log(`      ${a+1}. ${o.descricao}`),console.log(`         Base: R$ ${o.base_calculo.toFixed(2)} √ó ${(100*o.aliquota).toFixed(1)}% = R$ ${o.valor_contribuicao.toFixed(2)}`))});const e={},t=[];try{const o=null==(s=null==(l=(await $fetch("/api/folha/calcular",{method:"POST",body:{mes:h||"01",ano:m||"2024"}})).data)?void 0:l.folha)?void 0:s.find(o=>o.colaborador_id===g);o&&(e.folha_detalhamento=o.inss,Math.abs(o.inss-a)>.01&&t.push({modulo:"FolhaDetalhamentoColaboradores",valor_atual:o.inss,valor_correto:a,diferenca:o.inss-a}))}catch(o){console.log("   ‚ö†Ô∏è  N√£o foi poss√≠vel verificar FolhaDetalhamentoColaboradores")}const{calcularINSS:r}=await import("../../../_/useFolhaCalculos.mjs").then(function(o){return o.u}),c=r(parseFloat(_));e.modal_edicao=c,Math.abs(c-a)>.01&&t.push({modulo:"FolhaModalEdicao",valor_atual:c,valor_correto:a,diferenca:c-a});const{data:n}=await i.from("holerites").select("id, inss, mes, ano, tipo").eq("colaborador_id",g).order("created_at",{ascending:!1}).limit(5);if(n&&n.length>0&&n.forEach(o=>{Math.abs(o.inss-a)>.01&&t.push({modulo:"Holerite",holerite_id:o.id,periodo:`${o.mes}/${o.ano}`,tipo:o.tipo,valor_atual:o.inss,valor_correto:a,diferenca:o.inss-a})}),console.log("\nüîç AN√ÅLISE DE DIVERG√äNCIAS:"),console.log("   üìä Valores Encontrados:"),Object.entries(e).forEach(([o,e])=>{const t=Math.abs(e-a)<=.01?"‚úÖ":"‚ùå";console.log(`      ${t} ${o}: R$ ${e.toFixed(2)}`)}),0===t.length)return console.log("\n‚úÖ RESULTADO: Nenhuma diverg√™ncia encontrada!"),console.log("   Todos os m√≥dulos est√£o calculando o INSS corretamente."),{success:!0,divergencias_encontradas:!1,valor_correto:a,detalhes_calculo:o.detalhes,valores_atuais:e,message:"Nenhuma diverg√™ncia de INSS encontrada. Todos os c√°lculos est√£o corretos."};console.log(`\n‚ùå DIVERG√äNCIAS ENCONTRADAS: ${t.length}`),t.forEach((o,a)=>{console.log(`   ${a+1}. ${o.modulo}:`),console.log(`      Atual: R$ ${o.valor_atual.toFixed(2)}`),console.log(`      Correto: R$ ${o.valor_correto.toFixed(2)}`),console.log(`      Diferen√ßa: R$ ${o.diferenca.toFixed(2)}`),o.periodo&&console.log(`      Per√≠odo: ${o.periodo}`),o.tipo&&console.log(`      Tipo: ${o.tipo}`)});const u=[];for(const o of t)if("Holerite"===o.modulo&&o.holerite_id)try{const{data:e}=await i.from("holerites").select("*").eq("id",o.holerite_id).single();if(e){const t=e.total_descontos-e.inss+a,r=e.salario_bruto-t,{error:l}=await i.from("holerites").update({inss:a,total_descontos:parseFloat(t.toFixed(2)),salario_liquido:parseFloat(r.toFixed(2)),observacoes:(e.observacoes||"")+`\n\nüîß CORRE√á√ÉO AUTOM√ÅTICA DE INSS:\nValor anterior: R$ ${o.valor_atual.toFixed(2)}\nValor corrigido: R$ ${a.toFixed(2)}\nData da corre√ß√£o: ${(new Date).toLocaleString("pt-BR")}`}).eq("id",o.holerite_id);l||u.push({modulo:"Holerite",holerite_id:o.holerite_id,periodo:o.periodo,valor_anterior:o.valor_atual,valor_corrigido:a,total_descontos_anterior:e.total_descontos,total_descontos_corrigido:t,salario_liquido_anterior:e.salario_liquido,salario_liquido_corrigido:r})}}catch(a){console.error(`Erro ao corrigir holerite ${o.holerite_id}:`,a)}const $={tipo:"correcao_inss",colaborador_id:g,salario_bruto:parseFloat(_),valor_inss_correto:a,detalhes_calculo:o.detalhes,divergencias_encontradas:t,correcoes_aplicadas:u,valores_antes:e,executado_por:d.id,executado_em:(new Date).toISOString()};try{await i.from("auditoria_calculos").insert($)}catch(o){console.log("   ‚ö†Ô∏è  Tabela de auditoria n√£o encontrada, salvando em log")}return console.log("\nüîß CORRE√á√ïES APLICADAS:"),u.length>0?u.forEach((o,a)=>{console.log(`   ${a+1}. ${o.modulo} (${o.periodo}):`),console.log(`      INSS: R$ ${o.valor_anterior.toFixed(2)} ‚Üí R$ ${o.valor_corrigido.toFixed(2)}`),console.log(`      Total Descontos: R$ ${o.total_descontos_anterior.toFixed(2)} ‚Üí R$ ${o.total_descontos_corrigido.toFixed(2)}`),console.log(`      Sal√°rio L√≠quido: R$ ${o.salario_liquido_anterior.toFixed(2)} ‚Üí R$ ${o.salario_liquido_corrigido.toFixed(2)}`)}):(console.log("   ‚ÑπÔ∏è  Nenhuma corre√ß√£o autom√°tica foi aplicada."),console.log("   üìù Nota: Diverg√™ncias em composables precisam ser corrigidas no c√≥digo.")),console.log(`\n${"=".repeat(80)}`),console.log("‚úÖ AUDITORIA CONCLU√çDA"),console.log(`${"=".repeat(80)}\n`),{success:!0,divergencias_encontradas:t.length>0,total_divergencias:t.length,total_correcoes:u.length,valor_correto:a,detalhes_calculo:o.detalhes,divergencias:t,correcoes_aplicadas:u,valores_antes:e,auditoria:$,message:`Auditoria conclu√≠da. ${t.length} diverg√™ncia(s) encontrada(s), ${u.length} corre√ß√£o(√µes) aplicada(s).`}}catch(o){throw console.error("Erro na auditoria de INSS:",o),a({statusCode:500,message:o.message||"Erro ao executar auditoria de INSS"})}});export{l as default};
