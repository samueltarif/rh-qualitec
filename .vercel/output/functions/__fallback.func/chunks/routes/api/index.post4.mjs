import{d as a,r as e,c as o,u as s}from"../../_/nitro.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"node:crypto";const r=a(async a=>{var r,t,i,c;try{const t=await e(a);if(!t.nome||!t.cpf)throw o({statusCode:400,statusMessage:"Nome e CPF são obrigatórios"});if("string"!=typeof t.nome||t.nome.trim().length<2)throw o({statusCode:400,statusMessage:"Nome deve ter pelo menos 2 caracteres"});if(11!==t.cpf.replace(/\D/g,"").length)throw o({statusCode:400,statusMessage:"CPF deve ter 11 dígitos"});const i=s(),c=i.public.supabaseUrl,n=i.supabaseServiceKey;if(!n)throw o({statusCode:500,statusMessage:"Service key não configurada"});let d=t.empresa_id;if(!d)try{let a;try{a=await $fetch(`${c}/rest/v1/empresas?select=id&limit=1`,{headers:{Authorization:`Bearer ${n}`,apikey:n}})}catch(e){a=await $fetch(`${c}/rest/v1/empresa?select=id&limit=1`,{headers:{Authorization:`Bearer ${n}`,apikey:n}})}if(d=null==(r=null==a?void 0:a[0])?void 0:r.id,!d){const{data:a}=await $fetch(`${c}/rest/v1/rpc/garantir_empresa_padrao`,{method:"POST",headers:{Authorization:`Bearer ${n}`,"Content-Type":"application/json",apikey:n}});d=a}}catch(a){console.error("Erro ao buscar/criar empresa padrão:",a)}if(!d)throw o({statusCode:500,statusMessage:"Não foi possível garantir empresa padrão. Verifique a configuração do sistema."});const l={empresa_id:d,nome:t.nome.trim(),cpf:t.cpf.replace(/\D/g,"")};["matricula","email_corporativo","email_pessoal","telefone","celular","data_nascimento","data_admissao","salario","tipo_contrato","status","cargo_id","departamento_id","gestor_id","rg","sexo","estado_civil","cep","logradouro","numero","complemento","bairro","cidade","estado","banco_codigo","banco_nome","agencia","conta","tipo_conta","pix","pis","ctps","ctps_serie","jornada_trabalho","observacoes_rh"].forEach(a=>{void 0!==t[a]&&null!==t[a]&&""!==t[a]&&(l[a]=t[a])}),console.log("[CREATE COLABORADOR] Dados para inserção:",l);const u=await $fetch(`${c}/rest/v1/colaboradores`,{method:"POST",headers:{Authorization:`Bearer ${n}`,"Content-Type":"application/json",apikey:n,Prefer:"return=representation"},body:l});if(!u)throw console.error("[CREATE COLABORADOR] Erro: resposta vazia do servidor"),o({statusCode:500,statusMessage:"Erro interno: resposta vazia do servidor"});let p;if(console.log("[CREATE COLABORADOR] Colaborador criado com sucesso:",u),Array.isArray(u)&&u.length>0)p=u[0].id;else{if(!u.id)throw console.error("[CREATE COLABORADOR] Erro: ID não encontrado na resposta:",u),o({statusCode:500,statusMessage:"Erro interno: ID do colaborador não foi retornado"});p=u.id}if(!0===t.criar_acesso_sistema)try{const a=t.email_corporativo||t.email_pessoal;if(!a)throw o({statusCode:400,statusMessage:"Email é obrigatório para criar acesso ao sistema"});const e=await $fetch(`${c}/rest/v1/app_users?colaborador_id=eq.${p}&select=id`,{headers:{Authorization:`Bearer ${n}`,apikey:n}});if(e&&0!==e.length)console.log("[CREATE COLABORADOR] Colaborador já possui acesso ao sistema");else{console.log("[CREATE COLABORADOR] Criando acesso ao sistema (solicitado explicitamente):",p);const e={colaborador_id:p,nome:t.nome,email:a,empresa_id:d,ativo:!0};await $fetch(`${c}/rest/v1/app_users`,{method:"POST",headers:{Authorization:`Bearer ${n}`,"Content-Type":"application/json",apikey:n},body:e}),console.log("[CREATE COLABORADOR] Acesso ao sistema criado com sucesso")}}catch(a){throw console.error("[CREATE COLABORADOR] Erro ao criar acesso ao sistema:",a),o({statusCode:500,statusMessage:`Erro ao criar acesso: ${a.message||"Erro desconhecido"}`})}else console.log("[CREATE COLABORADOR] Colaborador criado SEM acesso ao sistema (não solicitado)");if(t.criar_usuario&&t.usuario_email&&t.usuario_senha)try{console.log("[CREATE COLABORADOR] Criando usuário para colaborador:",p);const a=await $fetch("/api/users/create",{method:"POST",body:{nome:t.nome,email:t.usuario_email,password:t.usuario_senha,role:t.usuario_role||"funcionario",colaborador_id:p}});a.success?console.log("[CREATE COLABORADOR] Usuário criado com sucesso:",a.data):console.error("[CREATE COLABORADOR] Falha ao criar usuário:",a.error)}catch(a){console.error("[CREATE COLABORADOR] Erro ao criar usuário:",a.message||a)}return{success:!0,data:Array.isArray(u)?u[0]:u}}catch(a){if(console.error("[CREATE COLABORADOR] Erro geral:",a),null==(t=a.message)?void 0:t.includes('null value in column "id"'))throw o({statusCode:500,statusMessage:"Erro interno: problema na geração do ID. Verifique a configuração da tabela colaboradores."});if((null==(i=a.message)?void 0:i.includes("duplicate key"))||(null==(c=a.message)?void 0:c.includes("unique constraint"))){if(a.message.includes("cpf"))throw o({statusCode:400,statusMessage:"Este CPF já está cadastrado para esta empresa"});if(a.message.includes("email"))throw o({statusCode:400,statusMessage:"Este email já está cadastrado para esta empresa"});if(a.message.includes("matricula"))throw o({statusCode:400,statusMessage:"Esta matrícula já está cadastrada para esta empresa"});throw o({statusCode:400,statusMessage:"Dados duplicados: verifique CPF, email ou matrícula"})}const e=a.statusCode||500,s=a.statusMessage||a.message||"Erro ao criar colaborador";throw o({statusCode:e,statusMessage:s})}});export{r as default};
