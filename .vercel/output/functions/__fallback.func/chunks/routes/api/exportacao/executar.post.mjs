import{d as o,c as t,r as e}from"../../../_/nitro.mjs";import{s as r}from"../../../_/serverSupabaseUser.mjs";import{s}from"../../../_/serverSupabaseClient.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"node:crypto";import"@supabase/ssr";import"../../../_/fetch-retry.mjs";const a=o(async o=>{try{const a=await r(o);if(!a)throw t({statusCode:401,message:"Não autenticado"});const i=await e(o),n=await s(o),{data:p,error:m}=await n.from("historico_exportacoes").insert({tipo_entidade:i.tipoEntidade,formato:i.formato,filtros:i.filtros||{},status:"processando",usuario_id:a.id,expira_em:new Date(Date.now()+864e5).toISOString()}).select().single();if(m)throw m;const d=`${i.tipoEntidade}_${Date.now()}.${i.formato}`;return await n.from("historico_exportacoes").update({status:"concluido",arquivo_nome:d,total_registros:0,completed_at:(new Date).toISOString()}).eq("id",p.id),{success:!0,message:"Exportação gerada com sucesso",data:p}}catch(o){throw console.error("Erro na exportação:",o),t({statusCode:o.statusCode||500,message:o.message||"Erro ao processar exportação"})}});export{a as default};
