import{d as e}from"../../../_/nitro.mjs";import{s as a}from"../../../_/serverSupabaseClient.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"node:crypto";import"@supabase/ssr";import"../../../_/fetch-retry.mjs";const t=e(async e=>{const t=await a(e),i=[],{data:o}=await t.from("configuracoes_notificacoes").select("*").limit(1).single();if(!o)return{alertas:[],message:"Configurações não encontradas"};const{data:d}=await t.from("empresas").select("id").limit(1).single(),n=null==d?void 0:d.id,{data:r}=await t.from("tipos_alertas").select("*").eq("ativo",!0),getTipoAlerta=e=>null==r?void 0:r.find(a=>a.codigo===e),s=new Date;if(s.setHours(0,0,0,0),o.notificar_documentos_vencendo){const e=new Date(s);e.setDate(e.getDate()+o.dias_antecedencia_documentos);const{data:a}=await t.from("documentos_rh").select("\n        id, nome, data_validade,\n        colaborador:colaborador_id(id, nome)\n      ").lte("data_validade",e.toISOString().split("T")[0]).gte("data_validade",s.toISOString().split("T")[0]);for(const e of a||[]){const a=getTipoAlerta("DOC_VENCENDO");if(a&&e.colaborador){const t={empresa_id:n,tipo_alerta_id:a.id,colaborador_id:e.colaborador.id,documento_id:e.id,referencia_tipo:"documento",referencia_id:e.id,titulo:`Documento "${e.nome}" vencendo`,mensagem:`O documento "${e.nome}" de ${e.colaborador.nome} vence em ${e.data_validade}`,prioridade:"media",data_vencimento:e.data_validade};i.push(t)}}}const{data:c}=await t.from("documentos_rh").select("\n      id, nome, data_validade,\n      colaborador:colaborador_id(id, nome)\n    ").lt("data_validade",s.toISOString().split("T")[0]);for(const e of c||[]){const a=getTipoAlerta("DOC_VENCIDO");if(a&&e.colaborador){const t={empresa_id:n,tipo_alerta_id:a.id,colaborador_id:e.colaborador.id,documento_id:e.id,referencia_tipo:"documento",referencia_id:e.id,titulo:`Documento "${e.nome}" VENCIDO`,mensagem:`O documento "${e.nome}" de ${e.colaborador.nome} venceu em ${e.data_validade}`,prioridade:"alta",data_vencimento:e.data_validade};i.push(t)}}if(o.notificar_aniversarios){const e=new Date(s);e.setDate(e.getDate()+o.dias_antecedencia_aniversarios);const a=e.getMonth()+1,d=e.getDate(),{data:r}=await t.from("colaboradores").select("id, nome, data_nascimento").eq("status","Ativo");for(const t of r||[])if(t.data_nascimento){const o=new Date(t.data_nascimento);if(o.getMonth()+1===a&&o.getDate()===d){const o=getTipoAlerta("ANIVERSARIO");if(o){const r={empresa_id:n,tipo_alerta_id:o.id,colaborador_id:t.id,referencia_tipo:"aniversario",referencia_id:t.id,titulo:`Aniversário de ${t.nome}`,mensagem:`${t.nome} faz aniversário em ${d}/${a}`,prioridade:"baixa",data_vencimento:e.toISOString().split("T")[0]};i.push(r)}}}}if(o.notificar_aniversarios_empresa){const e=new Date(s);e.setDate(e.getDate()+o.dias_antecedencia_aniversarios_empresa);const a=e.getMonth()+1,d=e.getDate(),{data:r}=await t.from("colaboradores").select("id, nome, data_admissao").eq("status","Ativo");for(const t of r||[])if(t.data_admissao){const o=new Date(t.data_admissao);if(o.getMonth()+1===a&&o.getDate()===d){const r=e.getFullYear()-o.getFullYear();if(r>0){const o=getTipoAlerta("ANIVERSARIO_EMPRESA");if(o){const s={empresa_id:n,tipo_alerta_id:o.id,colaborador_id:t.id,referencia_tipo:"aniversario_empresa",referencia_id:t.id,titulo:`${r} anos de empresa - ${t.nome}`,mensagem:`${t.nome} completa ${r} anos de empresa em ${d}/${a}`,prioridade:"baixa",data_vencimento:e.toISOString().split("T")[0]};i.push(s)}}}}}if(o.notificar_experiencia_vencendo){const{data:e}=await t.from("colaboradores").select("id, nome, data_admissao, tipo_contrato").eq("status","Ativo");for(const a of e||[])if(a.data_admissao){const e=new Date(a.data_admissao),t=new Date(e);t.setDate(t.getDate()+45);const d=new Date(e);d.setDate(d.getDate()+90);const r=Math.ceil((t.getTime()-s.getTime())/864e5),c=Math.ceil((d.getTime()-s.getTime())/864e5);if(r>0&&r<=o.dias_antecedencia_experiencia){const e=getTipoAlerta("EXPERIENCIA_VENCENDO");if(e){const o={empresa_id:n,tipo_alerta_id:e.id,colaborador_id:a.id,referencia_tipo:"experiencia",referencia_id:a.id,titulo:`Experiência 45 dias - ${a.nome}`,mensagem:`Período de experiência de 45 dias de ${a.nome} termina em ${r} dias`,prioridade:"alta",data_vencimento:t.toISOString().split("T")[0]};i.push(o)}}if(c>0&&c<=o.dias_antecedencia_experiencia){const e=getTipoAlerta("EXPERIENCIA_VENCENDO");if(e){const t={empresa_id:n,tipo_alerta_id:e.id,colaborador_id:a.id,referencia_tipo:"experiencia",referencia_id:a.id,titulo:`Experiência 90 dias - ${a.nome}`,mensagem:`Período de experiência de 90 dias de ${a.nome} termina em ${c} dias`,prioridade:"alta",data_vencimento:d.toISOString().split("T")[0]};i.push(t)}}}}let m=0;for(const e of i){const{data:a}=await t.from("alertas").select("id").eq("colaborador_id",e.colaborador_id).eq("referencia_tipo",e.referencia_tipo).eq("referencia_id",e.referencia_id).in("status",["pendente","lido"]).limit(1).single();a||(await t.from("alertas").insert(e),m++)}return{total_verificados:i.length,alertas_inseridos:m,message:`${m} novos alertas gerados`}});export{t as default};
