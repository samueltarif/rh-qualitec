import{d as o,r as a,c as t,u as e}from"../../../_/nitro.mjs";import{c as s}from"../../../_/irrf-lei-15270-2025.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"node:crypto";const r=o(async o=>{const r=Date.now();try{const i=await a(o).catch(()=>{throw t({statusCode:400,message:"Corpo da requisi√ß√£o inv√°lido ou ausente"})}),{mes:l,ano:n}=i;if(!l||!n)throw t({statusCode:400,message:"Campos obrigat√≥rios ausentes: mes e ano s√£o necess√°rios"});const d=parseInt(l),c=parseInt(n);if(isNaN(d)||d<1||d>12)throw t({statusCode:400,message:"M√™s inv√°lido. Deve ser entre 1 e 12."});if(isNaN(c)||c<2020||c>2100)throw t({statusCode:400,message:"Ano inv√°lido. Deve ser entre 2020 e 2100."});const _=e(),m=_.public.supabaseUrl,u=_.supabaseServiceKey;if(!u)throw t({statusCode:500,message:"Service key n√£o configurada"});const p={Authorization:`Bearer ${u}`,apikey:u},v=await $fetch(`${m}/rest/v1/colaboradores?select=id,nome,cpf,cargo_id,departamento_id,salario,status,data_admissao,data_desligamento,recebe_vt,valor_vt,recebe_vr,valor_vr,recebe_va,valor_va,recebe_va_vr,valor_va_vr&status=eq.Ativo`,{headers:p}).catch(o=>{throw console.error("[CALCULAR FOLHA] Erro ao buscar colaboradores:",o),t({statusCode:500,message:"Erro ao buscar colaboradores. Verifique a conex√£o com o banco de dados."})});if(!v||0===v.length)throw console.warn("[CALCULAR FOLHA] Nenhum colaborador ativo encontrado",{mes:l,ano:n}),t({statusCode:404,message:"Nenhum colaborador ativo encontrado para calcular a folha."});let F=parseInt(l)-1,f=parseInt(n);0===F&&(F=12,f-=1);const b=F.toString().padStart(2,"0"),g=await $fetch(`${m}/rest/v1/holerites?select=colaborador_id,salario_liquido,valor_adiantamento&tipo=eq.adiantamento&mes=eq.${b}&ano=eq.${f}`,{headers:p}).catch(()=>[]);console.log(`üîç Buscando adiantamentos de ${b}/${f} para descontar em ${l}/${n}`),console.log(`üìã Adiantamentos encontrados: ${g.length}`);const h=new Map;g.forEach(o=>{const a=parseFloat(o.salario_liquido||o.valor_adiantamento||0);h.set(o.colaborador_id,a),console.log(`   üí≥ Colaborador ${o.colaborador_id}: R$ ${a.toFixed(2)}`)});const C=v.map(o=>{const a=parseFloat(o.salario)||0,t=[{limite:1412,aliquota:.075},{limite:2666.68,aliquota:.09},{limite:4000.03,aliquota:.12},{limite:7786.02,aliquota:.14}];let e=0,r=a;for(let o=0;o<t.length;o++){const a=o>0?t[o-1].limite:0,s=t[o].limite,i=Math.min(r,s-a);if(i>0&&(e+=i*t[o].aliquota,r-=i),r<=0)break}e=Math.min(e,908.85);const i=s(a,e,0,a).valor,l=.08*a,n=(o.recebe_vt&&parseFloat(o.valor_vt)||0)+(o.recebe_vr&&parseFloat(o.valor_vr)||0)+(o.recebe_va&&parseFloat(o.valor_va)||0)+(o.recebe_va_vr&&parseFloat(o.valor_va_vr)||0),d=h.get(o.id)||0,c=e+i+d,_=a-c;return{colaborador_id:o.id,nome:o.nome,cpf:o.cpf,cargo_id:o.cargo_id,departamento_id:o.departamento_id,salario_bruto:a,inss:parseFloat(e.toFixed(2)),irrf:parseFloat(i.toFixed(2)),fgts:parseFloat(l.toFixed(2)),adiantamento:parseFloat(d.toFixed(2)),total_descontos:parseFloat(c.toFixed(2)),salario_liquido:parseFloat(_.toFixed(2)),total_beneficios:parseFloat(n.toFixed(2))}}),x={total_colaboradores:C.length,total_salario_bruto:C.reduce((o,a)=>o+a.salario_bruto,0),total_inss:C.reduce((o,a)=>o+a.inss,0),total_irrf:C.reduce((o,a)=>o+a.irrf,0),total_fgts:C.reduce((o,a)=>o+a.fgts,0),total_adiantamento:C.reduce((o,a)=>o+a.adiantamento,0),total_descontos:C.reduce((o,a)=>o+a.total_descontos,0),total_salario_liquido:C.reduce((o,a)=>o+a.salario_liquido,0),total_beneficios:C.reduce((o,a)=>o+a.total_beneficios,0),custo_empresa:0};x.custo_empresa=x.total_salario_bruto+x.total_fgts+x.total_beneficios;const q=Date.now()-r;return console.log(`‚úÖ [CALCULAR FOLHA] Sucesso em ${q}ms - ${C.length} colaboradores processados`),{success:!0,data:{mes:l,ano:n,data_calculo:(new Date).toISOString(),folha:C,totais:{...x,total_salario_bruto:parseFloat(x.total_salario_bruto.toFixed(2)),total_inss:parseFloat(x.total_inss.toFixed(2)),total_irrf:parseFloat(x.total_irrf.toFixed(2)),total_fgts:parseFloat(x.total_fgts.toFixed(2)),total_adiantamento:parseFloat(x.total_adiantamento.toFixed(2)),total_descontos:parseFloat(x.total_descontos.toFixed(2)),total_salario_liquido:parseFloat(x.total_salario_liquido.toFixed(2)),total_beneficios:parseFloat(x.total_beneficios.toFixed(2)),custo_empresa:parseFloat(x.custo_empresa.toFixed(2))}}}}catch(o){const a=Date.now()-r;throw console.error(`‚ùå [CALCULAR FOLHA] Erro ap√≥s ${a}ms:`,o.message||o),t({statusCode:o.statusCode||500,message:o.message||"Erro ao calcular folha de pagamento"})}});export{r as default};
