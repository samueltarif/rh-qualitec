import{d as a,g as o,r as t,c as s}from"../../../_/nitro.mjs";import{s as e}from"../../../_/serverSupabaseClient.mjs";import{s as r}from"../../../_/serverSupabaseUser.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"node:crypto";import"@supabase/ssr";import"../../../_/fetch-retry.mjs";const i=a(async a=>{const i=await e(a),d=await r(a),n=o(a,"id"),u=await t(a);if(!d)throw s({statusCode:401,message:"Não autenticado"});if(!n)throw s({statusCode:400,message:"ID do registro não informado"});try{const a=(null==d?void 0:d.id)||(null==d?void 0:d.sub);if(!a)throw s({statusCode:401,message:"ID de usuário inválido"});const{data:o}=await i.from("app_users").select("id, role, colaborador_id").eq("auth_uid",a).single(),t=o;if(!t)throw s({statusCode:400,message:"Usuário não encontrado"});const{data:e}=await i.from("registros_ponto").select("id").eq("id",n).single();if(!e)throw s({statusCode:404,message:"Registro não encontrado"});const r={updated_at:(new Date).toISOString()};void 0!==u.entrada_1&&(r.entrada_1=u.entrada_1||null),void 0!==u.saida_1&&(r.saida_1=u.saida_1||null),void 0!==u.entrada_2&&(r.entrada_2=u.entrada_2||null),void 0!==u.saida_2&&(r.saida_2=u.saida_2||null),void 0!==u.entrada_3&&(r.entrada_3=u.entrada_3||null),void 0!==u.saida_3&&(r.saida_3=u.saida_3||null),u.status&&(r.status=u.status),void 0!==u.observacoes&&(r.observacoes=u.observacoes),void 0!==u.justificativa&&(r.justificativa=u.justificativa),r.ajustado_por=t.id,r.ajustado_em=(new Date).toISOString();const{data:m,error:l}=await i.from("registros_ponto").update(r).eq("id",n).select("\n        *,\n        colaborador:colaboradores(\n          id, nome, matricula,\n          cargo:cargos(id, nome),\n          departamento:departamentos!colaboradores_departamento_id_fkey(id, nome)\n        )\n      ").single();if(l)throw console.error("Erro ao atualizar registro:",l),s({statusCode:500,message:l.message});return console.log("✅ Registro de ponto atualizado com sucesso:",n),m}catch(a){throw console.error("Erro ao atualizar registro de ponto:",a),s({statusCode:a.statusCode||500,message:a.message||"Erro ao atualizar registro"})}});export{i as default};
