import{d as a,c as o,g as e,r}from"../../../_/nitro.mjs";import{s}from"../../../_/serverSupabaseClient.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"node:crypto";import"@supabase/ssr";import"../../../_/fetch-retry.mjs";const t=a(async a=>{const t=await s(a),{data:{session:i}}=await t.auth.getSession();if(!(null==i?void 0:i.user))throw o({statusCode:401,message:"Não autenticado"});const n=i.user.id,d=e(a,"id"),c=await r(a),{data:m}=await t.from("app_users").select("id, role").eq("auth_uid",n).single();if(!m||"admin"!==m.role)throw o({statusCode:403,message:"Apenas administradores podem editar colaboradores"});const u=["nome","cpf","rg","orgao_emissor","data_emissao","data_nascimento","sexo","estado_civil","escolaridade","matricula","foto_url","cargo_id","departamento_id","unidade","tipo_contrato","jornada_trabalho","salario","data_admissao","data_desligamento","status","regime_pagamento","email_corporativo","email_pessoal","email_alternativo","telefone","celular","contato_emergencia_nome","contato_emergencia_telefone","contato_emergencia_parentesco","cep","endereco","numero","complemento","bairro","cidade","estado","banco_codigo","banco_nome","agencia","conta","tipo_conta","pix","pis_pasep","ctps","serie_ctps","recebe_vt","valor_vt","recebe_va_vr","valor_va_vr","desconto_inss_padrao","observacoes_rh"],_={};for(const a of u)a in c&&(_[a]=c[a]);if(_.cpf&&!/^\d{11}$/.test(_.cpf.replace(/\D/g,"")))throw o({statusCode:400,message:"CPF inválido"});if(_.salario&&_.salario<0)throw o({statusCode:400,message:"Salário não pode ser negativo"});const{data:l,error:p}=await t.from("colaboradores").update(_).eq("id",d).select().single();if(p)throw console.error("Erro ao atualizar colaborador:",p),o({statusCode:500,message:p.message});if(c.criar_usuario&&c.usuario_email&&c.usuario_senha)try{const{data:a,error:o}=await t.auth.admin.createUser({email:c.usuario_email,password:c.usuario_senha,email_confirm:!0});if(o)throw o;const{error:e}=await t.from("app_users").insert({auth_uid:a.user.id,nome:l.nome,email:c.usuario_email,role:c.usuario_role||"funcionario",ativo:!1!==c.usuario_ativo});if(e)throw e;await t.from("colaboradores").update({user_id:a.user.id}).eq("id",d)}catch(a){console.error("Erro ao criar usuário:",a)}return{success:!0,data:l}});export{t as default};
