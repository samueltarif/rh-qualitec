import{d as o,a as t,c as a}from"../../_/nitro.mjs";import{s as e}from"../../_/serverSupabaseClient.mjs";import{s as r}from"../../_/serverSupabaseUser.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"node:crypto";import"@supabase/ssr";import"../../_/fetch-retry.mjs";const s=o(async o=>{const s=await e(o),n=await r(o),d=t(o),i=(null==n?void 0:n.id)||(null==n?void 0:n.sub);if(!n||!i)throw a({statusCode:401,message:"Não autenticado"});if(!/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(i))throw a({statusCode:401,message:"ID de usuário inválido. Faça login novamente."});try{const o=d.mes?parseInt(d.mes):(new Date).getMonth()+1,t=d.ano?parseInt(d.ano):(new Date).getFullYear(),e=d.colaborador_id,r=d.departamento_id,n=d.status,i=`${t}-${String(o).padStart(2,"0")}-01`,m=new Date(t,o,0).getDate(),p=`${t}-${String(o).padStart(2,"0")}-${m}`;let l=s.from("registros_ponto").select("\n        *,\n        colaborador:colaboradores(\n          id, nome, matricula, foto_url,\n          cargo:cargos(id, nome),\n          departamento:departamentos!colaboradores_departamento_id_fkey(id, nome)\n        )\n      ").gte("data",i).lte("data",p).order("data",{ascending:!1});e&&(l=l.eq("colaborador_id",e)),n&&(l=l.eq("status",n));const{data:u,error:c}=await l;if(c)throw console.error("Erro ao buscar registros de ponto:",c),a({statusCode:500,message:`Erro ao buscar registros: ${c.message}`});let g=u||[];return r&&(g=g.filter(o=>{var t,a;return(null==(a=null==(t=o.colaborador)?void 0:t.departamento)?void 0:a.id)===r})),g}catch(o){throw console.error("Erro ao buscar registros de ponto:",o),a({statusCode:o.statusCode||500,message:o.message||"Erro ao buscar registros"})}});export{s as default};
