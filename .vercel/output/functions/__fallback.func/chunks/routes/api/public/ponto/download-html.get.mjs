import{d as t,a,c as n,s as o}from"../../../../_/nitro.mjs";import{s as r}from"../../../../_/serverSupabaseServiceRole.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"node:crypto";import"@supabase/functions-js";import"../../../../virtual/_commonjsHelpers.mjs";import"@supabase/postgrest-js";import"@supabase/realtime-js";import"@supabase/storage-js";import"@supabase/auth-js";import"../../../../_/fetch-retry.mjs";const e=t(async t=>{var e,s;try{const i=r(t),d=a(t),p=d.colaborador_id,l=d.mes?parseInt(d.mes):(new Date).getMonth()+1,m=d.ano?parseInt(d.ano):(new Date).getFullYear();if(console.log("üîç [P√öBLICO HTML] Gerando relat√≥rio para:",{colaboradorId:p,mes:l,ano:m}),!p)throw n({statusCode:400,message:"ID do colaborador √© obrigat√≥rio"});const{data:c}=await i.from("colaboradores").select("id, nome, matricula, cargo:cargos(nome), departamento:departamentos(nome)").eq("id",p).single();if(!c)throw n({statusCode:404,message:"Colaborador n√£o encontrado"});const{data:g}=await i.from("assinaturas_ponto").select("*").eq("colaborador_id",c.id).eq("mes",l).eq("ano",m).maybeSingle();console.log("üìã Gerando relat√≥rio para colaborador:",c.nome);const h=new Date(m,l-1,1),u=new Date(m,l,0),{data:b}=await i.from("registros_ponto").select("*").eq("colaborador_id",c.id).gte("data",h.toISOString().split("T")[0]).lte("data",u.toISOString().split("T")[0]).order("data",{ascending:!0});let f=0,x=0;const v=(null==b?void 0:b.map(t=>{const a=t.entrada_1||"-",n=t.saida_2||t.saida_1||"-";let o="-";if(t.saida_1&&t.entrada_2){const a=new Date(`2000-01-01T${t.saida_1}`),n=new Date(`2000-01-01T${t.entrada_2}`).getTime()-a.getTime(),r=Math.floor(n/6e4),e=r%60;o=`${Math.floor(r/60).toString().padStart(2,"0")}:${e.toString().padStart(2,"0")}`}let r="-";if("-"!==a&&"-"!==n){const t=new Date(`2000-01-01T${a}`);let e=new Date(`2000-01-01T${n}`).getTime()-t.getTime();if("-"!==o){const[t,a]=o.split(":").map(Number);e-=60*(60*t+a)*1e3}const s=Math.floor(e/6e4);x+=s,f++;const i=s%60;r=`${Math.floor(s/60).toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}`}return{data:new Date(t.data).toLocaleDateString("pt-BR"),entrada:a,intervalo:o,saida:n,horas:r}}))||[],$=Math.floor(x/60),S=x%60,w=`${$.toString().padStart(2,"0")}:${S.toString().padStart(2,"0")}`,T=`\n<!DOCTYPE html>\n<html>\n<head>\n    <meta charset="UTF-8">\n    <title>Relat√≥rio de Ponto - ${c.nome}</title>\n    <style>\n        body { font-family: Arial, sans-serif; margin: 20px; }\n        .header { text-align: center; margin-bottom: 30px; }\n        .info { margin-bottom: 20px; }\n        .info p { margin: 5px 0; }\n        table { width: 100%; border-collapse: collapse; margin: 20px 0; }\n        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }\n        th { background-color: #f2f2f2; }\n        .summary { margin-top: 20px; font-weight: bold; }\n        .footer { margin-top: 30px; font-size: 12px; color: #666; }\n        .assinatura-valida { background: #e8f5e8; padding: 15px; border-radius: 5px; margin: 10px 0; }\n        .assinatura-pendente { background: #fff3cd; padding: 15px; border-radius: 5px; margin: 10px 0; }\n        .hash-box { font-family: monospace; font-size: 10px; word-break: break-all; background: #f5f5f5; padding: 5px; border-radius: 3px; }\n        @media print {\n            body { margin: 0; }\n            .no-print { display: none; }\n        }\n    </style>\n</head>\n<body>\n    <div class="header">\n        <h1>RELAT√ìRIO DE PONTO ELETR√îNICO</h1>\n    </div>\n    \n    <div class="info">\n        <p><strong>Funcion√°rio:</strong> ${c.nome}</p>\n        <p><strong>Matr√≠cula:</strong> ${c.matricula}</p>\n        <p><strong>Cargo:</strong> ${(null==(e=c.cargo)?void 0:e.nome)||"N/A"}</p>\n        <p><strong>Departamento:</strong> ${(null==(s=c.departamento)?void 0:s.nome)||"N/A"}</p>\n        <p><strong>Per√≠odo:</strong> ${String(l).padStart(2,"0")}/${m}</p>\n    </div>\n    \n    <table>\n        <thead>\n            <tr>\n                <th>Data</th>\n                <th>Entrada</th>\n                <th>Intervalo</th>\n                <th>Sa√≠da</th>\n                <th>Horas Trabalhadas</th>\n            </tr>\n        </thead>\n        <tbody>\n            ${v.map(t=>`\n                <tr>\n                    <td>${t.data}</td>\n                    <td>${t.entrada}</td>\n                    <td>${t.intervalo}</td>\n                    <td>${t.saida}</td>\n                    <td>${t.horas}</td>\n                </tr>\n            `).join("")}\n        </tbody>\n    </table>\n    \n    <div class="summary">\n        <p>Total de dias trabalhados: ${f}</p>\n        <p>Total de horas trabalhadas: ${w}</p>\n    </div>\n    \n    <div style="margin-top: 30px; border-top: 2px solid #333; padding-top: 20px;">\n        <h3>ASSINATURA DIGITAL</h3>\n        ${g?`\n            <div class="assinatura-valida">\n                <p><strong>‚úÖ Documento assinado digitalmente</strong></p>\n                <p><strong>Data da Assinatura:</strong> ${new Date(g.data_assinatura).toLocaleString("pt-BR")}</p>\n                <p><strong>Per√≠odo:</strong> ${String(g.mes).padStart(2,"0")}/${g.ano}</p>\n                <p><strong>IP:</strong> ${g.ip_assinatura||"N/A"}</p>\n                ${g.hash_assinatura?`\n                    <p><strong>Hash de Verifica√ß√£o:</strong></p>\n                    <div class="hash-box">\n                        ${g.hash_assinatura}\n                    </div>\n                `:""}\n                <p style="font-style: italic; margin-top: 10px;">\n                    Este documento possui validade jur√≠dica conforme MP 2.200-2/2001.\n                </p>\n            </div>\n        `:'\n            <div class="assinatura-pendente">\n                <p><strong>‚ö†Ô∏è Este documento ainda n√£o foi assinado digitalmente.</strong></p>\n                <p>Para assinar, acesse o sistema e confirme seus registros de ponto.</p>\n            </div>\n        '}\n    </div>\n    \n    <div class="footer">\n        <p>Relat√≥rio gerado em: ${(new Date).toLocaleString("pt-BR")}</p>\n        <p>Sistema de Ponto Eletr√¥nico - Qualitec</p>\n        <p>üîì Acesso p√∫blico autorizado</p>\n    </div>\n    \n    <div class="no-print" style="margin-top: 30px; text-align: center;">\n        <button onclick="window.print()" style="padding: 10px 20px; font-size: 16px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">\n            Imprimir / Salvar como PDF\n        </button>\n    </div>\n</body>\n</html>\n    `;return o(t,{"Content-Type":"text/html; charset=utf-8","Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET","Access-Control-Allow-Headers":"Content-Type"}),T}catch(t){throw console.error("Erro ao gerar relat√≥rio HTML p√∫blico:",t),n({statusCode:500,message:"Erro ao gerar relat√≥rio HTML: "+t.message})}});export{e as default};
