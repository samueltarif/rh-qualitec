import{d as a,a as t,c as o}from"../../../../_/nitro.mjs";import{s as e}from"../../../../_/serverSupabaseServiceRole.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"node:crypto";import"@supabase/functions-js";import"../../../../virtual/_commonjsHelpers.mjs";import"@supabase/postgrest-js";import"@supabase/realtime-js";import"@supabase/storage-js";import"@supabase/auth-js";import"../../../../_/fetch-retry.mjs";const r=a(async a=>{var r,s;try{const n=e(a),i=t(a),d=i.colaborador_id,m=i.mes?parseInt(i.mes):(new Date).getMonth()+1,p=i.ano?parseInt(i.ano):(new Date).getFullYear();if(console.log("ðŸ” [PÃšBLICO] Buscando dados para:",{colaboradorId:d,mes:m,ano:p}),!d)throw o({statusCode:400,message:"ID do colaborador Ã© obrigatÃ³rio"});const{data:l}=await n.from("colaboradores").select("id, nome, matricula, cargo:cargos(nome), departamento:departamentos(nome)").eq("id",d).single();if(!l)throw o({statusCode:404,message:"Colaborador nÃ£o encontrado"});const c=new Date(p,m-1,1),g=new Date(p,m,0),{data:u}=await n.from("registros_ponto").select("*").eq("colaborador_id",l.id).gte("data",c.toISOString().split("T")[0]).lte("data",g.toISOString().split("T")[0]).order("data",{ascending:!0}),{data:S}=await n.from("assinaturas_ponto").select("*").eq("colaborador_id",l.id).eq("mes",m).eq("ano",p).maybeSingle();let f=0,b=0;const h=(null==u?void 0:u.map(a=>{const t=a.entrada_1||"-",o=a.saida_2||a.saida_1||"-";let e="-";if(a.saida_1&&a.entrada_2){const t=new Date(`2000-01-01T${a.saida_1}`),o=new Date(`2000-01-01T${a.entrada_2}`).getTime()-t.getTime(),r=Math.floor(o/6e4),s=r%60;e=`${Math.floor(r/60).toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`}let r="-";if("-"!==t&&"-"!==o){const a=new Date(`2000-01-01T${t}`);let s=new Date(`2000-01-01T${o}`).getTime()-a.getTime();if("-"!==e){const[a,t]=e.split(":").map(Number);s-=60*(60*a+t)*1e3}const n=Math.floor(s/6e4);b+=n,f++;const i=n%60;r=`${Math.floor(n/60).toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}`}return{data:new Date(a.data).toLocaleDateString("pt-BR"),entrada:t,intervalo:e,saida:o,horas:r}}))||[],_=Math.floor(b/60),w=b%60,D=`${_.toString().padStart(2,"0")}:${w.toString().padStart(2,"0")}`;return{colaborador:{nome:l.nome,matricula:l.matricula,cargo:(null==(r=l.cargo)?void 0:r.nome)||"N/A",departamento:(null==(s=l.departamento)?void 0:s.nome)||"N/A"},periodo:{mes:m,ano:p,mesAno:`${String(m).padStart(2,"0")}/${p}`},registros:h,resumo:{totalDias:f,totalHoras:D,totalMinutos:b},assinatura:S?{dataAssinatura:S.data_assinatura,ip:S.ip_assinatura,hash:S.hash_assinatura,assinado:!0}:{assinado:!1},geradoEm:(new Date).toLocaleString("pt-BR")}}catch(a){throw console.error("Erro ao buscar dados do ponto:",a),o({statusCode:500,message:"Erro ao buscar dados: "+a.message})}});export{r as default};
