import{d as e,c as o,r as t}from"../../../_/nitro.mjs";import{s as a}from"../../../_/serverSupabaseClient.mjs";import{s as r}from"../../../_/serverSupabaseUser.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"node:crypto";import"@supabase/ssr";import"../../../_/fetch-retry.mjs";const s=e(async e=>{const s=await a(e),i=await r(e);if(!i)throw o({statusCode:401,message:"Não autenticado"});try{const a=await t(e),{template_id:r,filtros:m,formato:d}=a,{data:n,error:c}=await s.from("relatorios_templates").select("*").eq("id",r).single();if(c||!n)throw o({statusCode:404,message:"Template não encontrado"});const{data:p}=await s.from("app_users").select("id").eq("auth_uid",i.id).single(),{data:l,error:u}=await s.from("relatorios_execucoes").insert({template_id:r,tipo_execucao:"manual",status:"processando",filtros_aplicados:m||{},formato_gerado:d||n.formato_padrao,executado_por:null==p?void 0:p.id}).select().single();if(u)throw u;return await s.from("relatorios_execucoes").update({status:"concluido",concluido_em:(new Date).toISOString(),total_registros:0,arquivo_nome:`${n.nome.replace(/\s+/g,"_")}_${Date.now()}.pdf`}).eq("id",l.id),{success:!0,message:"Relatório gerado com sucesso",data:{execucao_id:l.id,template_nome:n.nome}}}catch(e){throw console.error("Erro ao gerar relatório:",e),o({statusCode:e.statusCode||500,message:e.message||"Erro ao gerar relatório"})}});export{s as default};
