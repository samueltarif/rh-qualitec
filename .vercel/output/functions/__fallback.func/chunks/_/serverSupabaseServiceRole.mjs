import*as e from"@supabase/functions-js";import{g as t}from"../virtual/_commonjsHelpers.mjs";import*as s from"@supabase/postgrest-js";import*as r from"@supabase/realtime-js";import*as n from"@supabase/storage-js";import*as a from"@supabase/auth-js";import{f as o}from"./fetch-retry.mjs";import{u as i}from"./nitro.mjs";var u={},c={};const l=t(e),h=t(s),d=t(r),p=t(n);var b={},f={};Object.defineProperty(f,"__esModule",{value:!0}),f.version=void 0,f.version="2.86.0",function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.DEFAULT_REALTIME_OPTIONS=e.DEFAULT_AUTH_OPTIONS=e.DEFAULT_DB_OPTIONS=e.DEFAULT_GLOBAL_OPTIONS=e.DEFAULT_HEADERS=void 0;const t=f;let s="";s="undefined"!=typeof Deno?"deno":"undefined"!=typeof document?"web":"undefined"!=typeof navigator&&"ReactNative"===navigator.product?"react-native":"node",e.DEFAULT_HEADERS={"X-Client-Info":`supabase-js-${s}/${t.version}`},e.DEFAULT_GLOBAL_OPTIONS={headers:e.DEFAULT_HEADERS},e.DEFAULT_DB_OPTIONS={schema:"public"},e.DEFAULT_AUTH_OPTIONS={autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,flowType:"implicit"},e.DEFAULT_REALTIME_OPTIONS={}}(b);var g={};!function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.fetchWithAuth=e.resolveHeadersConstructor=e.resolveFetch=void 0;e.resolveFetch=e=>e?(...t)=>e(...t):(...e)=>fetch(...e);e.resolveHeadersConstructor=()=>Headers;e.fetchWithAuth=(t,s,r)=>{const n=(0,e.resolveFetch)(r),a=(0,e.resolveHeadersConstructor)();return async(e,r)=>{var o;const i=null!==(o=await s())&&void 0!==o?o:t;let u=new a(null==r?void 0:r.headers);return u.has("apikey")||u.set("apikey",t),u.has("Authorization")||u.set("Authorization",`Bearer ${i}`),n(e,Object.assign(Object.assign({},r),{headers:u}))}}}(g);var v={};function ensureTrailingSlash(e){return e.endsWith("/")?e:e+"/"}Object.defineProperty(v,"__esModule",{value:!0}),v.isBrowser=void 0,v.uuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})},v.ensureTrailingSlash=ensureTrailingSlash,v.applySettingDefaults=function(e,t){var s,r;const{db:n,auth:a,realtime:o,global:i}=e,{db:u,auth:c,realtime:l,global:h}=t,d={db:Object.assign(Object.assign({},u),n),auth:Object.assign(Object.assign({},c),a),realtime:Object.assign(Object.assign({},l),o),storage:{},global:Object.assign(Object.assign(Object.assign({},h),i),{headers:Object.assign(Object.assign({},null!==(s=null==h?void 0:h.headers)&&void 0!==s?s:{}),null!==(r=null==i?void 0:i.headers)&&void 0!==r?r:{})}),accessToken:async()=>""};e.accessToken?d.accessToken=e.accessToken:delete d.accessToken;return d},v.validateSupabaseUrl=function(e){const t=null==e?void 0:e.trim();if(!t)throw new Error("supabaseUrl is required.");if(!t.match(/^https?:\/\//i))throw new Error("Invalid supabaseUrl: Must be a valid HTTP or HTTPS URL.");try{return new URL(ensureTrailingSlash(t))}catch(e){throw Error("Invalid supabaseUrl: Provided URL is malformed.")}};v.isBrowser=()=>!1;var m={};const T=t(a);Object.defineProperty(m,"__esModule",{value:!0}),m.SupabaseAuthClient=void 0;const O=T;class SupabaseAuthClient extends O.AuthClient{constructor(e){super(e)}}m.SupabaseAuthClient=SupabaseAuthClient,Object.defineProperty(c,"__esModule",{value:!0});const _=l,E=h,S=d,A=p,y=b,j=g,U=v,w=m;c.default=class{constructor(e,t,s){var r,n,a;this.supabaseUrl=e,this.supabaseKey=t;const o=(0,U.validateSupabaseUrl)(e);if(!t)throw new Error("supabaseKey is required.");this.realtimeUrl=new URL("realtime/v1",o),this.realtimeUrl.protocol=this.realtimeUrl.protocol.replace("http","ws"),this.authUrl=new URL("auth/v1",o),this.storageUrl=new URL("storage/v1",o),this.functionsUrl=new URL("functions/v1",o);const i=`sb-${o.hostname.split(".")[0]}-auth-token`,u={db:y.DEFAULT_DB_OPTIONS,realtime:y.DEFAULT_REALTIME_OPTIONS,auth:Object.assign(Object.assign({},y.DEFAULT_AUTH_OPTIONS),{storageKey:i}),global:y.DEFAULT_GLOBAL_OPTIONS},c=(0,U.applySettingDefaults)(null!=s?s:{},u);this.storageKey=null!==(r=c.auth.storageKey)&&void 0!==r?r:"",this.headers=null!==(n=c.global.headers)&&void 0!==n?n:{},c.accessToken?(this.accessToken=c.accessToken,this.auth=new Proxy({},{get:(e,t)=>{throw new Error(`@supabase/supabase-js: Supabase Client is configured with the accessToken option, accessing supabase.auth.${String(t)} is not possible`)}})):this.auth=this._initSupabaseAuthClient(null!==(a=c.auth)&&void 0!==a?a:{},this.headers,c.global.fetch),this.fetch=(0,j.fetchWithAuth)(t,this._getAccessToken.bind(this),c.global.fetch),this.realtime=this._initRealtimeClient(Object.assign({headers:this.headers,accessToken:this._getAccessToken.bind(this)},c.realtime)),this.accessToken&&this.accessToken().then(e=>this.realtime.setAuth(e)).catch(e=>console.warn("Failed to set initial Realtime auth token:",e)),this.rest=new E.PostgrestClient(new URL("rest/v1",o).href,{headers:this.headers,schema:c.db.schema,fetch:this.fetch}),this.storage=new A.StorageClient(this.storageUrl.href,this.headers,this.fetch,null==s?void 0:s.storage),c.accessToken||this._listenForAuthEvents()}get functions(){return new _.FunctionsClient(this.functionsUrl.href,{headers:this.headers,customFetch:this.fetch})}from(e){return this.rest.from(e)}schema(e){return this.rest.schema(e)}rpc(e,t={},s={head:!1,get:!1,count:void 0}){return this.rest.rpc(e,t,s)}channel(e,t={config:{}}){return this.realtime.channel(e,t)}getChannels(){return this.realtime.getChannels()}removeChannel(e){return this.realtime.removeChannel(e)}removeAllChannels(){return this.realtime.removeAllChannels()}async _getAccessToken(){var e,t;if(this.accessToken)return await this.accessToken();const{data:s}=await this.auth.getSession();return null!==(t=null===(e=s.session)||void 0===e?void 0:e.access_token)&&void 0!==t?t:this.supabaseKey}_initSupabaseAuthClient({autoRefreshToken:e,persistSession:t,detectSessionInUrl:s,storage:r,userStorage:n,storageKey:a,flowType:o,lock:i,debug:u,throwOnError:c},l,h){const d={Authorization:`Bearer ${this.supabaseKey}`,apikey:`${this.supabaseKey}`};return new w.SupabaseAuthClient({url:this.authUrl.href,headers:Object.assign(Object.assign({},d),l),storageKey:a,autoRefreshToken:e,persistSession:t,detectSessionInUrl:s,storage:r,userStorage:n,flowType:o,lock:i,debug:u,throwOnError:c,fetch:h,hasCustomAuthorizationHeader:Object.keys(this.headers).some(e=>"authorization"===e.toLowerCase())})}_initRealtimeClient(e){return new S.RealtimeClient(this.realtimeUrl.href,Object.assign(Object.assign({},e),{params:Object.assign({apikey:this.supabaseKey},null==e?void 0:e.params)}))}_listenForAuthEvents(){return this.auth.onAuthStateChange((e,t)=>{this._handleTokenChanged(e,"CLIENT",null==t?void 0:t.access_token)})}_handleTokenChanged(e,t,s){"TOKEN_REFRESHED"!==e&&"SIGNED_IN"!==e||this.changedAccessToken===s?"SIGNED_OUT"===e&&(this.realtime.setAuth(),"STORAGE"==t&&this.auth.signOut(),this.changedAccessToken=void 0):(this.changedAccessToken=s,this.realtime.setAuth(s))}},function(e){var t=u&&u.__createBinding||(Object.create?function(e,t,s,r){void 0===r&&(r=s);var n=Object.getOwnPropertyDescriptor(t,s);n&&!("get"in n?!t.__esModule:n.writable||n.configurable)||(n={enumerable:!0,get:function(){return t[s]}}),Object.defineProperty(e,r,n)}:function(e,t,s,r){void 0===r&&(r=s),e[r]=t[s]}),s=u&&u.__exportStar||function(e,s){for(var r in e)"default"===r||Object.prototype.hasOwnProperty.call(s,r)||t(s,e,r)},r=u&&u.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(e,"__esModule",{value:!0}),e.createClient=e.SupabaseClient=e.FunctionRegion=e.FunctionsError=e.FunctionsRelayError=e.FunctionsFetchError=e.FunctionsHttpError=e.PostgrestError=void 0;const n=r(c);s(T,e);var a=h;Object.defineProperty(e,"PostgrestError",{enumerable:!0,get:function(){return a.PostgrestError}});var o=l;Object.defineProperty(e,"FunctionsHttpError",{enumerable:!0,get:function(){return o.FunctionsHttpError}}),Object.defineProperty(e,"FunctionsFetchError",{enumerable:!0,get:function(){return o.FunctionsFetchError}}),Object.defineProperty(e,"FunctionsRelayError",{enumerable:!0,get:function(){return o.FunctionsRelayError}}),Object.defineProperty(e,"FunctionsError",{enumerable:!0,get:function(){return o.FunctionsError}}),Object.defineProperty(e,"FunctionRegion",{enumerable:!0,get:function(){return o.FunctionRegion}}),s(d,e);var i=c;Object.defineProperty(e,"SupabaseClient",{enumerable:!0,get:function(){return r(i).default}});e.createClient=(e,t,s)=>new n.default(e,t,s),function(){if("undefined"==typeof process)return!1;const e=process.version;if(null==e)return!1;const t=e.match(/^v(\d+)\./);return!!t&&parseInt(t[1],10)<=18}()&&console.warn("⚠️  Node.js 18 and below are deprecated and will no longer be supported in future versions of @supabase/supabase-js. Please upgrade to Node.js 20 or later. For more information, visit: https://github.com/orgs/supabase/discussions/37217")}(u);const serverSupabaseServiceRole=e=>{const t=i(e),s=t.supabase.secretKey,r=t.supabase.serviceKey,n=t.public.supabase.url,a=s||r;if(!a)throw new Error("Missing server key. Set either `SUPABASE_SECRET_KEY` (recommended) or `SUPABASE_SERVICE_KEY` (deprecated) in your environment variables.");return e.context._supabaseServiceRole||(e.context._supabaseServiceRole=u.createClient(n,a,{auth:{detectSessionInUrl:!1,persistSession:!1,autoRefreshToken:!1},global:{fetch:o}})),e.context._supabaseServiceRole};export{serverSupabaseServiceRole as s};
