import{u as e}from"./nitro.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"node:fs";import"node:path";import"node:crypto";var r=Object.defineProperty,__publicField=(e,t,o)=>((e,t,o)=>t in e?r(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o)(e,"symbol"!=typeof t?t+"":t,o);let t=null;class EmailService{constructor(){__publicField(this,"transporter",null),__publicField(this,"config",null)}async initialize(e){this.config=e;try{const r=await async function(){if(!t)try{return t=await import("nodemailer"),t.default||t}catch(e){throw console.error("❌ Erro ao importar nodemailer:",e),new Error("Nodemailer não disponível neste ambiente")}return t}();this.transporter=r.createTransport({host:e.servidor_smtp,port:e.porta,secure:e.usa_ssl,auth:{user:e.usuario_smtp,pass:e.senha_smtp},tls:{rejectUnauthorized:!1}})}catch(e){return console.error("❌ Erro ao inicializar transporter:",e),!1}try{return await this.transporter.verify(),console.log("✅ Conexão SMTP verificada com sucesso"),!0}catch(e){return console.error("❌ Erro ao verificar conexão SMTP:",e),!1}}async enviar(e){var r,t;if(!this.transporter||!this.config)return console.error("❌ EmailService não inicializado"),!1;try{const o={from:`${this.config.nome_remetente} <${this.config.email_remetente}>`,to:e.destinatario,subject:e.assunto,html:e.corpo_html,text:e.corpo_texto||e.assunto,cc:null==(r=e.cc)?void 0:r.join(","),bcc:null==(t=e.bcc)?void 0:t.join(",")},i=await this.transporter.sendMail(o);return console.log("✅ E-mail enviado:",i.messageId),!0}catch(e){return console.error("❌ Erro ao enviar e-mail:",e),!1}}async enviarLote(e){let r=0;for(const t of e){await this.enviar(t)&&r++,await new Promise(e=>setTimeout(e,1e3))}return r}static processarTemplate(e,r){let t=e;for(const[e,o]of Object.entries(r)){const r=new RegExp(`{{${e}}}`,"g");t=t.replace(r,String(o||""))}return t}}let o=null;async function getEmailService(){return o||(o=new EmailService),o}async function initializeEmailService(){try{const r=e(),t=r.public.supabaseUrl,o=r.supabaseServiceKey;if(!o)return console.warn("⚠️ Service key não configurada"),!1;const i={Authorization:`Bearer ${o}`,apikey:o},n=await $fetch(`${t}/rest/v1/empresa?select=id&limit=1`,{headers:i});if(!n||0===n.length)return console.warn("⚠️ Nenhuma empresa encontrada"),!1;let a=null;try{const e=await $fetch(`${t}/rest/v1/configuracoes_smtp?empresa_id=eq.${n[0].id}&select=*`,{headers:i});e&&e.length>0&&e[0].ativo&&(a=e[0])}catch(e){console.warn("⚠️ Erro ao buscar SMTP do banco, tentando .env")}if(!a){const e=r.gmailEmail,t=r.gmailAppPassword;if(!e||!t)return console.warn("⚠️ SMTP não configurado no banco nem no .env"),!1;a={servidor_smtp:"smtp.gmail.com",porta:587,usuario_smtp:e,senha_smtp:t,email_remetente:e,nome_remetente:"RH Qualitec",usa_ssl:!1,usa_tls:!0},console.log("✅ Usando configurações de Gmail do .env")}const s=await getEmailService();return await s.initialize(a)}catch(e){return console.error("❌ Erro ao inicializar serviço de e-mail:",e),!1}}export{EmailService,getEmailService,initializeEmailService};
