import{b as e}from"./server.mjs";import{ref as a,computed as r}from"vue";const useCargos=()=>{const t=e(),s=a([]),o=a(!1),c=a(null),fetchCargos=async()=>{o.value=!0,c.value=null;try{const{data:e,error:a}=await t.from("cargos").select("\n          *,\n          gestores:cargo_gestores(\n            id,\n            cargo_id,\n            colaborador_id,\n            created_at,\n            colaborador:colaboradores(\n              id,\n              nome,\n              email_corporativo\n            )\n          )\n        ").order("nome",{ascending:!0});if(a)throw a;return s.value=e,{success:!0,data:e}}catch(e){return c.value=e.message,{success:!1,error:e.message}}finally{o.value=!1}},updateCargo=async(e,a)=>{o.value=!0,c.value=null;try{const r={...a,updated_at:(new Date).toISOString()},{data:s,error:o}=await t.from("cargos").update(r).eq("id",e).select().single();if(o)throw o;return await fetchCargos(),{success:!0,data:s}}catch(e){return c.value=e.message,{success:!1,error:e.message}}finally{o.value=!1}},toggleCargoStatus=async(e,a)=>await updateCargo(e,{ativo:a}),l=r(()=>({operacional:s.value.filter(e=>"operacional"===e.nivel).length,gestao:s.value.filter(e=>"gestao"===e.nivel).length,total:s.value.length})),n=r(()=>({ativo:s.value.filter(e=>e.ativo).length,inativo:s.value.filter(e=>!e.ativo).length}));return{cargos:s,loading:o,error:c,countByNivel:l,countByStatus:n,fetchCargos:fetchCargos,fetchCargoById:async e=>{o.value=!0,c.value=null;try{const{data:a,error:r}=await t.from("cargos").select("*").eq("id",e).single();if(r)throw r;return{success:!0,data:a}}catch(e){return c.value=e.message,{success:!1,error:e.message}}finally{o.value=!1}},createCargo:async e=>{o.value=!0,c.value=null;try{let a=e.empresa_id;a||(a=await(async()=>{try{const{data:e}=await t.from("empresas").select("id").limit(1).single();return e?.id||null}catch{return null}})()||void 0);const r={nome:e.nome,nivel:e.nivel,descricao:e.descricao||null,ativo:!0};a&&(r.empresa_id=a);const{data:s,error:o}=await t.from("cargos").insert(r).select().single();if(o)throw o;return await fetchCargos(),{success:!0,data:s}}catch(e){return c.value=e.message,{success:!1,error:e.message}}finally{o.value=!1}},updateCargo:updateCargo,toggleCargoStatus:toggleCargoStatus,deleteCargo:async e=>await toggleCargoStatus(e,!1),filterCargos:e=>{let a=[...s.value];if(e.search){const r=e.search.toLowerCase();a=a.filter(e=>e.nome.toLowerCase().includes(r)||e.descricao&&e.descricao.toLowerCase().includes(r))}if(e.nivel&&"all"!==e.nivel&&(a=a.filter(a=>a.nivel===e.nivel)),e.status&&"all"!==e.status){const r="ativo"===e.status;a=a.filter(e=>e.ativo===r)}return a},addGestor:async(e,a)=>{o.value=!0,c.value=null;try{const{data:r,error:s}=await t.from("cargo_gestores").insert({cargo_id:e,colaborador_id:a}).select().single();if(s)throw s;return await fetchCargos(),{success:!0,data:r}}catch(e){return c.value=e.message,{success:!1,error:e.message}}finally{o.value=!1}},removeGestor:async e=>{o.value=!0,c.value=null;try{const{error:a}=await t.from("cargo_gestores").delete().eq("id",e);if(a)throw a;return await fetchCargos(),{success:!0}}catch(e){return c.value=e.message,{success:!1,error:e.message}}finally{o.value=!1}},fetchColaboradoresDisponiveis:async e=>{try{const{data:a,error:r}=await t.from("colaboradores").select("id, nome, email_corporativo, cargo_id").eq("status","Ativo").order("nome",{ascending:!0});if(r)throw r;const o=s.value.find(a=>a.id===e),c=o?.gestores?.map(e=>e.colaborador_id)||[];return{success:!0,data:a.filter(e=>!c.includes(e.id))}}catch(e){return{success:!1,error:e.message}}},fetchDepartamentos:async()=>{try{const{data:e,error:a}=await t.from("departamentos").select("id, nome").eq("ativo",!0).order("nome",{ascending:!0});if(a)throw a;return{success:!0,data:e}}catch(e){return{success:!1,error:e.message}}}}};export{useCargos as u};
